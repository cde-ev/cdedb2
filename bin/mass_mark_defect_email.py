#!/usr/bin/env python3
"""Mark a large amount of email addresses as defect."""

import datetime

import cdedb.database.constants as const
from cdedb.backend.common import Silencer
from cdedb.script import Script

# setup

script = Script(persona_id=1, dbuser="cdb_admin", dry_run=False)
rs = script.rs()
core = script.make_backend("core", proxy=False)
cutoff = datetime.timedelta(days=90)
notes = "Massenimport defekter Emailadressen."  # explicate
email_addresses: list[str] = [
    "testaddress188@example.cde",
    "testaddress187@example.cde",
    "testaddress186@example.cde",
    "testaddress185@example.cde",
    "testaddress184@example.cde",
    "testaddress183@example.cde",
    "testaddress182@example.cde",
    "testaddress181@example.cde",
    "testaddress180@example.cde",
    "testaddress179@example.cde",
    "testaddress178@example.cde",
    "testaddress177@example.cde",
    "testaddress176@example.cde",
    "testaddress175@example.cde",
    "testaddress174@example.cde",
    "testaddress173@example.cde",
    "testaddress172@example.cde",
    "testaddress171@example.cde",
    "testaddress170@example.cde",
    "testaddress169@example.cde",
    "testaddress168@example.cde",
    "testaddress167@example.cde",
    "testaddress166@example.cde",
    "testaddress165@example.cde",
    "testaddress164@example.cde",
    "testaddress163@example.cde",
    "testaddress162@example.cde",
    "testaddress161@example.cde",
    "testaddress160@example.cde",
    "testaddress159@example.cde",
    "testaddress158@example.cde",
    "testaddress157@example.cde",
    "testaddress156@example.cde",
    "testaddress155@example.cde",
    "testaddress154@example.cde",
    "testaddress153@example.cde",
    "testaddress152@example.cde",
    "testaddress151@example.cde",
    "testaddress150@example.cde",
    "testaddress149@example.cde",
    "testaddress148@example.cde",
    "testaddress147@example.cde",
    "testaddress146@example.cde",
    "testaddress145@example.cde",
    "testaddress144@example.cde",
    "testaddress143@example.cde",
    "testaddress142@example.cde",
    "testaddress141@example.cde",
    "testaddress140@example.cde",
    "testaddress139@example.cde",
    "testaddress138@example.cde",
    "testaddress137@example.cde",
    "testaddress136@example.cde",
    "testaddress135@example.cde",
    "testaddress134@example.cde",
    "testaddress133@example.cde",
    "testaddress132@example.cde",
    "testaddress131@example.cde",
    "testaddress130@example.cde",
    "testaddress129@example.cde",
    "testaddress128@example.cde",
    "testaddress127@example.cde",
    "testaddress126@example.cde",
    "testaddress125@example.cde",
    "testaddress124@example.cde",
    "testaddress123@example.cde",
    "testaddress122@example.cde",
    "testaddress121@example.cde",
    "testaddress120@example.cde",
    "testaddress119@example.cde",
    "testaddress118@example.cde",
    "testaddress117@example.cde",
    "testaddress116@example.cde",
    "testaddress115@example.cde",
    "testaddress114@example.cde",
    "testaddress113@example.cde",
    "testaddress112@example.cde",
    "testaddress111@example.cde",
    "testaddress110@example.cde",
    "testaddress109@example.cde",
    "testaddress108@example.cde",
    "testaddress107@example.cde",
    "testaddress106@example.cde",
    "testaddress105@example.cde",
    "testaddress104@example.cde",
    "testaddress103@example.cde",
    "testaddress102@example.cde",
    "testaddress101@example.cde",
    "testaddress100@example.cde",
    "testaddress99@example.cde",
    "testaddress98@example.cde",
    "testaddress97@example.cde",
    "testaddress96@example.cde",
    "testaddress95@example.cde",
    "testaddress94@example.cde",
    "testaddress93@example.cde",
    "testaddress92@example.cde",
    "testaddress91@example.cde",
    "testaddress90@example.cde",
    "testaddress89@example.cde",
    "testaddress88@example.cde",
    "testaddress87@example.cde",
    "testaddress86@example.cde",
    "testaddress85@example.cde",
    "testaddress84@example.cde",
    "testaddress83@example.cde",
    "testaddress82@example.cde",
    "testaddress81@example.cde",
    "testaddress80@example.cde",
    "testaddress79@example.cde",
    "testaddress78@example.cde",
    "testaddress77@example.cde",
    "testaddress76@example.cde",
    "testaddress75@example.cde",
    "testaddress74@example.cde",
    "testaddress73@example.cde",
    "testaddress72@example.cde",
    "testaddress71@example.cde",
    "testaddress70@example.cde",
    "testaddress69@example.cde",
    "testaddress68@example.cde",
    "testaddress67@example.cde",
    "testaddress66@example.cde",
    "testaddress65@example.cde",
    "testaddress64@example.cde",
    "testaddress63@example.cde",
    "testaddress62@example.cde",
    "testaddress61@example.cde",
    "testaddress60@example.cde",
    "testaddress59@example.cde",
    "testaddress58@example.cde",
    "testaddress57@example.cde",
    "testaddress56@example.cde",
    "testaddress55@example.cde",
    "testaddress54@example.cde",
    "testaddress53@example.cde",
    "testaddress52@example.cde",
    "testaddress51@example.cde",
    "testaddress50@example.cde",
    "testaddress49@example.cde",
    "testaddress48@example.cde",
    "testaddress47@example.cde",
    "testaddress46@example.cde",
    "testaddress45@example.cde",
    "testaddress44@example.cde",
    "testaddress43@example.cde",
    "testaddress42@example.cde",
    "testaddress41@example.cde",
    "testaddress40@example.cde",
    "testaddress39@example.cde",
    "testaddress38@example.cde",
    "testaddress37@example.cde",
    "testaddress36@example.cde",
    "testaddress35@example.cde",
    "testaddress34@example.cde",
    "testaddress33@example.cde",
    "testaddress32@example.cde",
    "testaddress31@example.cde",
    "testaddress30@example.cde",
    "testaddress29@example.cde",
    "testaddress28@example.cde",
    "testaddress27@example.cde",
    "testaddress26@example.cde",
    "testaddress25@example.cde",
    "testaddress24@example.cde",
    "testaddress23@example.cde",
    "testaddress22@example.cde",
    "testaddress21@example.cde",
    "testaddress20@example.cde",
    "testaddress19@example.cde",
    "testaddress18@example.cde",
    "testaddress17@example.cde",
    "testaddress16@example.cde",
    "testaddress15@example.cde",
    "testaddress14@example.cde",
    "testaddress13@example.cde",
    "testaddress12@example.cde",
    "testaddress11@example.cde",
    "testaddress10@example.cde",
    "testaddress9@example.cde",
    "testaddress8@example.cde",
    "testaddress7@example.cde",
    "testaddress6@example.cde",
    "testaddress5@example.cde",
    "testaddress4@example.cde",
    "testaddress3@example.cde",
    "testaddress2@example.cde",
    "testaddress1@example.cde",
    "testaddress0@example.cde",
    "akira@example.cde",
    "viktor@example.cde",
    "petra@example.cde",
    "ludwig@example.cde",
    "katarina@example.cde",
    "farin@example.cde",
    "annika@example.cde",
    "werner@example.cde",
    "vera@example.cde",
    "rowena@example.cde",
    "quintus@example.cde",
    "paulchen@axample.cde",
    "olaf@example.cde",
    "nina@example.cde",
    "martin@example.cde",
    "kalif@example.cde",
    "janis@example.cde",
    "inga@example.cde",
    "garcia@example.cde",
    "ferdinand@example.cde",
    "emilia@example.cde",
    "daniel@example.cde",
    "charly@example.cde",
    "berta@example.cde",
    "anton@example.cde",
    # fill in
]

# work

now = datetime.datetime.now(datetime.timezone.utc)
with script:
    query = (
        "SELECT p.id, p.username, p.given_names, p.family_name, MAX(s.atime) AS atime"
        " FROM core.personas AS p LEFT OUTER JOIN core.sessions AS s"
        " ON s.persona_id = p.id WHERE username = ANY(%s) GROUP BY (p.id)")
    params = (email_addresses,)
    data = core.query_all(rs, query, params)
    lookup = {entry['username']: entry for entry in data}
    for address in email_addresses:
        do_mark = True
        if address in lookup:
            diff = cutoff
            if lookup[address]['atime'] is not None:
                diff = now - lookup[address]['atime']
            if diff >= cutoff:
                print(f'Inactive account for `{address}` -- proceeding.')
            else:
                print(f'Active account for `{address}` -- skipping.')
        else:
            print(f'No account for `{address}` -- proceeding.')
        if do_mark:
            code = core.mark_email_status(rs, address, const.EmailStatus.defect,
                                          notes)
            if code:
                print(f'Marked as defect: `{address}`.')
            else:
                print(f'Failure for: `{address}`.')

