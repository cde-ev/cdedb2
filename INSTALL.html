<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting Started &mdash; CdEDB 2.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="CdEDB 2.0 documentation" href="index.html" />
    <link rel="up" title="Introduction" href="Introduction.html" />
    <link rel="next" title="Readme" href="Introduction_Readme.html" />
    <link rel="prev" title="Introduction" href="Introduction.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Introduction_Readme.html" title="Readme"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Introduction.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">CdEDB 2.0 documentation</a> &raquo;</li>
          <li><a href="Introduction.html" accesskey="U">Introduction</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="getting-started">
<h1>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<p>This describes the steps necessary to get the project running on a
machine. This is somewhat complicated and it is advised to use the virtual
machine in most cases. Instructions for obtianing and using the image can be
found at <a class="reference internal" href="Introduction_VM.html"><em>Using the VM image</em></a>. Below may be some Gentoo-specific bits, for
Debian-specific stuff look at the setup scripts in <tt class="docutils literal"><span class="pre">related/auto-build</span></tt>.</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>We need some dependencies:</p>
<ul class="simple">
<li>python (at least 3.4, for subtests)</li>
<li>PostgreSQL (at least 9.4, for jsonb)</li>
<li>Apache (with mod_wsgi)</li>
<li>git</li>
<li>openldap</li>
</ul>
<p>Further we depend on a number of python packages:</p>
<ul class="simple">
<li>passlib</li>
<li>psycopg2 (at least 2.5.4, for jsonb support)</li>
<li>pyro4 (which depends on serpent)</li>
<li>werkzeug (at least 0.9.7, bug in py3-handling of MultiDict input)</li>
<li>dateutil</li>
<li>jinja2</li>
<li>pytz</li>
<li>python-ldap (support for py3 is currently unreleased)</li>
<li>python-magic</li>
<li>python-imaging-library (more specifically pillow)</li>
</ul>
<p>At last there are some recommended dependencies:</p>
<ul class="simple">
<li>sphinx (for building the documentation)</li>
<li>webtest (for tests, at least 2.0.17 for handling of multiple elements with the same name)</li>
<li>pgbouncer (otherwise database performance may be degraded)</li>
<li>fail2ban (for preventing brute-force attacks)</li>
</ul>
<p>Here are some oneliners for the lazy:</p>
<div class="highlight-python"><div class="highlight"><pre># Gentoo
emerge -avt &gt;=dev-lang/python-3.4.0 &gt;=dev-db/postgresql-server-9.4 www-servers/apache dev-vcs/git net-nds/openldap dev-python/passlib &gt;=dev-python/psycopg-2.5.4 dev-python/pyro:4 &gt;=dev-python/werkzeug-0.9.7 dev-python/python-dateutil dev-python/jinja dev-python/pytz =dev-python/python-ldap-9999 dev-python/python-magic virtual/python-imaging dev-python/sphinx &gt;=dev-python/webtest-2.0.17 dev-db/pgbouncer net-analyzer/fail2ban
# Debian
aptitude install apache2 libapache2-mod-wsgi slapd ldap-utils postgresql-client postgresql pgbouncer python3 python3-psycopg2 python3-pyro4 python3-werkzeug python3-dateutil python3-jinja2 python3-tz python3-sphinx python3-webtest python3-magic python3-pil fail2ban # python3-passlib python3-ldap (note that the last two are not yet packaged)
</pre></div>
</div>
</div>
<div class="section" id="checkout-the-repository">
<h2>Checkout the repository<a class="headerlink" href="#checkout-the-repository" title="Permalink to this headline">¶</a></h2>
<p>Use git to clone the code:</p>
<div class="highlight-python"><div class="highlight"><pre>git clone ssh://gitolite@rcs.cde-ev.de:20008/cdedb2
</pre></div>
</div>
<p>For this to work you need to send an ssh public key to the administrators
(<tt class="docutils literal"><span class="pre">admin&#64;lists.cde-ev.de</span></tt>) first, to be authorized for access to the
repository. All commands below assume, that you are in the root directory of
the repository. Now you can build the documentation by issuing:</p>
<div class="highlight-python"><div class="highlight"><pre>make doc
</pre></div>
</div>
<p>If you are reading the excerpt version (<tt class="docutils literal"><span class="pre">INSTALL.html</span></tt>) you can now switch
to the real document.</p>
</div>
<div class="section" id="prepare-environment">
<h2>Prepare environment<a class="headerlink" href="#prepare-environment" title="Permalink to this headline">¶</a></h2>
<p>Now we set up all auxillary stuff. We assume, that postgres is configured
for peer authentication (i.e. the system user xy has access to the postgres
user xy). First execute as user with enough permissions (that is the ability
to run <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">-u</span> <span class="pre">postgres</span> <span class="pre">...</span></tt> and <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">-u</span> <span class="pre">cdb</span> <span class="pre">...</span></tt>) and with running
postgres:</p>
<div class="highlight-python"><div class="highlight"><pre>make sql
</pre></div>
</div>
<p>This will create the database users and tables. Now configure pgbouncer in
<tt class="docutils literal"><span class="pre">pgbouncer.ini</span></tt> (in <tt class="docutils literal"><span class="pre">/etc</span></tt>) with the following:</p>
<div class="highlight-python"><div class="highlight"><pre>[databases]
cdb =
cdb_test =

[pgbouncer]
logfile = /var/log/postgresql/pgbouncer.log
pidfile = /var/run/postgresql/pgbouncer.pid
unix_socket_dir = /run/postgresql
listen_addr = 127.0.0.1
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer_users.txt
pool_mode = session
server_reset_query = DISCARD ALL
max_client_conn = 100
default_pool_size = 20
</pre></div>
</div>
<p>Additionally place copy file <tt class="docutils literal"><span class="pre">related/pgbouncer_users.txt</span></tt> to
<tt class="docutils literal"><span class="pre">/etc/pgbouncer_users.txt</span></tt> for authentication (otherwise pgbouncer will
refuse connections):</p>
<div class="highlight-python"><div class="highlight"><pre>cp related/pgbouncer_users.txt /etc
chown pgbouncer:root /etc/pgbouncer_users.txt
chmod 600 /etc/pgbouncer_users.txt
</pre></div>
</div>
<p>This file may be regenerated with the <tt class="docutils literal"><span class="pre">mkauth.py</span></tt> tool from the pgbouncer
tar-ball.</p>
<p>Next up is LDAP. Edit the <tt class="docutils literal"><span class="pre">/etc/openldap/slapd.conf</span></tt> and enter the
following values (we will use a basic setup via config file, this will be
deprecated at some point in the future, then the <tt class="docutils literal"><span class="pre">cn=config</span></tt> machinery
needs to be used &#8211; how this works can be seen in the auto-build scripts):</p>
<div class="highlight-python"><div class="highlight"><pre>include         /etc/openldap/schema/core.schema
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/cdepersona.schema

pidfile         /var/run/openldap/slapd.pid
argsfile        /var/run/openldap/slapd.args

database        hdb
suffix          &quot;dc=cde-ev,dc=de&quot;
rootdn          &quot;cn=root,dc=cde-ev,dc=de&quot;
rootpw          s1n2t3h4d5i6u7e8o9a0s1n2t3h4d5i6u7e8o9a0
directory       /var/lib/openldap-data
index           objectClass     eq
index           cn      pres,sub,eq
index           sn      pres,sub,eq
index           uid     pres,sub,eq
index           displayName     pres,sub,eq
</pre></div>
</div>
<p>You need to place a symlink to the custom cdepersona schema:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">repo</span><span class="o">/</span><span class="n">cdedb</span><span class="o">/</span><span class="n">database</span><span class="o">/</span><span class="n">cdepersona</span><span class="o">.</span><span class="n">schema</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">schema</span><span class="o">/</span><span class="n">cdepersona</span><span class="o">.</span><span class="n">schema</span>
</pre></div>
</div>
<p>Now start the slapd daemon and issue the following in the repo:</p>
<div class="highlight-python"><div class="highlight"><pre>make ldap
</pre></div>
</div>
<p>Now we set up the Apache server, first add the following lines to
<tt class="docutils literal"><span class="pre">/etc/apache2/httpd.conf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>LoadModule wsgi_module modules/mod_wsgi.so
ServerName localhost
</pre></div>
</div>
<p>and then insert the following close to the end of
<tt class="docutils literal"><span class="pre">/etc/apache2/vhosts.d/00_default_ssl_vhost.conf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>WSGIDaemonProcess cdedb processes=4 threads=4
WSGIScriptAlias /db /path/to/repo/wsgi/cdedb.wsgi

&lt;Directory /path/to/repo/wsgi&gt;
Require all granted
&lt;/Directory&gt;

Alias /static /path/to/repo/static
&lt;Directory /path/to/repo/static/static&gt;
Require all granted
&lt;/Directory&gt;
</pre></div>
</div>
<p>note, that this is syntax for apache-2.4 (which differs from apache-2.2).</p>
<p>Finally we need to create the directory for uploaded data (where
<tt class="docutils literal"><span class="pre">www-data</span></tt> is the user running Apache):</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir /var/lib/cdedb/
chown www-data:www-data /var/lib/cdedb/
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For optimal experience you should run <tt class="docutils literal"><span class="pre">make</span> <span class="pre">storage-test</span></tt> and
copy the resulting uploaded data from <tt class="docutils literal"><span class="pre">/tmp/cdedb-store</span></tt> to
<tt class="docutils literal"><span class="pre">/var/lib/cdedb</span></tt> and make it owned by the apache user.</p>
</div>
</div>
<div class="section" id="configure-the-application">
<h2>Configure the application<a class="headerlink" href="#configure-the-application" title="Permalink to this headline">¶</a></h2>
<p>The details can be found in <a class="reference internal" href="Auxiliary.html#module-cdedb.config" title="cdedb.config"><tt class="xref py py-mod docutils literal"><span class="pre">cdedb.config</span></tt></a>. The global configuration
can be done in <tt class="docutils literal"><span class="pre">cdedb/localconfig.py</span></tt> (a sample for this is provided at
<tt class="docutils literal"><span class="pre">cdedb/localconfig.py.sample</span></tt>, for development instances you are strongly
encouraged to copy this file to <tt class="docutils literal"><span class="pre">cdedb/localconfig.py</span></tt>). The configuration
for the frontend resides in <tt class="docutils literal"><span class="pre">/etc/cdedb-frontend-config.py</span></tt>. The path to
the backend configuration is passed on the command line (if you use the make
recipes, then via the environment variable <tt class="docutils literal"><span class="pre">CONFIGPATH</span></tt>).</p>
</div>
<div class="section" id="running-it">
<h2>Running it<a class="headerlink" href="#running-it" title="Permalink to this headline">¶</a></h2>
<p>First start a <tt class="docutils literal"><span class="pre">pyro</span></tt> nameserver with:</p>
<div class="highlight-python"><div class="highlight"><pre>make pyro-nameserver
</pre></div>
</div>
<p>Second create the directory <tt class="docutils literal"><span class="pre">/run/cdedb</span></tt> (for this you possibly need
elevated privileges). This has to be writable by the user running the
backends and readable by the user running the frontend (here go the sockets
by default):</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir /run/cdedb
chown &lt;user&gt;:&lt;user&gt; /run/cdedb
</pre></div>
</div>
<p>Check if apache, postgres, pgbouncer and slapd are running. Optionally you
can run the test suite first to see whether everything is ready:</p>
<div class="highlight-python"><div class="highlight"><pre>make check
</pre></div>
</div>
<p>Then spin up the backends (exemplary here for the core backend):</p>
<div class="highlight-python"><div class="highlight"><pre>make run-core
</pre></div>
</div>
<p>Now start the apache and access <tt class="docutils literal"><span class="pre">https://localhost/db/</span></tt> with a
browser. Finally you can shutdown the backends with:</p>
<div class="highlight-python"><div class="highlight"><pre>make quit-all
</pre></div>
</div>
</div>
<div class="section" id="refreshing-the-running-instance">
<h2>Refreshing the running instance<a class="headerlink" href="#refreshing-the-running-instance" title="Permalink to this headline">¶</a></h2>
<p>Changes to the code can be propagate as follows to the current instance. For
templates no action is necessary. For the frontend updating the mtime the
wsgi file resets the apache workers:</p>
<div class="highlight-python"><div class="highlight"><pre>touch wsgi/cdedb.wsgi
</pre></div>
</div>
<p>For the backend a restart is required (<tt class="docutils literal"><span class="pre">make</span> <span class="pre">quit-all</span></tt> and <tt class="docutils literal"><span class="pre">make</span>
<span class="pre">run-...</span></tt>). For the database you should restart pgbouncer (which probably
has some open connections left) before doing a <tt class="docutils literal"><span class="pre">make</span> <span class="pre">sample-data</span></tt>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Getting Started</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#checkout-the-repository">Checkout the repository</a></li>
<li><a class="reference internal" href="#prepare-environment">Prepare environment</a></li>
<li><a class="reference internal" href="#configure-the-application">Configure the application</a></li>
<li><a class="reference internal" href="#running-it">Running it</a></li>
<li><a class="reference internal" href="#refreshing-the-running-instance">Refreshing the running instance</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Introduction.html"
                        title="previous chapter">Introduction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Introduction_Readme.html"
                        title="next chapter">Readme</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/Introduction_Setup.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Introduction_Readme.html" title="Readme"
             >next</a> |</li>
        <li class="right" >
          <a href="Introduction.html" title="Introduction"
             >previous</a> |</li>
        <li><a href="index.html">CdEDB 2.0 documentation</a> &raquo;</li>
          <li><a href="Introduction.html" >Introduction</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, CdE Datenbank Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>