{% set sidenav_active='event_lodgements' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block title %}
    {% trans title=ambience['event']['title'] -%}
    	Lodgements ({{ title }})
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/lodgements"), gettext("Lodgements"), active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans -%}Lodgements{%- endtrans %}
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title'] }}</small>
    </h1>
{% endblock %}
{% block content %}
    <div class="p">
        {{ util.href(cdedblink("event/create_lodgement_form"), gettext("Add Lodgement"), readonly=is_locked,
                     aclass='btn btn-sm btn-success', icon='plus') }}
    </div>

    <table class="table table-condensed table-hover">
        <thead>
            <tr>
            <th rowspan="2">{% trans -%}Lodgement{%- endtrans %}</th>
                {% if ambience['event']['parts']|length > 1 %}
                    <th colspan="{{ ambience['event']['parts']|length * 2 }}" class="b-left">Inhabitants</th>
                {% else %}
                    <th rowspan="2" colspan="2" class="text-right">{% trans -%}Inhabitants{%- endtrans %}</th>
                {% endif %}
                <th colspan="2" class="b-left">{% trans -%}Capacity{%- endtrans %}</th>
                <th rowspan="2" class="b-left"></th>
            </tr>
            <tr>
                {% if ambience['event']['parts']|length > 1 %}
                    {% for part_id, part in ambience['event']['parts']|xdictsort('part_begin') %}
                        <th class="text-right{% if loop.first %} b-left{% endif %}">
                            {{ part['title'] }}
                        </th>
                        <th></th>
                    {% endfor %}
                {% endif %}
                <th class="b-left text-right">{% trans -%}Regular{%- endtrans %}</th>
                <th class="text-right">{% trans -%}Camping Mat{%- endtrans %}</th>
            </tr>
        </thead>
        <tbody>
            {% for lodgement_id, lodgement in lodgements|xdictsort('moniker') %}
                <tr>
                    <td>{{ util.href(cdedblink("event/show_lodgement", {'lodgement_id': lodgement_id}),
                                     lodgement['moniker']) }}</td>
                    {% set colors = ['', 'course-fewp', 'course-manyp', 'course-cancelled'] %}
                    {% for part_id, part in ambience['event']['parts']|xdictsort('part_begin') %}
                        {% set problem = problems[(lodgement_id, part_id)] %}
                        <td class="text-right {% if loop.first %} b-left{% endif %}
                            {{ colors[problem[0]] }}" {% if problem[1] %}title="{{ gettext(problem[1]) }}"{% endif %}>
                            {{ (inhabitants[(lodgement_id, part_id)] - reserve_inhabitants[(lodgement_id, part_id)]) }}
                        </td>
                        <td class="text-right {{ colors[problem[0]] }}"
                            {% if problem[1] %}title="{{ gettext(problem[1]) }}"{% endif %}>
                            {% if reserve_inhabitants[(lodgement_id, part_id)] %}
                                + {{ reserve_inhabitants[(lodgement_id, part_id)] }}
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="b-left text-right">{{ lodgement['capacity'] }}</td>
                    <td class=" text-right">+ {{ lodgement['reserve'] }}</td>
                    <td class="b-left">
                        {{ util.href(cdedblink("event/change_lodgement_form", {'lodgement_id': lodgement_id}),
                                     readonly=is_locked, aclass='btn btn-xs btn-warning', icon='pencil',
                                     title=gettext("Edit")) }}
                        {{ util.href(cdedblink("event/manage_inhabitants_form", {'lodgement_id': lodgement_id}),
                                     readonly=is_locked, aclass='btn btn-xs btn-warning', icon='user',
                                     title=gettext("Manage Inhabitants")) }}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <hr />
    <p>
        <strong>{% trans -%}Color Guide{%- endtrans %}:</strong> <br />
        <span class="color-legend course-fewp"></span>&nbsp;{% trans -%}Warning{%- endtrans %} &emsp;
        <span class="color-legend course-manyp"></span>&nbsp;{% trans -%}Overfull{%- endtrans %} &emsp;
        <span class="color-legend course-cancelled"></span>&nbsp;{% trans -%}Illegal Gendermix{%- endtrans %}
    </p>
{% endblock %}
