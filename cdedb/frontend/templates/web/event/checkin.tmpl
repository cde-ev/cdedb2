{% set sidenav_active='event_checkin' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% set jshint='weak' %}
{% block title %}
    {% trans title=ambience['event']['title'] -%}
        Checkin ({{ title }})
    {%- endtrans %}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans -%}Checkin{%- endtrans %}
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title'] }}</small>
    </h1>
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/checkin"), gettext("Checkin"), active=True) }}
{% endblock %}
{% block content %}
    {% call util.bootstrap_panel(gettext("Search Name"), icon='search', aclass='panel-primary panel-condensed softhide',
                                 anid='searchpanel') %}
        <input type="text" id="selector" class="form-control" value=""
               aria-label="{% trans -%}Name to Search{%- endtrans %}" />
    {% endcall %}
    <div class="list-group list-group-hover">
        {% for registration_id, registration in registrations|dictsort %}
            <div class="selectee list-group-item row">
                <div class="col-sm-4">
                    <span class="searchname">
                        {{ personas[registration['persona_id']]['given_names'] }}
                        {{ personas[registration['persona_id']]['family_name'] }}
                    </span>
                    {% if ambience['event']['parts']|length > 1 %}
                        <br />
                        <span class="small text-muted">
                            {% for part_id, part in ambience['event']['parts']|xdictsort('part_begin')
                               if enums['RegistrationPartStati'](registration['parts'][part_id]['status']).is_present() %}
                                {{ part['title'] }}
                                {% if registration['parts'][part_id]['status']
                                        == enums['RegistrationPartStati'].guest.value %}
                                    ({{ gettext(enums['RegistrationPartStati'].guest) }})
                                {% endif %}
                                {% if not loop.last %} • {% endif %}
                            {% endfor %}
                        </span>
                    {% elif (registration['parts']|dictsort)[0]['status']
                            == enums['RegistrationPartStati'].guest.value %}
                        ({{ gettext(enums['RegistrationPartStati'].guest) }})
                    {% endif %}
                </div>
                <div class="col-sm-4 hide-xs">
                    <small class="text-info">
                        {% trans -%}Lodgement{%- endtrans %}:
                        {% for part_id, part in ambience['event']['parts']|xdictsort('part_begin')
                               if enums['RegistrationPartStati'](registration['parts'][part_id]['status']).is_present() %}
                            {% if registration['parts'][part_id]['lodgement_id'] %}
                                {{ lodgements[registration['parts'][part_id]['lodgement_id']]['moniker'] }}
                            {% else %}
                                –
                            {% endif %}
                            {% if not loop.last %} / {% endif %}
                        {% endfor %}
                    </small>
                </div>
                <div class="col-sm-4">
                    <form action="{{ cdedblink('event/checkin') }}" method="POST" id="checkinform{{ registration_id }}"
                          style="display: inline;" class="checkinform">
                        {{ util.anti_csrf_token('event/checkin') }}
                        {{ util.input_hidden(name="registration_id", value=registration_id) }}
                        {{ util.input_submit(value=gettext("Checkin"), aclass="btn btn-primary btn-sm") }}
                    </form>
                    {{ util.href(cdedblink('event/change_registration',
                                           {'registration_id': registration_id, 'skip': 'reg.checkin'}),
                                 gettext("Edit"), icon='pencil', aclass="btn btn-sm btn-warning") }}
                </div>
            </div>
        {% endfor %}
    </div>
    <script type="text/javascript">
        $("#searchpanel").show();
        $("#selector").focus()
            .on('keydown paste input', function(){
                /* Source: https://stackoverflow.com/a/3561711 and https://stackoverflow.com/a/874722 */
                var re = new RegExp(removeDiacritics($(this).val()).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'i');
                $(".selectee").each(function(){
                    if (removeDiacritics($(this).text()).match(re))
                        $(this).show();
                    else
                        $(this).hide();
                });
            })
            .trigger('input');
        $('.checkinform').cdedbProtectAction("{{ gettext("The Participant will be checked in.") }}");
    </script>
{% endblock %}
