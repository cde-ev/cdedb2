{% set sidenav_active='event_fees' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_helper.js') }}
    {{ util.cdedb_script('cdedb_multiset.js') }}
{% endblock %}
{% set jshint='weak' %}

{% block title %}
    {% if ambience['fee'] %}
        {% trans fee_title=ambience['fee'].title, event_title=ambience['event'].title %}
            Set Personalized Fees for {{ fee_title }} ({{ event_title }})
        {% endtrans %}
    {% else %}
        {% trans event_title=ambience['event'].title %}
            Select Personalized Fee ({{ event_title }})
        {% endtrans %}
    {% endif %}
{% endblock %}

{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event'].title, icon="chalkboard-teacher") }}
    {% if ambience['fee'] %}
        {{ util.breadcrumb_link(cdedblink("event/fee_summary"), gettext("Fees")) }}
        {{ util.breadcrumb_link("", ambience['fee'].title, icon="coins", readonly=True) }}
    {% else %}
        {{ util.breadcrumb_link(cdedblink("event/registration_query"), gettext("Registrations")) }}
    {% endif %}
    {{ util.breadcrumb_link(cdedblink("event/set_personalized_fees"), gettext("Set Amounts"), icon="edit", active=True) }}
{% endblock %}

{% block heading %}
    {% if ambience['fee'] %}
        {{ util.context_heading(gettext("Set Personalized Fees for %(fee_title)s")|format(fee_title=ambience['fee'].title),
                                ambience['event'].title, 'chalkboard-teacher') }}
    {% else %}
        {{ util.context_heading(gettext("Select Personalized Fee"), ambience['event'].title,
                                'chalkboard-teacher') }}
    {% endif %}
    {{ util.doclink_("Handbuch_Orga_Teilnahmebeitraege") }}
{% endblock %}

{% block content %}

    {% if ambience['fee'] %}

        <form action="{{ cdedblink('event/set_personalized_fees') }}" method="POST" id="setpersonalizedfeeamountsform" class="form-horizontal">
            <p class="text-info">
                {{ util.make_icon("info-circle") }}
                This form can be used to set the individual amounts of the chosen personalized fee for multiple registrations at once.
            </p>
            <p class="multiset-explanation text-info" style="display: none;">
                {{ util.make_icon("info-circle") }}
                {% trans %}
                    Changed entries are highlighted in yellow.
                    Newly added entries are shown in green and deleted entries in red.
                    You can use the "Restore"-button to restore a changed or deleted entry to its original value.
                    You can use the "Delete"-button to set an entry to empty, which will delete it.
                {% endtrans %}
            </p>

            {{ util.anti_csrf_token('event/set_personalized_fees') }}
            {{ util.input_hidden('registration_ids', registration_ids|join(',')) }}
            {# Already sorted #}
            {% for reg in registrations %}
                {{ util.form_input_text("amount" + reg['id']|string, label=util.persona_name(personas[reg['persona_id']]),
                                        placeholder="", type="number", aclass="no-number-arrows",
                                        attributes='style="width:6em;" step="0.01"'|s,
                                        outerclass='multiset-input') }}
            {% endfor %}

            {{ util.form_input_submit(label=gettext("Save"), cancellink=cdedblink("event/fee_summary")) }}
        </form>

        <script nonce="{{ csp_nonce }}">
            $('#setpersonalizedfeeamountsform').cdedbProtectChanges().multiset(
                '{{ util.make_icon("trash-alt") }}', '{{ gettext("Delete") }}',
                '{{ util.make_icon("redo") }}', '{{ gettext("Restore") }}',
            );
        </script>
    {% else %}
        <form action="{{ cdedblink('event/set_personalized_fees_form') }}" method="GET"
              id="selectpersonalizedfeeform" class="form-horizontal">
            <p class="text-info">
                {{ util.make_icon("info-circle") }}
                Select a personalized fee to set individual amounts for that fee for the following registrations:
            </p>
            {{ util.form_input_select("fee_id", label=gettext("Personalized Fee"), nulloption="",
                                      entries=fee_titles.items(), small=True) }}
            {{ util.input_hidden(name="registration_ids") }}
            {{ util.form_input_submit(label=gettext("Continue"), cancellink=cdedblink("event/fee_summary"),
                                      icon="chevron-right", small=True) }}
        </form>
        {% if registrations %}
            <h4 class="mosp">
                {% trans %}Registrations{% endtrans %}
            </h4>
            <ul id="registrations-list">
                {% for reg in registrations %}
                    <li>{{ util.persona_name(personas[reg['persona_id']]) }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endif %}
{% endblock %}
