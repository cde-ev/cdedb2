{% set sidenav_active='event_registration' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('helper') }}{% endblock %}
{% block title %}
Anmeldung von {{ persona['given_names']|e }} {{ persona['family_name']|e }} ({{ ambience['event']['title']|e }})
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/registration_query"), "Anmeldungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_registration"),
    persona['given_names']|e + " " + persona['family_name']|e, active=True, icon="user") }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {{ persona['given_names']|e }} {{ persona['family_name']|e }}
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title']|e }}</small>
    </h1>
{% endblock %}
{% block content %}
    <div class="p">
        {{ util.href(cdedblink("event/change_registration_form"), "Bearbeiten", readonly=is_locked,
                     aclass="btn btn-warning btn-sm", icon="pencil") }}
    </div>
    <h3 class="heading-underline">Personendaten</h3>
    <dl class="dl-horizontal">
        <dt>Name</dt>
        <dd>
            {{ persona['title']|e }}
            {{ persona['given_names']|e }}
            {{ persona['family_name']|e }}
            {{ persona['name_supplement']|e }}
        </dd>
        <dt>CdEDB-ID</dt>
        <dd>{{ util.href(show_user_link(persona['id'], event_id=ambience['event']['id']), persona['id']|cdedbid) }}</dd>
        {% if ambience['registration']['real_persona_id'] %}
            <dt>Online CdEDB-ID</dt>
            <dd>{{ ambience['registration']['real_persona_id']|cdedbid|e }}</dd>
        {% endif %}
        <dt>CdE-Mitglied</dt>
        <dd>{{ util.deko_checkbox(checked=(persona['is_member'])) }}</dd>
        <dt>Geburtstag</dt>
        <dd>
            {{ persona['birthday']|date(lang=lang)|e }} (<em>{{ gettext(age|string)|e }}</em>)
        </dd>
        <dt>Geschlecht</dt>
        <dd>{{ gettext(enums['Genders'](persona['gender'])|string)|e }}</dd>
    </dl>
    <dl class="dl-horizontal">
        <dt>E-Mail</dt>
        <dd>{{ persona['username']|e }} </dd>
        <dt>Telefon</dt>
        <dd>{{ persona['telephone']|e }}</dd>
        <dt>Mobiltelefon</dt>
        <dd>{{ persona['mobile']|e }}</dd>
    </dl>
    <dl class="dl-horizontal">
        <dt>Straße</dt>
        <dd>{{ persona['address']|e }}</dd>
        <dt>Adresszusatz</dt>
        <dd>{{ persona['address_supplement']|e }}</dd>
        <dt>Stadt</dt>
        <dd>{{ persona['postal_code']|e }} {{ persona['location']|e }}</dd>
        <dt>Land</dt>
        <dd>{{ persona['country']|e }}</dd>
    </dl>
    {% if persona['id'] in ambience['event']['orgas'] %}
    <p class="text-info">
        {{ persona['given_names']|e }} ist Orga dieser Veranstaltung.
    </p>
    {% endif %}

    {% call util.bootstrap_panel(title="Orga-Notizen", icon="tag",
                                 aclass="panel-default panel-condensed") %}
        {{ ambience['registration']['orga_notes']|rst }}
    {% endcall %}

    <h3 class="heading-underline">Status</h3>
    <dl class="dl-horizontal">
        <dt>Teilnehmerbeitrag</dt>
        <dd>
            {% if ambience['registration']['payment'] %}
                bezahlt am {{ ambience['registration']['payment'] |date(lang=lang)|e }}
            {% else %}
                <em>ausstehend</em>
            {% endif %}
        </dd>

        <dt>Einverständniserklärung der Eltern</dt>
        <dd>
            {% if not age.is_minor() %}
                <em>volljährig</em>
            {% else %}
                {{ util.deko_checkbox(checked=ambience['registration']['parental_agreement']) }}
            {% endif %}
        </dd>

        <dt>Eingecheckt</dt>
        <dd>
            {% if ambience['registration']['checkin'] %}
                eingecheckt am {{ ambience['registration']['checkin'] |datetime(lang=lang)|e }} Uhr
            {% else %}
                —
            {% endif %}
        </dd>
    </dl>

    <div class="row">
        {% for part_id, part in ambience['event']['parts']|xdictsort('part_begin') %}
            <div class="col-md-6">
                {% if ambience['event']['parts']|length > 1 %}
                    <h4>{{ part['title']|e }}</h4>
                {% endif %}
                <dl class="dl-horizontal">
                    <dt>Status</dt>
                    <dd>
                        {{ gettext(ambience['registration']['parts'][part_id]['status']
                                |enum(enums['RegistrationPartStati']))|e }}
                    </dd>
                    {% if enums['RegistrationPartStati'](ambience['registration']['parts'][part_id]['status'])
                            .is_involved() %}
                        {% for track_id, track in ambience['event']['tracks']|xdictsort('sortkey')
                                if track['part_id'] == part_id %}
                            <dt>
                                Kurs {% if ambience['event']['tracks']|length > 1 %}{{ track['title']|e }}{% endif %}
                            </dt>
                            <dd>
                                {% with course_id = ambience['registration']['tracks'][track_id]['course_id'] %}
                                    {% if course_id %}
                                        {{ util.href(cdedblink('event/show_course', {'course_id': course_id}),
                                                     "{}. {}".format(courses[course_id]['nr'],
                                                                     courses[course_id]['shortname'])) }}
                                    {% else %}
                                        —
                                    {% endif %}
                                {% endwith %}
                            </dd>
                        {% endfor %}

                        <dt>Unterkunft</dt>
                        <dd>
                            {% with lodgement_id = ambience['registration']['parts'][part_id]['lodgement_id'] %}
                                {% if lodgement_id %}
                                    {{ util.href(cdedblink('event/show_lodgement', {'lodgement_id': lodgement_id}),
                                                 lodgements[lodgement_id]['moniker']) }}
                                {% else %}
                                    —
                                {% endif %}
                            {% endwith %}
                        </dd>
                        <dt>Isomattenplatz</dt>
                        <dd>
                            {{ util.deko_checkbox(checked=ambience['registration']['parts'][part_id]['is_reserve']) }}
                        </dd>
                    {% endif %}
                </dl>
            </div>
        {% endfor %}
    </div>

    <h3 class="heading-underline">Anmeldedaten</h3>
        <dl class="dl-horizontal">
            <dt>Gemischte Unterbringung</dt>
            <dd>
                {{ util.deko_checkbox(checked=ambience['registration']['mixed_lodging']) }}
            </dd>
            <dt>Foto-Einwilligung</dt>
            <dd>
                {{ util.deko_checkbox(checked=ambience['registration']['foto_consent']) }}
            </dd>
        </dl>
        <h4>Kurswahl</h4>
        <div class="row">
            {% for track_id, track in ambience['event']['tracks']|xdictsort('sortkey') %}
                <div class="col-md-6">
                    {% if ambience['event']['tracks']|length > 1 %}
                        <h5>{{ track['title']|e }}</h5>
                    {% endif %}

                    <dl class="dl-horizontal">
                        <dt>Kursleiter von</dt>
                        <dd>
                            {% if ambience['registration']['tracks'][track_id]['course_instructor'] %}
                                {{ courses[ambience['registration']['tracks'][track_id]['course_instructor']]['nr']|e }}.
                                {{ courses[ambience['registration']['tracks'][track_id]['course_instructor']]['shortname']|e }}
                            {% else %}
                                —
                            {% endif %}
                        </dd>
                        {% for i in range(track['num_choices']) %}
                            <dt>{{ "{}. Wahl".format(i + 1) }}</dt>
                            <dd>
                                {% if ambience['registration']['tracks'][track_id]['choices']|length > i  %}
                                    {{ courses[ambience['registration']['tracks'][track_id]['choices'][i]]['nr']|e }}.
                                    {{ courses[ambience['registration']['tracks'][track_id]['choices'][i]]['shortname']|e }}
                                {% else %}
                                    —
                                {% endif %}
                            </dd>
                        {% endfor %}
                    </dl>
                </div>
            {% endfor %}
        </div>
    {% call util.bootstrap_panel(title="Anmerkungen", aclass="panel-default panel-condensed") %}
        {{ ambience['registration']['notes']|rst }}
    {% endcall %}

    {% if ambience['event']['fields']|length > 0 %}
        <h3 class="heading-underline">Datenfelder</h3>
        <dl class="dl-horizontal">
            {% for field_id, field in ambience['event']['fields']|dictsort %}
                {% if field['association'] == enums['FieldAssociations'].registration %}
                    <dt>{{ field['field_name']|e }}</dt>
                    <dd>
                        {% if field['entries'] %}
                            {% for value, description in field['entries'] %}
                                {% if ambience['registration']['fields'].get(field['field_name']) == value %}
                                    {{ description|e }}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% if field['kind'] == "bool" %}
                                {{ util.deko_checkbox(
                                    checked=ambience['registration']['fields'].get(field['field_name'])) }}
                            {% elif field['kind'] == "date" %}
                                {{ ambience['registration']['fields'].get(field['field_name'])
                                   |date(lang=lang, passthrough=True)|e }}
                            {% elif field['kind'] == "datetime" %}
                                {{ ambience['registration']['fields'].get(field['field_name'])
                                   |datetime(lang=lang, passthrough=True)|e }}
                            {% else %}
                                {{ ambience['registration']['fields'].get(field['field_name'])|e|linebreaks }}
                            {% endif %}
                        {% endif %}
                    </dd>
                {% endif %}
            {% endfor %}
        </dl>
    {% endif %}

    {% call util.bootstrap_panel(title="Aktionen", icon="warning-sign", aclass="panel-danger mosp") %}
        <div class="row">
            <div class="col-sm-4">
                <div class="p">
                    <form action="{{ cdedblink('event/delete_registration')|e }}" method="POST"
                          id="deleteregistrationform" style="display: inline;">
                        {{ util.input_submit("Löschen", readonly=is_locked, aclass="btn btn-sm btn-danger",
                                             icon='trash') }}
                        {{ util.input_checkbox(name="ack_delete", label="sicher?", readonly=is_locked) }}
                    </form>
                    <script type="text/javascript">
                        $('#deleteregistrationform').cdedbProtectAction("Die Anmeldung wird irreversibel gelöscht.");
                        $('#deleteregistrationform').find('[name="ack_delete"]').prop('checked', true).parent().hide();
                    </script>
                </div>
            </div>
            <div class="col-sm-8">
                <p class="text-muted">
                    Löscht die Anmeldung inklusive aller hier angezeigter Informationen.
                </p>
            </div>
        </div>
    {% endcall %}
{% endblock %}
