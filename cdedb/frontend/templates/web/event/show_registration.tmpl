{% extends "web/event/base.tmpl" %}
{% set sidenav_active='event_registration' %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% block title %}
    {% trans given_names=persona['given_names'], family_name=persona['family_name'],
             title=ambience['event']['title'] -%}
    	Registration by {{ given_names }} {{ family_name }} ({{ title }})
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/registration_query"), gettext("Registrations")) }}
{{ util.breadcrumb_link(cdedblink("event/show_registration"),
        "{} {}".format(persona['given_names'], persona['family_name']), active=True, icon="user") }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {{ persona['given_names'] }} {{ persona['family_name'] }}
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title'] }}</small>
    </h1>
{% endblock %}
{% block content %}
    <div class="p">
        {{ util.href(cdedblink("event/change_registration_form"), gettext("Edit"), readonly=is_locked,
                     aclass="btn btn-warning btn-sm", icon="pencil") }}
    </div>
    <h3 class="heading-underline">{% trans -%}Personal Information{%- endtrans %}</h3>
    <dl class="dl-horizontal">
        <dt>{% trans -%}Full Name{%- endtrans %}</dt>
        <dd>
            {{ persona['title'] }}
            {{ persona['given_names'] }}
            {{ persona['family_name'] }}
            {{ persona['name_supplement'] }}
        </dd>
        <dt>{% trans -%}CdEDB-ID{%- endtrans %}</dt>
        <dd>{{ util.href(show_user_link(persona['id'], event_id=ambience['event']['id']), persona['id']|cdedbid) }}</dd>
        {% if ambience['registration']['real_persona_id'] %}
            <dt>{% trans -%}Online CdEDB-ID{%- endtrans %}</dt>
            <dd>{{ ambience['registration']['real_persona_id']|cdedbid }}</dd>
        {% endif %}
        <dt>{% trans -%}CdE-Member{%- endtrans %}</dt>
        <dd>{{ util.deko_checkbox(checked=(persona['is_member'])) }}</dd>
        <dt>{% trans -%}Birthday{%- endtrans %}</dt>
        <dd>
            {{ persona['birthday']|date(lang=lang) }} (<em>{{ gettext(age|string) }}</em>)
        </dd>
        <dt>{% trans -%}Gender{%- endtrans %}</dt>
        <dd>{{ gettext(enums['Genders'](persona['gender'])|string) }}</dd>
    </dl>
    <dl class="dl-horizontal">
        <dt>{% trans -%}E-Mail{%- endtrans %}</dt>
        <dd>{{ util.username_mailto(persona) }} </dd>
        <dt>{% trans -%}Phone{%- endtrans %}</dt>
        <dd>{{ persona['telephone'] }}</dd>
        <dt>{% trans -%}Mobile Phone{%- endtrans %}</dt>
        <dd>{{ persona['mobile'] }}</dd>
    </dl>
    <dl class="dl-horizontal">
        <dt>{% trans -%}Address{%- endtrans %}</dt>
        <dd>{{ persona['address'] }}</dd>
        <dt>{% trans -%}Address Supplement{%- endtrans %}</dt>
        <dd>{{ persona['address_supplement'] }}</dd>
        <dt>{% trans -%}City{%- endtrans %}</dt>
        <dd>{{ persona['postal_code'] }} {{ persona['location'] }}</dd>
        <dt>{% trans -%}Country{%- endtrans %}</dt>
        <dd>{{ persona['country'] }}</dd>
    </dl>
    {% if persona['id'] in ambience['event']['orgas'] %}
    <p class="text-info">
        {% trans given_names=persona['given_names'] -%}
        	{{ given_names }} is Orga of this event.
        {%- endtrans %}
    </p>
    {% endif %}

    {% call util.bootstrap_panel(title=gettext("Orga-Notes"), icon="tag",
                                 aclass="panel-default panel-condensed") %}
        {{ ambience['registration']['orga_notes']|md }}
    {% endcall %}

    <h3 class="heading-underline">{% trans -%}Status{%- endtrans %}</h3>
    <dl class="dl-horizontal">
        <dt>{% trans -%}Participation Fee{%- endtrans %}</dt>
        <dd>
            {% if ambience['registration']['payment'] %}
                {% trans date=ambience['registration']['payment']|date(lang=lang) -%}
                	Paid on the {{ date }}
                {%- endtrans %}
            {% else %}
                <em>{% trans -%}Pending{%- endtrans %}</em>
            {% endif %}
        </dd>

        <dt>{% trans -%}Parental Consent{%- endtrans %}</dt>
        <dd>
            {% if not age.is_minor() %}
                <em>{% trans -%}Of Age{%- endtrans %}</em>
            {% else %}
                {{ util.deko_checkbox(checked=ambience['registration']['parental_agreement']) }}
            {% endif %}
        </dd>

        <dt>{% trans -%}Checked-In{%- endtrans %}</dt>
        <dd>
            {% if ambience['registration']['checkin'] %}
                {% trans datetime=ambience['registration']['checkin']|datetime(lang=lang) -%}
                	Checked-In: {{ datetime }}
                {%- endtrans %}
            {% else %}
                —
            {% endif %}
        </dd>
    </dl>

    <div class="row">
        {% for part_id, part in ambience['event']['parts']|keydictsort(ENTITY_SORTKEYS.event_part) %}
            <div class="col-md-6">
                {% if ambience['event']['parts']|length > 1 %}
                    <h4>{{ part['title'] }}</h4>
                {% endif %}
                <dl class="dl-horizontal">
                    <dt>{% trans -%}Status{%- endtrans %}</dt>
                    <dd>
                        {{ gettext(ambience['registration']['parts'][part_id]['status']
                                |enum(enums['RegistrationPartStati'])) }}
                    </dd>
                    {% if enums['RegistrationPartStati'](ambience['registration']['parts'][part_id]['status'])
                            .is_involved() %}
                        {% for track_id, track in ambience['event']['tracks']|keydictsort(ENTITY_SORTKEYS.course_track)
                                if track['part_id'] == part_id %}
                            <dt>
                                {% trans track=track['title'] if ambience['event']['tracks']|length > 1 else "" -%}
                                	Course {{ track }}
                                {%- endtrans %}
                            </dt>
                            <dd>
                                {% with course_id = ambience['registration']['tracks'][track_id]['course_id'] %}
                                    {% if course_id %}
                                        {{ util.href(cdedblink('event/show_course', {'course_id': course_id}),
                                                     "{}. {}".format(courses[course_id]['nr'],
                                                                     courses[course_id]['shortname'])) }}
                                    {% else %}
                                        —
                                    {% endif %}
                                {% endwith %}
                            </dd>
                        {% endfor %}

                        <dt>{% trans -%}Lodgement{%- endtrans %}</dt>
                        <dd>
                            {% with lodgement_id = ambience['registration']['parts'][part_id]['lodgement_id'] %}
                                {% if lodgement_id %}
                                    {{ util.href(cdedblink('event/show_lodgement', {'lodgement_id': lodgement_id}),
                                                 lodgements[lodgement_id]['moniker']) }}
                                {% else %}
                                    —
                                {% endif %}
                            {% endwith %}
                        </dd>
                        <dt>{% trans -%}Uses Camping Mat{%- endtrans %}</dt>
                        <dd>
                            {{ util.deko_checkbox(checked=ambience['registration']['parts'][part_id]['is_reserve']) }}
                        </dd>
                    {% endif %}
                </dl>
            </div>
        {% endfor %}
    </div>

    <h3 class="heading-underline">{% trans -%}Registration Data{%- endtrans %}</h3>
        <dl class="dl-horizontal">
            <dt>{% trans -%}Mixed Lodging{%- endtrans %}</dt>
            <dd>
                {{ util.deko_checkbox(checked=ambience['registration']['mixed_lodging']) }}
            </dd>
            <dt>{% trans -%}Participant List Consent{%- endtrans %}</dt>
            <dd>
                {{ util.deko_checkbox(checked=ambience['registration']['list_consent']) }}
            </dd>
        </dl>
        <h4>{% trans -%}Course Choices{%- endtrans %}</h4>
        {% if ambience['event']['tracks']|length > 0 %}
            <div class="row">
                {% for track_id, track in ambience['event']['tracks']|keydictsort(ENTITY_SORTKEYS.course_track) %}
                    <div class="col-md-6">
                        {% if ambience['event']['tracks']|length > 1 %}
                            <h5>{{ track['title'] }}</h5>
                        {% endif %}

                        <dl class="dl-horizontal">
                            <dt>{% trans -%}Instructor of{%- endtrans %}</dt>
                            <dd>
                                {% if ambience['registration']['tracks'][track_id]['course_instructor'] %}
                                    {{ courses[ambience['registration']['tracks'][track_id]['course_instructor']]['nr'] }}.
                                    {{ courses[ambience['registration']['tracks'][track_id]['course_instructor']]['shortname'] }}
                                {% else %}
                                    —
                                {% endif %}
                            </dd>
                            {% for i in range(track['num_choices']) %}
                                <dt>{{ gettext("%s. Choice")|format(i + 1) }}</dt>
                                <dd>
                                    {% if ambience['registration']['tracks'][track_id]['choices']|length > i  %}
                                        {{ courses[ambience['registration']['tracks'][track_id]['choices'][i]]['nr'] }}.
                                        {{ courses[ambience['registration']['tracks'][track_id]['choices'][i]]['shortname'] }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </dd>
                            {% endfor %}
                        </dl>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% call util.bootstrap_panel(title=gettext("Notes"), aclass="panel-default panel-condensed") %}
        {{ ambience['registration']['notes']|md }}
    {% endcall %}

    {% if ambience['event']['fields']|length > 0 %}
        <h3 class="heading-underline">{% trans -%}Custom Fields{%- endtrans %}</h3>
        <dl class="dl-horizontal">
            {% for field_id, field in ambience['event']['fields']|keydictsort(ENTITY_SORTKEYS.event_field) %}
                {% if field['association'] == enums['FieldAssociations'].registration %}
                    <dt>{{ field['field_name'] }}</dt>
                    <dd>
                        {% if field['entries'] %}
                            {% for value, description in field['entries'] %}
                                {% if ambience['registration']['fields'].get(field['field_name']) == value %}
                                    {{ description }}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% if field['kind'] == enums['FieldDatatypes'].bool %}
                                {{ util.deko_checkbox(
                                    checked=ambience['registration']['fields'].get(field['field_name'])) }}
                            {% elif field['kind'] == enums['FieldDatatypes'].date %}
                                {{ ambience['registration']['fields'].get(field['field_name'])
                                   |date(lang=lang, passthrough=True) }}
                            {% elif field['kind'] == enums['FieldDatatypes'].datetime %}
                                {{ ambience['registration']['fields'].get(field['field_name'])
                                   |datetime(lang=lang, passthrough=True) }}
                            {% elif field['kind'] == enums['FieldDatatypes'].float %}
                                {{ ambience['registration']['fields'].get(field['field_name'])|decimal(lang=lang) }}
                            {% else %}
                                {{ ambience['registration']['fields'].get(field['field_name'])|linebreaks }}
                            {% endif %}
                        {% endif %}
                    </dd>
                {% endif %}
            {% endfor %}
        </dl>
    {% endif %}

    <h3 class="heading-underline">{% trans -%}Copy-Paste Template{%- endtrans %}</h3>
    <pre>
Beachte bitte, dass Deine Anmeldung erst mit Überweisung des Teilnehmerbeitrags gültig wird.
Überweise dazu {{ fee|money(lang=lang) }} auf folgendes Konto.
Achte bitte bei internationalen Überweisungen darauf, dass der Empfänger keine Gebühren zahlen muss.

Kontoinhaber:       {{ meta_info['CdE_Konto_Inhaber'] }}
IBAN:               {{ ambience['event']['iban']|iban }}
BIC:                {{ meta_info['CdE_Konto_BIC'] }}
Kreditinstitut:     {{ meta_info['CdE_Konto_Institut'] }}
Betrag:             {{ fee|money(lang=lang) }}
Verwendungszweck:   {{ persona['given_names'] }} {{ persona['family_name'] }}, {{ persona['id']|cdedbid }}, {{ ambience['event']['title'] }}
</pre>

    {% call util.bootstrap_panel(title=gettext("Actions"), icon="warning-sign", aclass="panel-danger mosp") %}
        <div class="row">
            <div class="col-sm-4">
                <div class="p">
                    <form action="{{ cdedblink('event/delete_registration') }}" method="POST"
                          id="deleteregistrationform" style="display: inline;">
                        {{ util.anti_csrf_token('event/delete_registration') }}
                        {{ util.input_submit(gettext("Delete"), readonly=is_locked, aclass="btn btn-sm btn-danger",
                                             icon='trash') }}
                        {{ util.input_checkbox(name="ack_delete", label=gettext("Are you sure?"), readonly=is_locked) }}
                    </form>
                    <script type="text/javascript" nonce="{{ csp_nonce }}">
                        $('#deleteregistrationform').cdedbProtectAction(
                            "{{ gettext("The registration will be permanently deleted.") }}");
                        $('#deleteregistrationform').find('[name="ack_delete"]').prop('checked', true).parent().hide();
                    </script>
                </div>
            </div>
            <div class="col-sm-8">
                <p class="text-muted">
                    {% trans -%}Deletes the registration including all information shown here.{%- endtrans %}
                </p>
            </div>
        </div>
    {% endcall %}
{% endblock %}
