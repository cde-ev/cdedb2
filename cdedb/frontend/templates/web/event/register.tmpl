{% set sidenav_active='event_register' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% block title %}
    {% trans title=ambience['event']['title'] -%}
    	Registration for {{ title }}
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard",
                        readonly=not (ambience['event']['is_visible'] or ambience['event']['id'] in user.orga or is_admin)) }}
{{ util.breadcrumb_link(cdedblink("event/register"), gettext("Register"), active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans -%}Registration{%- endtrans %}
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title'] }}</small>
    </h1>
{% endblock %}
{% block content %}
    <p>
        {% if ambience['event']['registration_soft_limit'] is none %}
            {% trans -%}
                All data except Event-Parts can be changed until the registration ends.
            {%- endtrans %}
        {% elif ambience['event']['registration_soft_limit'] >= now() %}
            {% trans date=ambience['event']['registration_soft_limit']|datetime(lang=lang) -%}
            	All data except Event-Parts can be changed until the registration ends({{ date }}).
            {%- endtrans %}
        {% else %}
            {% trans -%}
                The official registration has ended. Your registration will be considered if possible.
            {%- endtrans %}
        {% endif %}
    </p>

    <form action="{{ cdedblink('event/register') }}" method="POST" id="registerform" class="form-horizontal">
        {{ util.anti_csrf_token('event/register') }}
        <h3 class="heading-underline">{% trans -%}My Data{%- endtrans %}</h3>
        <dl class="dl-horizontal">
            <dt>{% trans -%}Full Name{%- endtrans %}</dt>
            <dd>
                {{ persona['title'] }}
                {{ persona['given_names'] }}
                {{ persona['family_name'] }}
                {{ persona['name_supplement'] }}
            </dd>

            <dt>{% trans -%}Birthday{%- endtrans %}</dt>
            <dd>{{ persona['birthday'] }}</dd>
            <dt>{% trans -%}Gender{%- endtrans %}</dt>
            <dd>{{ gettext(enums['Genders'](persona['gender'])|string) }}</dd>
            <dt>{% trans -%}E-Mail{%- endtrans %}</dt>
            <dd> {{ persona['username'] }} </dd>
            <dt>{% trans -%}Phone{%- endtrans %}</dt>
            <dd>{{ persona['telephone'] }}</dd>
            <dt>{% trans -%}Mobile Phone{%- endtrans %}</dt>
            <dd>{{ persona['mobile'] }}</dd>
            <dt>{% trans -%}Address{%- endtrans %}</dt>
            <dd>{{ persona['address'] }}</dd>
            <dt>{% trans -%}Address Supplement{%- endtrans %}</dt>
            <dd>{{ persona['address_supplement'] }}</dd>
            <dt>{% trans -%}City{%- endtrans %}</dt>
            <dd>{{ persona['postal_code'] }} {{ persona['location'] }}</dd>
            <dt>{% trans -%}Country{%- endtrans %}</dt>
            <dd>{{ persona['country'] }}</dd>
        </dl>
        <p>
            {% trans link=util.href(cdedblink('core/change_user'), gettext("form to edit your profile")) -%}
            	This data is taken from your personal profile. To change it, use this {{ link }}.
            {%- endtrans %}
        </p>

        {% if ambience['event']['parts']|length > 1
                or (ambience['event']['parts']|length == 1 and course_choices[(course_choices|list)[0]]|length > 0) %}
            <h3 class="heading-underline">{% trans -%}Registration{%- endtrans %}</h3>
        {% endif %}

        {% if ambience['event']['registration_text'] %}
            {{ ambience['event']['registration_text']|md }}
        {% endif %}

        {% if ambience['event']['parts']|length > 1 %}
            {{ util.form_input_checkboxes(name="parts", label=gettext("Event-Parts"),
                                          entries=ambience['event']['parts']|xdictsort('part_begin')
                                              |dict_entries('id', 'title')) }}
        {% elif ambience['event']['parts']|length == 1 %}
            {{ util.input_hidden(name="parts", value=(ambience['event']['parts']|list)[0]) }}
        {% endif %}

        {% for track_id, track in ambience['event']['tracks']|xdictsort('sortkey') %}
            {% set course_list = course_choices[track_id] %}
            {% if course_list and track['num_choices'] %}
                <div id="course_choice_container-{{ track_id }}" class="course_choice_container"
                     data-part="{{ track['part_id'] }}">
                    <h4>
                        {% trans -%}Course Choices{%- endtrans %}
                        {% if course_choices|length > 1 %}
                            {% trans track=track['title'] -%}
                            	for {{ track }}
                            {%- endtrans %}
                        {% endif %}
                    </h4>

                    {% set course_entries = courses|xdictsort('nr', pad=True)
                                            |xdict_entries('{id}', '{nr}. {title}', include=course_list) %}
                    {% for i in range(track['num_choices']) %}
                        {{ util.form_input_select(name="course_choice{}_{}".format(track_id, i),
                                                  label=gettext("%s. Choice")|format(i + 1), entries=course_entries) }}
                    {% endfor %}

                    {{ util.form_input_select(name="course_instructor{}".format(track_id), entries=course_entries,
                                              nulloption=gettext("– I am not an Instructor –"), label=gettext("Instructor"),
                                              info=gettext("If you are instructing a course, please specify which one.")) }}
                </div>
            {% endif %}
        {% endfor %}

        <h3 class="heading-underline">{% trans -%}Additional Information{%- endtrans %}</h3>
        {% if not age.may_mix() %}
            {{ util.input_hidden(name="mixed_lodging", value=False) }}
            {{ util.form_input_static(label=gettext("Mixed Lodging"), value=gettext("Mixed Lodging not possible.")) }}
        {% else %}
            {% if age.is_minor() %}
                {% set mix_info = gettext("The selection must be compatible with the parental consent form.") %}
            {% else %}
                {% set mix_info = "" %}
            {% endif %}
            {{ util.form_input_select(name="mixed_lodging", entries=(
                (True, gettext("I agree to mixed lodging.")),
                (False, gettext("I want to be lodged seperated by gender."))),
                label=gettext("Mixed Lodging"), info=mix_info) }}
        {% endif %}
        {% call util.form_input_general(displayerrors=False) %}
            <p class="nosp">
                {% trans -%}
                    In the context of this event, photos and recordings will be made to be used for the
                    event-documentation and a CdE-internal, password protected media collection. Individual photos and
                    recordings can be excluded from this by request.
                {%- endtrans %}
            </p>
        {% endcall %}
        {{ util.form_input_checkbox(name="list_consent", defaultvalue='True', label=gettext(
                "I agree that my data, including my name, address and my email, may be sent "
                "to other participants of this event beforehand.")) }}
        {{ util.form_input_textarea(name="notes", label=gettext("Notes for Orgas and Instructors"), rows="5") }}
        {% call util.form_input_general(displayerrors=False) %}
            {% if ambience['event']['use_questionnaire'] %}
                <p class="text-info nosp">
                    {{ util.make_icon('info-sign') }}
                    {% trans -%}
                        After registration, you will find the ‘Questionnaire’ with further questions of the orga team in
                        the navigation. There you can give more detailed information.
                    {%- endtrans %}
                </p>
            {% else %}
                <p class="text-info nosp">
                    {{ util.make_icon('info-sign') }}
                    {% trans -%}
                        The orga team of this event may ask you for further data later, using the ‘Questionaire’.
                    {%- endtrans %}
                </p>
            {% endif %}
        {% endcall %}
        {{ util.form_input_submit(value=gettext("Register"), cancellink=cdedblink('event/show_event')) }}
    </form>
    <script type="text/javascript" nonce="{{ csp_nonce }}">
        var $form = $('#registerform');
        $form.cdedbProtectChanges();
        var checkboxes = $form.find('[type="checkbox"][name="parts"]');
        /* Map part to part selection checkbox ($-encapsulated) */
        checkbox_map = {};
        checkboxes.each(function(){
            checkbox_map[$(this).val()] = $(this);
        });
        var containers = $('.course_choice_container');
        var updateCourseChoiceContainers = function() {
            containers.each(function(){
               if (checkbox_map[$(this).attr('data-part')].prop('checked'))
                   $(this).show();
               else
                   $(this).hide();
            });
        };

        if (checkboxes.length) {
            checkboxes.change(updateCourseChoiceContainers);
            updateCourseChoiceContainers();
        }
    </script>
{% endblock %}
