{% extends "web/event/base.tmpl" %}
{% set sidenav_active='event_course_stats' %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}
    {{ util.cdedb_script('helper') }}
{% endblock %}
{% set jshint = 'weak' %}
{% block title %}Kurs {{ ambience['course']['shortname']|e }} ({{ ambience['event']['title']|e }}){% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
    {{ util.breadcrumb_link(cdedblink("event/course_stats"), "Kurse") }}
    {{ util.breadcrumb_link(cdedblink("event/show_course"), ambience['course']['shortname'], active=True, icon='book') }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        Kurs {{ ambience['course']['nr']|e }}: {{ ambience['course']['shortname']|e }}
    </h1>
    <div class="subtitle">
        {{ ambience['course']['title']|e }}
    </div>
{% endblock %}

{% block content %}
    <div class="p">
        {{ util.href(cdedblink('event/change_course_form'), "Bearbeiten", readonly=is_locked,
                     aclass="btn btn-sm btn-warning", icon="pencil") }}
        {{ util.href(cdedblink('event/manage_attendees_form'), "Kursteilnehmer verwalten", readonly=is_locked,
                     aclass="btn btn-sm btn-warning", icon="user") }}
    </div>

    <div class="row">
        <div class="col-md-6">
            <dl class="dl-horizontal">
                <dt>Kursleiter</dt><dd>{{ ambience['course']['instructors']|e }}</dd>
                <dt>Maximalgröße</dt><dd>{{ ambience['course']['max_size']|e }}</dd>
                <dt>Minimalgröße</dt><dd>{{ ambience['course']['min_size']|e }}</dd>
            </dl>

            <dl class="dl-horizontal">
                {% for field_id, field in ambience['event']['fields']|dictsort %}
                    {% if field['association'] == enums['FieldAssociations'].course %}
                        <dt>{{ field['field_name']|e }}</dt>
                        <dd>
                            {% if field['entries'] %}
                                {% for value, description in field['entries'] %}
                                    {% if ambience['course']['fields'].get(field['field_name']) == value %}
                                        {{ description|e }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% if field['kind'] == "bool" %}
                                    {{ util.deko_checkbox(
                                        checked=ambience['course']['fields'].get(field['field_name'])) }}
                                {% elif field['kind'] == "date" %}
                                    {{ ambience['course']['fields'].get(field['field_name'])
                                       |date(lang=lang, passthrough=True)|e }}
                                {% elif field['kind'] == "datetime" %}
                                    {{ ambience['course']['fields'].get(field['field_name'])
                                       |datetime(lang=lang, passthrough=True)|e }}
                                {% else %}
                                    {{ ambience['course']['fields'].get(field['field_name'])|e|linebreaks }}
                                {% endif %}
                            {% endif %}
                        </dd>
                    {% endif %}
                {% endfor %}
            </dl>
        </div>

        {% if ambience['course']['notes'] %}
            <div class="col-md-6">
                {% call util.bootstrap_panel("Orga-Notizen", icon='tag',
                                             aclass='panel panel-default panel-condensed') %}
                    {{ ambience['course']['notes']|rst }}
                {% endcall %}
            </div>
        {% endif %}
    </div>

    <h2>Teilnehmer</h2>
    <div class="row">
        {% for track_id in ambience['course']['segments']|sort %}
            {% set num_track_attendees = attendees[(ambience['course']['id'], track_id)]|length %}
            <div class="col-md-4">
                <div class="panel panel-info panel-condensed">
                    <div class="panel-heading">
                        <div class="pull-right">
                            {{ util.href(cdedblink('event/course_choices', {'track_id': track_id,
                                                                            'course_id': ambience['course']['id'],
                                                                            'position': 6,
                                                                            'submitform': True}),
                                         num_track_attendees,
                                         title="Kurswahlen der Teilnehmer") }}
                        </div>
                        <h3 class="panel-title">
                            {% if ambience['event']['tracks']|length > 1 %}
                                {{ ambience['event']['tracks'][track_id]['title']|e }}
                            {% else %}
                                Teilnehmer
                            {% endif %}
                        </h3>
                    </div>
                    <div class="panel-body">
                        {% if track_id not in ambience['course']['active_segments'] %}
                            <p class="text-danger">
                                <strong>Kurs fällt aus.</strong>
                            </p>
                        {% elif ambience['course']['min_size'] != None and
                                num_track_attendees < ambience['course']['min_size'] %}
                            <p class="text-warning">
                                <strong>Kurs hat {{ (ambience['course']['min_size'] - num_track_attendees)|e }}
                                    Teilnehmer zu wenig.</strong>
                            </p>
                        {% elif ambience['course']['max_size'] != None and
                                num_track_attendees > ambience['course']['max_size'] %}
                            <p class="text-warning">
                                <strong>Kurs hat {{ (num_track_attendees - ambience['course']['max_size'])|e }}
                                    Teilnehmer zu viel.</strong>
                            </p>
                        {% endif %}
                        <ul class="slim">
                            {% for registration_id in attendees[(ambience['course']['id'], track_id)] %}
                                <li>
                                    {{ util.href(cdedblink('event/show_registration',
                                                           {'registration_id': registration_id}),
                                                 "{} {}".format(personas[registrations[registration_id]['persona_id']]['given_names'],
                                                                personas[registrations[registration_id]['persona_id']]['family_name'])) }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    {% call util.bootstrap_panel(title="Beschreibung", icon="pushpin", aclass="panel-default panel-condensed") %}
        {{ ambience['course']['description']|rst }}
    {% endcall %}
    {% if is_removable %}
        {% call util.bootstrap_panel(title="Aktionen", icon="warning-sign", aclass="panel-danger mosp") %}
            <div class="row">
                <div class="col-sm-4">
                    <div class="p">
                        <form action="{{ cdedblink('event/delete_course')|e }}" method="POST" id="deletecourseform"
                                style="display: inline;">
                            {{ util.input_submit(value="Löschen", readonly=is_locked,
                                                 aclass="btn btn-danger", icon="folder-close") }}
                            {{ util.input_checkbox(name="ack_delete", label="sicher?") }}
                        </form>
                    </div>
                </div>
                <div class="col-sm-8">
                    <p class="text-muted">
                        Entferne den Kurs.
                    </p>
                </div>
            </div>
        {% endcall %}
        <script type="text/javascript">
            $('#deletecourseform').cdedbProtectAction("Der Kurs wird irreversibel gelöscht.");
            $('#deletecourseform').find('[name="ack_delete"]').prop('checked', true).parent().hide();
        </script>
    {% endif %}
{% endblock %}
