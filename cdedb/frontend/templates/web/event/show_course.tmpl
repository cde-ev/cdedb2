{% extends "web/event/base.tmpl" %}
{% set sidenav_active='event_course_stats' %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_helper.js') }}
{% endblock %}
{% set jshint = 'weak' %}
{% block title %}
    {% trans course=ambience['course']['shortname'], title=ambience['event']['title'] -%}
    	Course {{ course }} ({{ title }})
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
    {{ util.breadcrumb_link(cdedblink("event/course_stats"), gettext("Courses")) }}
    {{ util.breadcrumb_link(cdedblink("event/show_course"), ambience['course']['shortname'], active=True,
            icon='book') }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans nr=ambience['course']['nr'], course=ambience['course']['shortname'] -%}
            Course {{ nr }}: {{ course }}
        {%- endtrans %}
    </h1>
    <div class="subtitle">
        {{ ambience['course']['title'] }}
    </div>
{% endblock %}

{% block content %}
    <div class="p">
        {{ util.href(cdedblink('event/change_course_form'), gettext("Edit"), readonly=is_locked,
                     aclass="btn btn-sm btn-warning", icon="pencil") }}
        {{ util.href(cdedblink('event/manage_attendees_form'), gettext("Manage Attendees"), readonly=is_locked,
                     aclass="btn btn-sm btn-warning", icon="user") }}
        {{ util.href("mailto:?to=%s"|s|format("; ".join(instructor_emails)), gettext("Email to course instructors"),
                            icon="envelope", aclass="btn btn-sm btn-default", readonly=instructor_emails,
                            title=gettext("Send Mail to all course instructors.")) }}
    </div>

    <div class="row">
        <div class="col-md-6">
            <dl class="dl-horizontal">
                <dt>{% trans -%}Instructor{%- endtrans %}</dt><dd>{{ ambience['course']['instructors'] }}</dd>
                <dt>{% trans -%}Maximum Size (excl. instr.){%- endtrans %}</dt><dd>{{ ambience['course']['max_size'] }}</dd>
                <dt>{% trans -%}Minimum Size (excl. instr.){%- endtrans %}</dt><dd>{{ ambience['course']['min_size'] }}</dd>
            </dl>

            <dl class="dl-horizontal">
                {% for field_id, field in ambience['event']['fields']|keydictsort(EntitySorter.event_field) %}
                    {% if field['association'] == enums['FieldAssociations'].course %}
                        <dt>{{ field['field_name'] }}</dt>
                        <dd>
                            {% if field['entries'] %}
                                {% for value, description in field['entries'] %}
                                    {% if ambience['course']['fields'].get(field['field_name']) == value %}
                                        {{ description }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% if field['kind'] == enums['FieldDatatypes'].bool %}
                                    {{ util.deko_checkbox(
                                        checked=ambience['course']['fields'].get(field['field_name'])) }}
                                {% elif field['kind'] == enums['FieldDatatypes'].date %}
                                    {{ ambience['course']['fields'].get(field['field_name'])
                                       |date(lang=lang, passthrough=True) }}
                                {% elif field['kind'] == enums['FieldDatatypes'].datetime %}
                                    {{ ambience['course']['fields'].get(field['field_name'])
                                       |datetime(lang=lang, passthrough=True) }}
                                {% else %}
                                    {{ ambience['course']['fields'].get(field['field_name'])|linebreaks }}
                                {% endif %}
                            {% endif %}
                        </dd>
                    {% endif %}
                {% endfor %}
            </dl>
        </div>

        {% if ambience['course']['notes'] %}
            <div class="col-md-6">
                {% call util.bootstrap_panel(gettext("Orga-Notes"), icon='tag',
                                             aclass='panel panel-default panel-condensed') %}
                    {{ ambience['course']['notes']|md }}
                {% endcall %}
            </div>
        {% endif %}
    </div>

    <h2>{% trans -%}Attendees{%- endtrans %}</h2>
    <div class="row">
        {% for track_id, track in ambience['event']['tracks']|keydictsort(EntitySorter.course_track)
                if track_id in ambience['course']['segments'] %}
            {% set num_track_attendees = attendees[(ambience['course']['id'], track_id)]|length %}
            <div class="col-md-4">
                <div class="panel panel-info panel-condensed">
                    <div class="panel-heading">
                        <div class="pull-right">
                            {{ util.href(cdedblink('event/course_choices', {
                                             'track_id': track_id,
                                             'course_id': ambience['course']['id'],
                                             'position': enums.CourseFilterPositions.assigned.value,
                                             'submitform': True}),
                                         num_track_attendees,
                                         title=gettext("Participantsâ€™ Course Choices")) }}
                        </div>
                        <h3 class="panel-title">
                            {% if ambience['event']['tracks']|length > 1 %}
                                {{ track['title'] }}
                            {% else %}
                                {% trans -%}Attendees{%- endtrans %}
                            {% endif %}
                        </h3>
                    </div>
                    <div class="panel-body">
                        {% if track_id not in ambience['course']['active_segments'] %}
                            <p class="text-danger">
                                <strong>{% trans -%}Course is cancelled{%- endtrans %}</strong>
                            </p>
                        {% elif ambience['course']['min_size'] != None and
                                num_track_attendees < ambience['course']['min_size'] %}
                            <p class="text-warning">
                                <strong>
                                    {% trans count=(ambience['course']['min_size'] - num_track_attendees) -%}
                                        Course has {{ count }} attendees too few.
                                    {%- endtrans %}</strong>
                            </p>
                        {% elif ambience['course']['max_size'] != None and
                                num_track_attendees > ambience['course']['max_size'] %}
                            <p class="text-warning">
                                <strong>
                                    {% trans count=(num_track_attendees - ambience['course']['max_size']) -%}
                                    	Course has {{ count }} attendees too many.
                                    {%- endtrans %}</strong>
                            </p>
                        {% endif %}
                        <ul class="slim">
                            {% for registration_id in attendees[(ambience['course']['id'], track_id)] %}
                                <li>
                                    {{ util.href(cdedblink('event/show_registration',
                                                           {'registration_id': registration_id}),
                                                 "{} {}".format(personas[registrations[registration_id]
                                                        ['persona_id']]['given_names'],
                                                                personas[registrations[registration_id]
                                                        ['persona_id']]['family_name'])) }}
                                    {% if registrations[registration_id]['tracks'][track_id]['course_instructor']
                                            == ambience['course']['id'] %}
                                        ({% trans %}Instr.{% endtrans %})
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    {% call util.bootstrap_panel(title=gettext("Description"), icon="pushpin", aclass="panel-default panel-condensed") %}
        {{ ambience['course']['description']|md }}
    {% endcall %}
    {% call util.bootstrap_panel(title=gettext("Course Logo"), icon="picture") %}
        {% if logo_present %}
            <embed src="{{ cdedblink('event/get_course_logo') }}#view=Fit&scrollbar=0&toolbar=0"
                   type="application/pdf" width="150px" height="150px" />
            <form action="{{ cdedblink('event/set_course_logo') }}" method="POST"
                    id="removecourselogoform">
                {{ util.anti_csrf_token('event/set_course_logo') }}
                {{ util.input_hidden(name="delete", value=True) }}
                {{ util.input_checkbox("logo_ack_delete", label=gettext("Are you sure?")) }}
                {{ util.input_submit(value=gettext("Remove Logo"), readonly=is_locked,
                                     icon='trash', aclass='btn btn-danger') }}
            </form>
            <script type="text/javascript" nonce="{{ csp_nonce }}">
                $('#removecourselogoform').cdedbProtectAction("{{ gettext("The course logo will be permanently deleted.") }}");
                $('#removecourselogoform').find('[name="logo_ack_delete"]').prop('checked', true).parent().hide();
            </script>
        {% else %}
            {% trans -%}No logo set.{%- endtrans %}
        {% endif %}
        <form action="{{ cdedblink('event/set_course_logo') }}" method="POST" enctype="multipart/form-data"
              id="setcourselogoform" {% if "course_logo" in errors %}class="has-error"{% endif %}>
            {{ util.anti_csrf_token('event/set_course_logo') }}
            {{ util.input_hidden(name="delete", value=False) }}
            <div class="input-group">
                <p>
                    {% trans -%}
                        This functionality is deprecated and will be removed soon.
                        Do not use it anymore.
                    {%- endtrans %}
                </p>
                {{ util.input_file(name="course_logo", accept="image/*") }}
                <div class="input-group-btn">
                    {{ util.input_submit(value=gettext("Upload"), readonly=is_locked, icon='upload') }}
                </div>
            </div>
            {{ util.output_errors("course_logo") }}
        </form>
    {% endcall %}
    {% call util.bootstrap_panel(title=gettext("Actions"), icon="warning-sign", aclass="panel-danger mosp") %}
        <div class="row">
            <div class="col-sm-4">
                <div class="p">
                    <form action="{{ cdedblink('event/delete_course') }}" method="POST" id="deletecourseform"
                            style="display: inline;">
                        {{ util.anti_csrf_token('event/delete_course') }}
                        {{ util.input_submit(value=gettext("Delete"), readonly=is_locked or blockers,
                                             aclass="btn btn-danger", icon="trash", title=gettext("Course still has attendees.") if "attendees" in blockers else "" ) }}
                        {{ util.input_checkbox(name="ack_delete", label=gettext("Are you sure?")) }}
                    </form>
                </div>
            </div>
            <div class="col-sm-8">
                <p class="text-muted">
                    {% trans -%}Delete the Course.{%- endtrans %}
                </p>
            </div>
        </div>
    {% endcall %}
    <script type="text/javascript" nonce="{{ csp_nonce }}">
        $('#deletecourseform').cdedbProtectAction("{{ gettext("The course will be permanently deleted.") }}");
        $('#deletecourseform').find('[name="ack_delete"]').prop('checked', true).parent().hide();
    </script>
{% endblock %}
