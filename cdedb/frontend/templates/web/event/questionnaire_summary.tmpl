{% set sidenav_active='event_quest_summary' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% set jshint='strong' %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_helper.js') }}
    {{ util.cdedb_script('cdedb_dynamicrow.js') }}
    {{ util.cdedb_script('cdedb_questionnaire_config.js') }}
{% endblock %}
{% block title %}
    {% trans title=ambience['event']['title'] %}
    	Configure Questionnaire ({{ title }})
    {% endtrans %}
{% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
    {{ util.breadcrumb_link(cdedblink("event/questionnaire_summary"), gettext("Configure Questionnaire"), active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans %}Configure Questionnaire{% endtrans %}
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title'] }}</small>
    </h1>
{% endblock %}

{# Macro for a general questionnaire part, that can have each role in the DynamicRow workflow.
   aclass is used to pass classes to the row, such as drow-row, drow-prototype, drow-new
   newrow rows will have 'create' instead of 'delete' checkbox and have 'data-basename' attributes #}
{% macro print_part(part_id, kind, aclass="", newrow=False) %}
    <div class="panel panel-default {{ aclass }}">
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    {{ util.form_input_text(name="title_{}".format(part_id), label=gettext("Title"),
                                            attributes=('data-basename="title_"'|s if newrow else ''),
                                            aclass='input-title drow-input', horizontal=false) }}
                    {{ util.form_input_textarea(name="info_{}".format(part_id), label=gettext("Text"),
                                                attributes=('data-basename="info_"'|s if newrow else ''),
                                                aclass='input-info drow-input', horizontal=false,
                                                info=gettext("Supports %(infolink)s for “Text-Only” fields.")|format(
                                                    infolink=util.href(docurl("Handbuch_Markdown"),
                                                                       gettext("Markdown"),
                                                                       title=gettext("Short Markdown summary")))|s) }}
                </div>
                <div class="col-md-6">
                    {{ util.form_input_select("field_id_{}".format(part_id), label=gettext("Query"),
                                              entries=registration_fields|keydictsort(EntitySorter.event_field)|dict_entries('id', 'field_name'),
                                              nulloption=gettext("— Only Text —"),
                                              attributes=('data-basename="field_id_"'|s if newrow else ''),
                                              aclass='input-field drow-input', horizontal=False) }}
                    {{ util.form_input_select(
                        "input_size_{}".format(part_id), label=gettext("Input Size"), entries=(
                            (0, gettext("singleline")), (1, gettext("multiline")),
                            (2, gettext("multiline") + "+"), (3, gettext("multiline") + "++")),
                        attributes=('data-basename="input_size_"'|s if newrow else ''),
                        aclass='input-inputsize drow-input', horizontal=False) }}
                    {{ util.form_input_textarea(
                        "default_value_{}".format(part_id), label=gettext("Default Value"), rows=2,
                        attributes=('data-basename="default_value_"'|s if newrow else ''),
                        aclass='input-defaultvalue drow-input', horizontal=False) }}
                    {{ util.form_input_select(
                        "kind_{}".format(part_id), label=gettext("Usage"), entries=enums['QuestionnaireUsages']|enum_entries,
                        attributes=('data-basename="kind_"'|s if newrow else ''),
                        aclass='input-usage drow-input', horizontal=False, defaultvalue=kind.value) }}
                    <div class="form-group row">
                        <div class="col-sm-8">
                            {% if kind.allow_readonly() %}
                                <div class="checkbox">
                                    {{ util.input_checkbox("readonly_{}".format(part_id), label=gettext("read-only"),
                                                           attributes=('data-basename="readonly_"'|s if newrow else ''),
                                                           aclass='input-readonly drow-input') }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-sm-4 text-right">
                            <span class="drow-buttonspace">
                                {% if newrow %}
                                    {{ util.input_checkbox("create_{}".format(part_id), label=gettext("Add"),
                                                           attributes='data-basename="create_"'|s,
                                                           aclass='drow-indicator') }}
                                {% else %}
                                    {{ util.input_checkbox("delete_{}".format(part_id), label=gettext("Remove"),
                                                           aclass='drow-indicator') }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endmacro %}

{% block content %}
    <div class="p">
        {{ util.href(cdedblink('event/reorder_questionnaire_form'), gettext("Reorder Questionnaire"), readonly=is_locked,
                     aclass="btn btn-info btn-sm", icon='sort') }}
        {{ util.href(cdedblink('event/questionnaire', {"preview": True}), gettext("Preview Questionnaire"),
                     aclass="btn btn-info btn-sm", icon='edit') }}
    </div>
    <form action="{{ cdedblink('event/questionnaire_summary') }}" method="POST" id="questionnairesummaryform">
        {{ util.anti_csrf_token('event/questionnaire_summary') }}
        <div class="tab-content" id="usages_tabcontent">
            {% for kind in enums['QuestionnaireUsages'] %}
                <div class="tab-pane active" role="tabpanel" id="tab_{{ kind.name }}"
                        data-kind-id="{{ kind.value }}">
                    <h3 class="heading-underline">{{ util.make_icon(kind.get_icon()) }} {{ gettext(kind|string) }}</h3>
                        {# Old items, already stored in the database #}
                    {% for entry in questionnaire %}
                        {% if entry['kind'] == kind %}
                            {{ print_part(loop.index0, kind, aclass='drow-row') }}
                        {% endif %}
                    {% endfor %}

                    {# Items that were added by the user but failed validation. They are still new and have no official id. #}
                    {% for i in range(1, values.get('create_last_index', 0) + 1) %}
                        {% if values.get("kind_{}".format(-i), '')|int == kind.value %}
                            {{ print_part(-i, kind, aclass='drow-new', newrow=True) }}
                        {% endif %}
                    {% endfor %}
                    {# Prototype row. For non-JS users: an empty row with 'create'-checkbox, for JS: prototype for new rows. #}
                    {{ print_part(-values.get('create_last_index', 0) - 1, kind, aclass='drow-prototype', newrow=True) }}
                    <p>
                        <button type="button" class="btn btn-success softhide pull-right" id="drow-addbutton-{{ kind.name }}">
                            {{ util.make_icon('plus') }} {% trans %}Add Part{% endtrans %}
                        </button>
                    </p>
                </div>
            {% endfor %}
        </div>
        {{ util.input_submit(value=gettext("Save"), readonly=is_locked) }}
    </form>
    <script type="text/javascript" nonce="{{ csp_nonce }}">
        (function() {
            var field_list = {{ registration_fields|json|s }};
            var translations = {
                'true': "{{ gettext("true") }}",
                'false': "{{ gettext("false") }}"};
            {% for kind in enums['QuestionnaireUsages'] %}
                $('#tab_{{ kind.name }}').cdedbDynamicRow(
                    {
                        addButton: $('#drow-addbutton-{{ kind.name }}'),
                        callback: function () {
                            $(this).cdedbQuestionnaireConfig(field_list, translations);
                        },
                        delButtonTitle: "{{ gettext("Delete Questionnaire Part") }}"
                    });
            {% endfor %}
            $('#questionnairesummaryform').cdedbProtectChanges();
            $('.drow-row').cdedbQuestionnaireConfig(field_list, translations);
        })()
    </script>
{% endblock %}
