{% set sidenav_active='event_registration' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% import "web/generic.tmpl" as generic with context %}
{% set jshint='strong' %}
{% block scripts %}{{ util.cdedb_script('cdedb_queryform.js') }}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% block title %}
    {% trans title=ambience['event']['title'] %}
    	Registrations ({{ title }})
    {% endtrans %}
{% endblock %}
{% block heading %}
    {{ util.context_heading(gettext("Registrations"), ambience['event']['title'],
                            'chalkboard-teacher', gettext("Event")) }}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="chalkboard-teacher") }}
{{ util.breadcrumb_link(cdedblink("event/registration_query"), gettext("Registrations"), active=True) }}
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-4">
            <div class="p button-par">
                {{ util.href(cdedblink("event/add_registration_form"), gettext("Add Registration"),
                             readonly=is_locked, icon='plus', aclass='btn btn-sm btn-success') }}
                {% if ambience['event']['fields'] and has_registrations %}
                    {{ util.href(cdedblink("event/field_set_select", {'kind': enums['FieldAssociations'].registration.value}), gettext("Set Field"),
                                  readonly=is_locked, icon='edit', aclass='btn btn-sm btn-warning') }}
                {% endif %}
                {{ util.href(cdedblink("event/custom_filter_summary", {'scope': enums['QueryScope'].registration}), gettext("Custom Filters"), icon="filter", aclass="btn btn-sm btn-info") }}
            </div>
        </div>
        <div class="col-md-8">
            {{ generic.place_default_queries(enums['QueryScope'].registration, default_queries) }}
        </div>
    </div>

    {{ generic.format_query(enums['QueryScope'].registration, spec,
                            selection_default=('persona.username', 'persona.family_name', 'persona.given_names')) }}

    {% if values['is_search'] %}
        <h3 id="query-results">{% trans %}Result{% endtrans %} [{{ result|length }}]</h3>
        <!-- Additional buttons for the registration_query -->

        <div class="p">
            {% if "persona.username" in query.fields_of_interest %}
                    {% set usernames = [] %}
                {% for entry in result if "persona.username" in entry and entry["persona.username"] %}
                    {% do usernames.append(entry["persona.username"]) %}
                {% endfor %}
                {{ util.href(util.mailto(address="", bcc=";".join(usernames)), gettext("bcc email to all"),
                             icon="envelope", aclass="btn btn-default",
                             title=gettext("Send Mail to all registrations listed below as BCC.")) }}
                {{ util.href(util.mailto(";".join(usernames)), gettext("email to all"),
                             icon="envelope", aclass="btn btn-default",
                             title=gettext("Send Mail to all registrations listed below.")) }}
            {% else %}
                {{ util.href("#", gettext("bcc email to all"), readonly=True,
                             icon="envelope", aclass="btn btn-default",
                             title=gettext("Email button is only available, if the email field is shown.")) }}
                {{ util.href("#", gettext("email to all"), readonly=True,
                             icon="envelope", aclass="btn btn-default",
                             title=gettext("Email button is only available, if the email field is shown.")) }}
            {% endif %}
        </div>

        <div class="p pull-right query-result-dynamic-actions" style="display: none;">
            {% if ambience['event'].tracks %}
                {{ generic.query_result_dynamic_action(
                        label=gettext("Course Assignments"), icon="crosshairs", aclass="btn-info",
                        target="event/course_choices_form", params={"include_active": True},
                        magic_placeholders=["ids"]) }}
            {% endif %}
            {% if ambience['event'].personalized_fees %}
                {{ generic.query_result_dynamic_action(
                        label=gettext("Set Personalized Fee Amount"), icon="edit",
                        target="event/set_personalized_fees_form", magic_placeholders=["registration_ids"]) }}
            {% endif %}
            {{ generic.query_result_dynamic_action(
                    label=gettext("Set Field"), icon="edit", target="event/field_set_select",
                    params={"kind": enums['FieldAssociations'].registration}, magic_placeholders=["ids"]) }}
            {{ generic.query_result_dynamic_action(
                    label=gettext("Edit"), icon="pen", target="event/change_registrations_form",
                    magic_placeholders=["reg_ids"]) }}
        </div>

        {{ generic.display_query_result(result, aggregates, query) }}

    {% endif %}
{% endblock %}
