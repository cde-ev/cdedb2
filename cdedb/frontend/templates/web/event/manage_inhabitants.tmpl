{% set sidenav_active='event_lodgements' %}
{% extends "web/event/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('manage_participants') }}{% endblock %}
{% set jshint='strong' %}
{% block title %}
    {% trans lodgement=ambience['lodgement']['moniker'], title=ambience['event']['title'] -%}
    	Manage Inhabitants of Lodgement {{ lodgement }} ({{ title }})
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
    {{ util.breadcrumb_link(cdedblink("event/lodgements"), gettext("Lodgements")) }}
    {{ util.breadcrumb_link(cdedblink("event/show_lodgement"), ambience['lodgement']['moniker'], icon='home') }}
    {{ util.breadcrumb_link(cdedblink("event/manage_inhabitants"), gettext("Manage Inhabitants"), active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans lodgement=ambience['lodgement']['moniker']-%}
        	Inhabitants of {{ lodgement }}
        {%- endtrans %}
        <small>{{ util.make_icon('blackboard', arialabel="Veranstaltung") }} {{ ambience['event']['title'] }}</small>
    </h1>
{% endblock %}
{% block content %}
    <form action="{{ cdedblink('event/manage_inhabitants') }}" method="POST" id="manageinhabitantsform">
        <div class="row">
            {% for part_id, part in ambience['event']['parts']|xdictsort('part_begin') %}
                <div class="col-md-6">
                    {% call util.bootstrap_panel(title=(part['title'] if ambience['event']['parts']|length > 1
                                                                      else gettext("Assigned Inhabitants")),
                                                 aclass="panel-info") %}
                        <table class="table table-condensed">
                            <tbody>
                            {% for registration_id in inhabitants[(ambience['lodgement']['id'], part_id)] %}
                                <tr>
                                    <td>
                                        {{ personas[registrations[registration_id]['persona_id']]['given_names'] }}
                                        {{ personas[registrations[registration_id]['persona_id']]['family_name'] }}
                                    </td>
                                    <td>
                                        &ensp;{{ util.input_checkbox('reserve_%s_%s'|format(part_id, registration_id), gettext("Camping Mat")) }}
                                    </td>
                                    <td>
                                        &ensp;{{ util.input_checkbox('delete_%s_%s'|format(part_id, registration_id), gettext("Remove"),
                                                                aclass="del-box") }}
                                    </td>
                                </tr>
                            {% else %}
                                <tr class="text-muted"><td>{% trans -%}The are currently no inhabitants assigned.{%- endtrans %}</td></tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        <label for="input_new_{{ part_id }}">
                            {{ util.make_icon('plus') }} {% trans -%}Add Inhabitant{%- endtrans %}
                        </label>
                        <select multiple="multiple" id="input_new_{{ part_id }}" class="form-control"
                                name="new_{{ part_id }}">
                            <option value="">{% trans -%}– none –{%- endtrans %}</option>
                            {% for registration_id in without_lodgement[part_id] %}
                                <option id="{{ registration_id }}_{{ part_id }}" value="{{ registration_id }}">
                                    {{ personas[registrations[registration_id]['persona_id']]['given_names'] }}
                                    {{ personas[registrations[registration_id]['persona_id']]['family_name'] }}
                                </option>
                            {% endfor %}
                        </select>
                    {% endcall %}
                </div>
            {% endfor %}
            <script type="text/javascript">
                var lodgement_names = {{ lodgement_names|json|s }};
                {% for part_id in ambience['event']['parts'] %}
                    $('#input_new_{{ part_id }}').cdedbSearchParticipant(
                        {{ selectize_data[part_id]|json|s }}, lodgement_names, "{{ gettext("currently") }}: ");
                {% endfor %}
                $('.del-box').cdedbRemoveParticipantButton('{{ gettext("Remove Inhabitant") }}');
            </script>
        </div>
        {{ util.input_submit(value=gettext("Save")) }}&emsp;
        {{ util.href(cdedblink('event/show_lodgement'), gettext("Cancel"), icon='remove', aclass="btn btn-default") }}
    </form>
{% endblock %}
