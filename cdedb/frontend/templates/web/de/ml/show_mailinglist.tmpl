{% set sidenav_active='ml_show' %}
{% extends "web/de/ml/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block title %}{{ ambience['mailinglist']['title']|e }}{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("ml/index"), "Mailinglisten") }}
{{ util.breadcrumb_link(cdedblink("ml/show_mailinglist"), ambience['mailinglist']['title'], icon="envelope",
        active=True) }}
{% endblock %}
{% block content %}
    {% if ambience['mailinglist']['gateway'] %}
        <div class="subtitle">
            Mailingliste für Abonnenten von
            {% if gateway['is_active'] or is_admin %}
                {{ util.href(cdedblink('ml/show_mailinglist',{'mailinglist_id': gateway['id']}), gateway['title'],
                        icon='envelope')}}
            {% else %}
                {{ util.make_icon('envelope') }} {{ gateway['title']|e }}
            {% endif %}
        </div>
    {% endif %}
    {% if ambience['mailinglist']['event_id'] %}
        <div class="subtitle">
            Mailingliste zur Veranstaltung
            {# TODO: only link if (event is open or user is orga and event is not archived) or user is event admin #}
            {% if 'event' in user.roles %}
                {{ util.href(cdedblink('event/show_event',{'event_id':event['id']}), event['title'],
                        icon='blackboard')}}
            {% else %}
                {{ util.make_icon('blackboard') }} {{ event['title']|e }}
            {% endif %}
        </div>
    {% endif %}
    {% if ambience['mailinglist']['assembly_id'] %}
        <div class="subtitle">
            Mailingliste zur Versammlung
            {% if 'assembly' in user.roles and assembly['is_active'] or 'assembly_admin' in user.roles %}
                {{ util.href(cdedblink('assembly/show_assembly',{'assembly_id':assembly['id']}), assembly['title'],
                        icon='bullhorn')}}
            {% else %}
                {{ util.make_icon('bullhorn') }} {{ assembly['title']|e }}
            {% endif %}
        </div>
    {% endif %}

    <dl class="dl-horizontal">
        <dt>Listen-Adresse</dt>
        <dd>{{ util.href('mailto:' + ambience['mailinglist']['address']|e, ambience['mailinglist']['address']) }}</dd>
        <dt>Moderatoren</dt>
        <dd>
            {% for moderator in ambience['mailinglist']['moderators'] %}
                {{ util.persona_anchor(personas[moderator]) }}{% if not loop.last %},{% endif %}
            {% endfor %}
        </dd>
    </dl>

    {{ ambience['mailinglist']['description']|rst }}

    {% if not ambience['mailinglist']['is_active'] %}
        <p class="text-warning"><strong>Diese Liste ist nicht mehr aktiv.</strong></p>
    {% else %}
        <div class="panel {% if is_subscribed %}panel-success{% else %}panel-default{% endif %}">
            <div class="panel-heading">
                <h3 class="panel-title">Dein Abonnement</h3>
            </div>
            <div class="panel-body">
                {% if is_subscribed %}
                    <p class="text-success"><strong>Du hast diese Mailingliste abonniert.</strong></p>
                    <dl class="dl-horizontal">
                        <dt>Deine Adresse</dt>
                        <dd>
                            {% if sub_address %}
                                {{ sub_address|e }}
                            {% else %}
                                {{ user.username|e }} (default)
                            {% endif %}
                        </dd>
                    </dl>
                    {% if may_toggle %}
                        <div class="p">
                            <form action="{{ cdedblink('ml/change_address')|e }}" method="POST" id="resetaddressform"
                                    style="display: inline;">
                                {{ util.input_hidden(name="email", value="") }}
                                {{ util.input_submit(value="Adresse zurücksetzen", icon="share-alt",
                                        aclass="btn btn-warning btn-sm") }}
                            </form>
                            <form action="{{ cdedblink('ml/subscribe_or_unsubscribe')|e }}" method="POST"
                                    id="unsubscribeform" style="display: inline;">
                                {{ util.input_hidden(name="subscribe", value=False) }}
                                {{ util.input_submit(value="Liste abbestellen", aclass="btn btn-danger btn-sm",
                                        icon="remove") }}
                            </form>
                        </div>

                        <h4 class="mosp">Adresse ändern</h4>
                        <p class="text-muted">
                            {{ util.make_icon('info-sign') }} Um Mails dieser Mailingliste an eine andere
                            E-Mail-Adresse zu erhalten, trage die neue Adresse ins folgende Formular ein. Nach dem
                            Absenden erhältst Du eine E-Mail an diese Adresse, mit der Du Deinen Besitz der Adresse
                            bestätigen kannst.
                        </p>
                        <form action="{{ cdedblink('ml/change_address')|e }}" method="POST" id="changeaddressform">
                            <label for="input-new-adress" class="sr-only">Neue Abonnement-Adresse</label>
                            <div class="input-group">
                                {{ util.input_text(name="email", type="email", placeholder="new-address@example.com",
                                        anid="input-new-adress") }}
                                <div class="input-group-btn">{{ util.input_submit(value="Adresse ändern") }}</div>
                            </div>
                        </form>
                    {% endif %}
                {% else %}
                    {% if may_toggle %}
                        <p><strong>Du bist zurzeit kein Abonnent dieser Mailingliste.</strong></p>
                        <form action="{{ cdedblink('ml/subscribe_or_unsubscribe')|e }}" method="POST" id="subscribeform">
                            <div>
                                {{ util.input_hidden(name="subscribe", value=True) }}
                                {{ util.input_submit(value="Abonnieren", aclass="btn btn-sm btn-success") }}
                            </div>
                        </form>
                    {% else %}
                        <p>
                            Du kannst diese Mailingliste nicht abonnieren, da Du nicht Teil ihres Adressatenkreises
                            bist.
                        </p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}
