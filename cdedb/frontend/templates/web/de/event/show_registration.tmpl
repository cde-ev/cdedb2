{% set sidenav_active='event_registration' %}
{% extends "web/de/event/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block title %}
Anmeldung von {{ persona['given_names']|e }} {{ persona['family_name']|e }} ({{ ambience['event']['title']|e }})
{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("event/index"), "Veranstaltungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/registration_query"), "Anmeldungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_registration"),
    persona['given_names']|e + " " + persona['family_name']|e, active=True, icon="user") }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {{ persona['given_names']|e }} {{ persona['family_name']|e }}
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title']|e }}</small>
    </h1>
{% endblock %}
{% block content %}
    <div class="p">
        {{ util.href(cdedblink("event/change_registration_form"), "Bearbeiten", readonly=is_locked,
                     aclass="btn btn-warning btn-sm", icon="pencil") }}
    </div>
    <h3 class="heading-underline">Personendaten</h3>
    <dl class="dl-horizontal">
        <dt>Name</dt>
        <dd>
            {{ persona['title']|e }}
            {{ persona['given_names']|e }}
            {{ persona['family_name']|e }}
            {{ persona['name_supplement']|e }}
        </dd>
        <dt>CdEDB-ID</dt>
        <dd>{{ util.href(show_user_link(persona['id']), persona['id']|cdedbid) }}</dd>
        {% if ambience['registration']['real_persona_id'] %}
            <dt>Online CdEDB-ID</dt>
            <dd>{{ ambience['registration']['real_persona_id']|cdedbid|e }}</dd>
        {% endif %}
        <dt>CdE-Mitglied</dt>
        <dd>{{ util.deko_checkbox(checked=(persona['is_member'])) }}</dd>
        <dt>Geburtstag</dt>
        <dd>
            {{ persona['birthday']|date|e }} (<em>{{ gettext(age|string)|e }}</em>)
        </dd>
        <dt>Geschlecht</dt>
        <dd>{{ persona['gender']|gender|e }}</dd>
    </dl>
    <dl class="dl-horizontal">
        <dt>E-Mail</dt>
        <dd>{{ persona['username']|e }} </dd>
        <dt>Telefon</dt>
        <dd>{{ persona['telephone']|e }}</dd>
        <dt>Mobiltelefon</dt>
        <dd>{{ persona['mobile']|e }}</dd>
    </dl>
    <dl class="dl-horizontal">
        <dt>Straße</dt>
        <dd>{{ persona['address']|e }}</dd>
        <dt>Adresszusatz</dt>
        <dd>{{ persona['address_supplement']|e }}</dd>
        <dt>Stadt</dt>
        <dd>{{ persona['postal_code']|e }} {{ persona['location']|e }}</dd>
        <dt>Land</dt>
        <dd>{{ persona['country']|e }}</dd>
    </dl>
    {% if persona['id'] in ambience['event']['orgas'] %}
    <p class="text-info">
        {{ persona['given_names']|e }} ist Orga dieser Veranstaltung.
    </p>
    {% endif %}

    {% call util.bootstrap_panel(title="Orga-Notizen", icon="tag",
                                 aclass="panel-default panel-condensed") %}
        {{ ambience['registration']['orga_notes']|rst }}
    {% endcall %}

    <h3 class="heading-underline">Status</h3>
    <dl class="dl-horizontal">
        <dt>Teilnehmerbeitrag</dt>
        <dd>
            {% if ambience['registration']['payment'] %}
                bezahlt am {{ ambience['registration']['payment'] |date|e }}
            {% else %}
                <em>ausstehend</em>
            {% endif %}
        </dd>

        <dt>Einverständniserklärung der Eltern</dt>
        <dd>
            {% if not age.is_minor() %}
                <em>volljährig</em>
            {% else %}
                {{ util.deko_checkbox(checked=ambience['registration']['parental_agreement']) }}
            {% endif %}
        </dd>

        <dt>Eingecheckt</dt>
        <dd>
            {% if ambience['registration']['checkin'] %}
                bezahlt am {{ ambience['registration']['checkin'] |date|e }}
            {% else %}
                —
            {% endif %}
        </dd>
    </dl>

    <div class="row">
        {% for part_id, part in ambience['event']['parts']|dictsort %}
            <div class="col-md-6">
                {% if ambience['event']['parts']|length > 1 %}
                    <h4>{{ part['title']|e }}</h4>
                {% endif %}
                <dl class="dl-horizontal">
                    <dt>Status</dt>
                    <dd>
                        {{ gettext(ambience['registration']['parts'][part_id]['status']
                                |enum(enums['RegistrationPartStati']))|e }}
                    </dd>
                    {% if enums['RegistrationPartStati'](ambience['registration']['parts'][part_id]['status'])
                            .is_involved() %}
                        <dt>Kurs</dt>
                        <dd>
                            {% if ambience['registration']['parts'][part_id]['course_id'] %}
                                {{ courses[ambience['registration']['parts'][part_id]['course_id']]['nr']|e }}.
                                {{ courses[ambience['registration']['parts'][part_id]['course_id']]['shortname']|e }}
                        {% else %}
                            —
                            {% endif %}
                        </dd>
                    {% endif %}
                    <dt>Unterkunft</dt>
                    <dd>
                        {% if ambience['registration']['parts'][part_id]['lodgement_id'] %}
                            {{ lodgements[ambience['registration']['parts'][part_id]['lodgement_id']]['moniker']|e }}
                        {% else %}
                            —
                        {% endif %}
                    </dd>
                </dl>
            </div>
        {% endfor %}
    </div>

    <h3 class="heading-underline">Anmeldedaten</h3>
        <dl class="dl-horizontal">
            <dt>Gemischte Unterbringung</dt>
            <dd>
                {{ util.deko_checkbox(checked=ambience['registration']['mixed_lodging']) }}
            </dd>
            <dt>Foto-Einwilligung</dt>
            <dd>
                {{ util.deko_checkbox(checked=ambience['registration']['foto_consent']) }}
            </dd>
        </dl>
        <h4>Kurswahl</h4>
        <div class="row">
            {% for part_id, part in ambience['event']['parts']|dictsort %}
                <div class="col-md-6">
                    {% if ambience['event']['parts']|length > 1 %}
                        <h5>{{ part['title']|e }}</h5>
                    {% endif %}

                    <dl class="dl-horizontal">
                        <dt>Kursleiter von</dt>
                        <dd>
                            {% if ambience['registration']['parts'][part_id]['course_instructor'] %}
                                {{ courses[ambience['registration']['choices'][part_id][loop.index0]]['nr']|e }}.
                                {{ courses[ambience['registration']['choices'][part_id][loop.index0]]['shortname']|e }}
                            {% else %}
                                —
                            {% endif %}
                        </dd>
                        {% for prio in ("Erstwahl", "Zweitwahl", "Drittwahl",) %}
                            <dt>{{ prio|e }}</dt>
                            <dd>
                                {% if ambience['registration']['choices'].get(part_id, [])|length > loop.index0  %}
                                    {{ courses[ambience['registration']['choices'][part_id][loop.index0]]['nr']|e }}.
                                    {{ courses[ambience['registration']['choices'][part_id][loop.index0]]['shortname']|e }}
                                {% endif %}
                            </dd>
                        {% endfor %}
                    </dl>
                </div>
            {% endfor %}
        </div>
    {% call util.bootstrap_panel(title="Anmerkungen", aclass="panel-default panel-condensed") %}
        {{ ambience['registration']['notes']|rst }}
    {% endcall %}

    {% if ambience['event']['fields']|length > 0 %}
        <h3 class="heading-underline">Datenfelder</h3>
        <dl class="dl-horizontal">
            {% for field_id, field in ambience['event']['fields']|dictsort %}
                {% if field['association'] == enums['FieldAssociations'].registration %}
                    <dt>{{ field['field_name']|e }}</dt>
                    <dd>
                        {% if field['entries'] %}
                            {% for value, description in field['entries'] %}
                                {% if ambience['registration']['fields'].get(field['field_name']) == value %}
                                    {{ description|e }}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% if field['kind'] == "bool" %}
                                {{ util.deko_checkbox(
                                    checked=ambience['registration']['fields'].get(field['field_name'])) }}
                            {% elif field['kind'] == "date" %}
                                {{ ambience['registration']['fields'].get(field['field_name'])|date(passthrough=True)|e }}
                            {% elif field['kind'] == "datetime" %}
                                {{ ambience['registration']['fields'].get(field['field_name'])|datetime(passthrough=True)|e }}
                            {% else %}
                                {{ ambience['registration']['fields'].get(field['field_name'])|e|linebreaks }}
                            {% endif %}
                        {% endif %}
                    </dd>
                {% endif %}
            {% endfor %}
        </dl>
    {% endif %}
{% endblock %}
