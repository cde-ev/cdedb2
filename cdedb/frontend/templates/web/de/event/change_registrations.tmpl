{% set sidenav_active='event_registration' %}
{% extends "web/de/event/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('helper') }}{% endblock %}
{% set jshint='weak' %}
{% block title %}
Anmeldungen bearbeiten ({{ ambience['event']['title']|e }})
{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("event/index"), "Veranstaltungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/registration_query"), "Anmeldungen") }}
{{ util.breadcrumb_link(cdedblink("event/change_registrations_form"), "Bearbeiten", active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        Anmeldungen bearbeiten
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title']|e }}</small>
    </h1>
{% endblock %}

{% macro output_name(persona) %}
    {{ persona['title']|e }}
    {{ persona['given_names']|e }}
    {{ persona['family_name']|e }}
    {{ persona['name_supplement']|e }}
{% endmacro %}
{% macro form_input_optional(name='', label='', anid='', info='') %}
    <div class="form-group {% if name in errors %}has-error{% endif %}">
        {% if label %}
            <label{% if anid %} for="{{ anid|e }}"{% endif %} class="col-sm-4 control-label">
                {{ label|e }}
            </label>
        {% endif %}
        <div class="col-sm-1 text-center {% if not label %}col-sm-offset-4{% endif %}">
            <div class="checkbox" title="{% if label %}'{{ label|e }}'{% else %}Dieses Feld{% endif %} überschreiben">
                <label>
                    <input type="checkbox" name="enable_{{ name|e }}" value="True" class="enable-input"
                           {% if anid %}id="enable_{{ anid|e }}" data-input="{{ anid|e }}"{% endif %}
                           {% if values.get("enable_{}".format(name), False) %}checked="checked"{% endif %} />
                </label>
            </div>
        </div>
        <div class="col-sm-7">
            {{ caller() }}
            {{ util.output_errors(name) }}
            {{ util.output_info(info) }}
        </div>
    </div>
{% endmacro %}

{% block content %}
    {{ util.output_info("Alle Felder, die mit einem Häkchen markiert sind, werden in allen Anmeldungen mit dem "
                        "eingestellten Wert überschrieben. Felder, die schon jetzt bei allen Anmeldungen "
                        "übereinstimmen, sind vorausgewählt.") }}

    <form action="{{ cdedblink('event/change_registrations')|e }}" method="POST" id="changeregistrationform"
          class="form-horizontal">
        {{ util.input_hidden("reg_ids", value=registrations.keys()|join(',')) }}
        <h3 class="heading-underline">Anmeldungen</h3>
        {% call util.form_input_general(label="Name", displayerrors=False) %}
            {% for reg_id, reg in registrations|dictsort %}
                {{ util.input_static(value=output_name(personas[reg['persona_id']])) }}
            {% endfor %}
        {% endcall %}

        {% if values['enable_reg.gender'] %}
            {{ util.form_input_static(label="Geschlecht", value=gettext(enums['Genders'](values['reg.gender'])|string)|e) }}
        {% else %}
            {{ util.form_input_static(label="Geschlecht", value="unterschiedlich") }}
        {% endif %}

        <h3 class="heading-underline">Status</h3>
        {% call form_input_optional('reg.payment', label="Teilnehmerbeitrag bezahlt am", anid="input_reg_payment") %}
            {{ util.input_text(name="reg.payment", type="date", placeholder="YYYY-MM-DD", anid="input_reg_payment") }}
        {% endcall %}
        {% call form_input_optional('reg.parental_agreement', anid="input_reg_parental_agreement") %}
            <div class="checkbox">
                {{ util.input_checkbox(name="reg.parental_agreement", label="Einverständniserklärung der Eltern",
                                       anid="input_reg_parental_agreement") }}
            </div>
        {% endcall %}

        {% call form_input_optional('reg.checkin', label="Eingecheckt am", anid="input_reg_checkin") %}
            {{ util.input_text(name="reg.checkin", type="datetime-local", placeholder="YYYY-MM-DDThh:ii",
                               anid="input_reg_checkin") }}
        {% endcall %}

        {% for part_id, part in ambience['event']['parts']|dictsort %}
            {% if ambience['event']['parts']|length > 1 %}
                <h4>{{ part['title']|e }}</h4>
            {% endif %}
            {# jinja does not support list comprehension ... #}
            {% set myentries = [] %}
            {% for s in enums['RegistrationPartStati'] %}
                {{ myentries.append((s.value, gettext(s|string)))|e }}
            {% endfor %}
            {% call form_input_optional("part{}.status".format(part_id), label="Status",
                                        anid="part{}_status".format(part_id)) %}
                {{ util.input_select(name="part{}.status".format(part_id), entries=myentries,
                                     anid="part{}_status".format(part_id)) }}
            {% endcall %}

            {# jinja does not support list comprehension ... #}
            {% set myentries = [] %}
            {% for lodgement_id, lodgement in lodgements|dictsort %}
                {{ myentries.append((lodgement_id, lodgement['moniker']))|e }}
            {% endfor %}
            {% call form_input_optional("part{}.lodgement_id".format(part_id), label="Unterkunft",
                                        anid="part{}_lodgement_id".format(part_id)) %}
                {{ util.input_select(name="part{}.lodgement_id".format(part_id), entries=myentries, nulloption=True,
                                     anid="part{}_lodgement_id".format(part_id)) }}
            {% endcall %}
            {% call form_input_optional("part{}.is_reserve".format(part_id),
                                        anid="part{}_is_reserve".format(part_id)) %}
                <div class="checkbox">
                    {{ util.input_checkbox(name="part{}.is_reserve".format(part_id), label="Isomattenplatz",
                                           anid="part{}_is_reserve".format(part_id)) }}
                </div>
            {% endcall %}

            {% for track_id, track in ambience['event']['tracks']|dictsort if track['part_id'] == part_id %}
                {# jinja does not support list comprehension ... #}
                {% set myentries = [] %}
                {% for course_id in course_choices[track_id] %}
                    {{ myentries.append((course_id, "{}. {}".format(courses[course_id]['nr'],
                                                                    courses[course_id]['shortname'])))|e }}
                {% endfor %}
                {% call form_input_optional("track{}.course_id".format(track_id),
                                            label="Kurs {}".format(track['title'])
                                                  if ambience['event']['tracks']|length > 1  else "Kurs",
                                            anid="track{}_course_id".format(track_id)) %}
                    {{ util.input_select(name="track{}.course_id".format(track_id), entries=myentries,
                                         nulloption=True, anid="track{}_course_id".format(track_id)) }}
                {% endcall %}
            {% endfor %}
        {% endfor %}

        <h3 class="heading-underline">Anmeldedaten</h3>
        {% call form_input_optional("reg.mixed_lodging", anid="input_reg_mixed_lodging") %}
            <div class="checkbox">
                {{ util.input_checkbox(name="reg.mixed_lodging", label="Gemischte Unterbringung",
                                       anid="input_reg_mixed_lodging") }}
            </div>
        {% endcall %}
        {% call form_input_optional("reg.foto_consent", anid="input_reg_foto_consent") %}
            <div class="checkbox">
                {{ util.input_checkbox(name="reg.foto_consent", anid="input_reg_foto_consent",
                                       label="Foto-Einwilligung") }}
            </div>
        {% endcall %}
        {% for track_id, track in ambience['event']['tracks']|dictsort %}
            {# jinja does not support list comprehension ... #}
            {% set myentries = [] %}
            {% for course_id in course_choices[part_id] %}
                {{ myentries.append((course_id, "{}. {}".format(courses[course_id]['nr'],
                                                                courses[course_id]['shortname'])))|e }}
            {% endfor %}
            {% call form_input_optional("track{}.course_instructor".format(track_id),
                                        label="{}: Kursleiter von".format(track['title'])
                                              if ambience['event']['tracks']|length > 1  else "Kursleiter von",
                                        anid="input_track{}_course_instructor".format(track_id)) %}
                {{ util.input_select(name="track{}.course_instructor".format(track_id),
                                     entries=myentries, nulloption=True,
                                     anid="input_track{}_course_instructor".format(track_id)) }}
            {% endcall %}
        {% endfor %}

        {% if ambience['event']['fields']|length > 0 %}
            <h3 class="heading-underline">Datenfelder</h3>
            {% for field_id, field in ambience['event']['fields']|dictsort
                   if field['association'] == enums['FieldAssociations'].registration %}
                {% call form_input_optional("fields.{}".format(field['field_name']),
                                            anid="input_fields_{}".format(field['field_name']),
                                            label=field['field_name'] if field['kind'] != "bool" else '') %}
                    {{ util.event_field_input(field, anid="input_fields_{}".format(field['field_name'])) }}
                {% endcall %}
            {% endfor %}
        {% endif %}

        {{ util.form_input_submit(value="Speichern", cancellink=cdedblink("event/registration_query")) }}
    </form>
    <script type="text/javascript">
        /**
         * Update disabled state of an input field based on the value of the associated enable-checkbox.
         *
         * This must be called on the enable-checkbox at updates of its state.
         */
        var update_state = function() {
            $(this).data('controlled-input').prop('disabled', !this.checked);
        };
        /**
         * Update style classes of a form-group, to show if the field will be overwritten.
         *
         * This function should be called on the dom object of a input field (text, select, checkbox, radio button) on
         * change of the disabled state or value. It adds the classes '.has-success' and '.bg-success' to the parent
         * '.form-group' container, if the field is enabled and the value differs from the original value.
         */
        var update_style = function() {
            /* check if changed */
            var changed = false;
            if (this.checked !== undefined) {
                changed = this.checked !== this.defaultChecked;
            } else if (this.options !== undefined) {
                for (var i=0; i < this.options.length; i++) {
                    if (this.options[i].selected) {
                        changed = !this.options[i].defaultSelected;
                        break;
                    }
                }
            } else {
                changed = this.value !== this.defaultValue;
            }

            var $row = $(this).closest('.form-group');
            if (!this.disabled && (changed || $(this).data('default-empty')))
                $row.addClass('has-success bg-success');
            else
                $row.removeClass('has-success bg-success');
        };

        $('.enable-input').each(function() {
            /* get reference to controlled input DOM object */
            var $input = $('#'+$(this).attr('data-input'));
            $(this).data('controlled-input', $input);
            $input.data('default-empty', !this.defaultChecked);

            /* add event listeners */
            $input.change(update_style);
            $(this).click(update_state);
            $(this).click(function(){update_style.call($input[0])});
            update_state.call(this);
        });

        $('#changeregistrationform').cdedbProtectChanges();
    </script>
{% endblock %}
