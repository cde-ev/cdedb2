{% set sidenav_active='event_registration' %}
{% extends "web/de/event/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('helper') }}{% endblock %}
{% set jshint='weak' %}
{% block title %}
Anmeldung von {{ persona['given_names']|e }} {{ persona['family_name']|e }} bearbeiten
({{ ambience['event']['title']|e }})
{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("event/index"), "Veranstaltungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/registration_query"), "Anmeldungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_registration"),
    persona['given_names']|e + " " + persona['family_name']|e, icon="user") }}
{{ util.breadcrumb_link(cdedblink("event/change_registration"), "Bearbeiten", active=True,) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {{ persona['given_names']|e }} {{ persona['family_name']|e }} bearbeiten
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title']|e }}</small>
    </h1>
{% endblock %}

{% macro output_name(persona) %}
    {{ persona['title']|e }}
    {{ persona['given_names']|e }}
    {{ persona['family_name']|e }}
    {{ persona['name_supplement']|e }}
{% endmacro %}

{% block content %}
    <form action="{{ cdedblink('event/change_registration')|e }}" method="POST" id="changeregistrationform"
          class="form-horizontal">
        <h3 class="heading-underline">Personendaten</h3>
        {{ util.form_input_static(label="Name", value=output_name(persona)) }}
        {{ util.form_input_static(label="CdEDB-ID", value=persona['id']|cdedbid|e) }}
        {{ util.form_input_text(name="reg.real_persona_id", label="Online CdEDB-ID",
                                info="Nur für Offline-Anmeldungen") }}
        {{ util.form_input_static(label="Geburtstag", value=persona['birthday']|date|e) }}
        {{ util.form_input_static(label="Geschlecht", value=persona['gender']|gender|e) }}
        {{ util.form_input_textarea(name="reg.orga_notes", label="Orga-Notizen", rows="5") }}

        <h3 class="heading-underline">Status</h3>
        {{ util.form_input_text(name="reg.payment", label="Teilnehmerbeitrag bezahlt am") }}
        {{ util.form_input_checkbox(name="reg.parental_agreement", label="Einverständniserklärung der Eltern") }}
        {{ util.form_input_text(name="reg.checkin", label="Eingecheckt am") }}

        {% for part_id, part in ambience['event']['parts']|dictsort %}
            {% if ambience['event']['parts']|length > 1 %}
                <h4>{{ part['title']|e }}</h4>
            {% endif %}
            {# jinja does not support list comprehension ... #}
            {% set myentries = [] %}
            {% for s in enums['RegistrationPartStati'] %}
                {{ myentries.append((s.value, gettext(s|string)))|e }}
            {% endfor %}
            {{ util.form_input_select(name="part{}.status".format(part_id), label="Status", entries=myentries) }}
            {% if course_choices[part_id]|length > 0 %}
                {# jinja does not support list comprehension ... #}
                {% set myentries = [] %}
                {% for course_id in course_choices[part_id] %}
                    {{ myentries.append((course_id, "{}. {}".format(courses[course_id]['nr'],
                                                                    courses[course_id]['shortname'])))|e }}
                {% endfor %}
                {{ util.form_input_select(name="part{}.course_id".format(part_id), label="Kurs", entries=myentries,
                                         nulloption=True) }}
            {% endif %}
            {# jinja does not support list comprehension ... #}
            {% set myentries = [] %}
            {% for lodgement_id, lodgement in lodgements|dictsort %}
                {{ myentries.append((lodgement_id, lodgement['moniker']))|e }}
            {% endfor %}
            {{ util.form_input_select(name="part{}.lodgement_id".format(part_id), label="Unterkunft",
                                     entries=myentries, nulloption=True) }}
        {% endfor %}

        <h3 class="heading-underline">Anmeldedaten</h3>
        {{ util.form_input_checkbox(name="reg.mixed_lodging", label="Gemischte Unterbringung") }}
        {{ util.form_input_checkbox(name="reg.foto_consent", label="Foto-Einwilligung") }}
        {{ util.form_input_textarea(name="reg.notes", label="Anmerkungen", rows="5") }}
        {% for part_id, part in ambience['event']['parts']|dictsort %}
            {% if course_choices[part_id]|length > 0 %}
                <h4>
                    Kurswahl
                    {% if ambience['event']['parts']|length > 1 %}
                    {{ part['title']|e }}
                    {% endif %}
                </h4>
                {# jinja does not support list comprehension ... #}
                {% set myentries = [] %}
                {% for course_id in course_choices[part_id] %}
                    {{ myentries.append((course_id, "{}. {}".format(courses[course_id]['nr'],
                                                                    courses[course_id]['shortname'])))|e }}
                {% endfor %}
                {{ util.form_input_select(name="part{}.course_instructor".format(part_id), label="Kursleiter von",
                                         entries=myentries, nulloption=True) }}
                {{ util.form_input_select(name="part{}.course_choice_0".format(part_id), label="Erstwahl",
                                         entries=myentries, nulloption=True) }}
                {{ util.form_input_select(name="part{}.course_choice_1".format(part_id), label="Zweitwahl",
                                         entries=myentries, nulloption=True) }}
                {{ util.form_input_select(name="part{}.course_choice_2".format(part_id), label="Drittwahl",
                                         entries=myentries, nulloption=True) }}
            {% endif %}
        {% endfor %}

        {% if ambience['event']['fields']|length > 0 %}
            <h3 class="heading-underline">Datenfelder</h3>
            {% for field_id, field in ambience['event']['fields']|dictsort %}
                {% if field['association'] == enums['FieldAssociations'].registration %}
                    {{ util.form_event_field_input(field) }}
                {% endif %}
            {% endfor %}
        {% endif %}

        {{ util.form_input_submit(value="Speichern", cancellink=cdedblink("event/show_registration")) }}
    </form>
    <script type="text/javascript">
        $('#changeregistrationform').cdedbProtectChanges();
    </script>
{% endblock %}
