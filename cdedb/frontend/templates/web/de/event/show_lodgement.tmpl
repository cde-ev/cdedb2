{% extends "web/de/event/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block scripts %}{{ util.jquery_with_ui_preamble() }}{% endblock %}
{% set jshint='strong' %}
{% block title %}Unterkunft {{ ambience['lodgement']['moniker'] }} ({{ ambience['event']['title']|e }}){% endblock %}
{% block content %}
    {% if problems %}
        <h2>Probleme</h2>
        <ul>
            {% for description, lodgement_id, part_id, affected_regs in problems %}
                <li>
                    {{ ambience['event']['parts'][part_id]['title']|e }} --
                    {{ gettext(description)|e }}
                    {% if affected_regs %}
                        (
                            {% for reg_id in affected_regs %}
                                {{ personas[registrations[reg_id]['persona_id']]['given_names']|e }}
                                {{ personas[registrations[reg_id]['persona_id']]['family_name']|e }}
                                {% if not loop.last %} , {% endif %}
                            {% endfor%}
                        )
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}
    <h2>Aktionen</h2>
    {{ util.href(cdedblink("event/change_lodgement_form"), "bearbeiten", readonly=is_locked) }}
    <form action="{{ cdedblink('event/delete_lodgement')|e }}" method="POST" class="jsConfirmed"
     id="deletelodgementform">
        {{ util.form_input_checkbox(name="ack_delete", label="Ich bin mir sicher", readonly=is_locked) }}
        {{ util.form_input_submit("Löschen", readonly=is_locked) }}
    </form>
    {{ util.href(cdedblink("event/manage_inhabitants_form"), "Belegung ändern", readonly=is_locked) }}
    <h2>Allgemeine Angaben</h2>
    <table>
        <tr>
            <td>normale Plätze</td>
            <td>{{ ambience['lodgement']['capacity']|e }}</td>
        <tr>
        </tr>
            <td>Reserveplätze</td>
            <td>{{ ambience['lodgement']['reserve']|e }}</td>
        <tr>
        </tr>
            <td>Notizen</td>
            <td>{{ ambience['lodgement']['notes']|rst }}</td>
        </tr>
    </table>
    <h2>Belegung</h2>
    {% for part_id, part in ambience['event']['parts']|dictsort %}
        {# TODO make this multi-column #}
        <h3>{{ part['title']|e }} -- {{ inhabitants[(values['lodgement_id'], part_id)]|length|e }} Bewohner</h3>
        <ul>
            {% for registration_id in inhabitants[(values['lodgement_id'], part_id)] %}
                <li>
                    {{ personas[registrations[registration_id]['persona_id']]['given_names']|e }}
                    {{ personas[registrations[registration_id]['persona_id']]['family_name']|e }}
                </li>
            {% endfor %}
        </ul>
    {% endfor %}
    <tr><th colspan="2">Felder</th></tr>
    {% for field_id, field in ambience['event']['fields']|dictsort %}
        {% if field['association'] == enums['FieldAssociations'].lodgement %}
            <tr>
                <td>{{ field['field_name']|e }}</td>
                <td>
                    {% if field['entries'] %}
                        {% for value, description in field['entries'] %}
                            {% if ambience['lodgement']['fields'].get(field['field_name']) == value %}
                                {{ description|e }}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {% if field['kind'] == "bool" %}
                            {{ util.deko_checkbox(
                                checked=ambience['lodgement']['fields'].get(field['field_name'])) }}
                        {% elif field['kind'] == "date" %}
                            {{ ambience['lodgement']['fields'].get(field['field_name'])|date|e }}
                        {% elif field['kind'] == "datetime" %}
                            {{ ambience['lodgement']['fields'].get(field['field_name'])|datetime|e }}
                        {% else %}
                            {{ ambience['lodgement']['fields'].get(field['field_name'])|e|linebreaks }}
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endif %}
    {% endfor %}
{% endblock %}
