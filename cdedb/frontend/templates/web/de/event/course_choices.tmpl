{% set sidenav_active='event_course_choices' %}
{% extends "web/de/event/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block title %}
Kurswahlen ({{ ambience['event']['title']|e }})
{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("event/index"), "Veranstaltungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/course_choices"), "Kurseinteilung", active=True) }}
{% endblock %}
{% block content %}
    {# TODO incorporate active_segments, max_size, min_size of courses #}
    <form action="{{ cdedblink('event/course_choices_form')|e }}" method="GET" id="choicefilterform">
        {# jinja does not support list comprehension ... #}
        {% set myentries = [] %}
        {% for track_id, track in ambience['event']['tracks']|dictsort %}
            {{ myentries.append((track_id, track['title']))|e }}
        {% endfor %}
        {{ util.form_input_select(name="track_id", label="Schiene", entries=myentries, nulloption=True) }}
        {# jinja does not support list comprehension ... #}
        {% set myentries = [] %}
        {% for course_id, course in courses|dictsort %}
            {{ myentries.append((course_id, course['title']))|e }}
        {% endfor %}
        {{ util.form_input_select(name="course_id", label="Kurs", entries=myentries, nulloption=True) }}
        {# jinja does not support list comprehension ... #}
        {% set myentries = [] %}
        {% for pos in enums.CourseFilterPositions %}
            {{ myentries.append((pos.value, gettext(pos|string)))|e }}
        {% endfor %}
        {{ util.form_input_select(name="position", label="Position", entries=myentries, nulloption=True) }}
        {{ util.form_input_submit(value="Suchen") }}
    </form>
    ~
    <form action="{{ cdedblink('event/course_choices')|e }}" method="POST" id="choiceactionform">
        <table>
            <tr>
                <th></th>
                <th>Teilnehmer</th>
                {% for track_id, track in ambience['event']['tracks']|dictsort %}
                    <th>Kurs ({{ track['title']|e }})</th>
                    <th>Leiter ({{ track['title']|e }})</th>
                    <th>Erstwahl ({{ track['title']|e }})</th>
                    <th>Zweitwahl ({{ track['title']|e }})</th>
                    <th>Drittwahl ({{ track['title']|e }})</th>
                {% endfor %}
            </tr>
            {% for reg_id, registration in registrations|dictsort %}
                <tr>
                    <td>
                        {{ util.form_input_checkbox("registration_ids", value=reg_id) }}
                    </td>
                    <td>
                        {% with persona = personas[registration['persona_id']] %}
                            {{ util.href(cdedblink("event/show_registration", {'registration_id': reg_id}),
                                         "{} {}".format(persona['given_names'], persona['family_name'])) }}
                        {% endwith %}
                    </td>
                    {% for track_id, track in ambience['event']['tracks']|dictsort %}
                        {% if registration['parts'][track['part_id']]['status'] == enums['RegistrationPartStati'].participant %}
                            <td>
                               {% if registration['tracks'][track_id]['course_id'] %}
                                   {{ courses[registration['tracks'][track_id]['course_id']]['shortname']|e }}
                               {% endif %}
                            </td>
                            <td>
                               {% if registration['tracks'][track_id]['course_instructor'] %}
                                   {{ courses[registration['tracks'][track_id]['course_instructor']]['shortname']|e }}
                               {% endif %}
                            </td>
                            {% for j in range(3) %}
                                <td>
                                    {% if registration['tracks'][track_id]['choices']|length > j %}
                                       {{ courses[registration['tracks'][track_id]['choices'][j]]['shortname']|e }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        {% else %}
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
        Kurszuteilung ändern für markierte Personen in den Schienen
        {# jinja does not support list comprehension ... #}
        {% set myentries = [] %}
        {% for track_id, track in ambience['event']['tracks']|dictsort %}
            {{ myentries.append((track_id, track['title']))|e }}
        {% endfor %}
        {{ util.form_input_checkboxes(name="track_ids", entries=myentries) }}
        nach
        {{ util.form_input_checkboxes(name="action", label="Kurs", radio=True, entries=(
            (enums.CourseChoiceToolActions.assign_first_choice.value, "Erstwahl"),
            (enums.CourseChoiceToolActions.assign_second_choice.value, "Zweitwahl"),
            (enums.CourseChoiceToolActions.assign_third_choice.value, "Drittwahl"),
            (enums.CourseChoiceToolActions.assign_fixed.value, "Kurs aus Liste"),
            (enums.CourseChoiceToolActions.assign_auto.value, "Automatisch"))) }}
        {# jinja does not support list comprehension ... #}
        {% set myentries = [] %}
        {% for course_id, course in courses|dictsort %}
            {{ myentries.append((course_id, course['title']))|e }}
        {% endfor %}
        {{ util.form_input_select(name="course_id", label="Kurs", entries=myentries, nulloption=True) }}
        {{ util.form_input_submit(value="Zuweisen") }}
    </form>
{% endblock %}
