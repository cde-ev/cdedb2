{% set sidenav_active='event_course_choices' %}
{% extends "web/de/event/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block title %}
Kurswahlen ({{ ambience['event']['title']|e }})
{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("event/index"), "Veranstaltungen") }}
{{ util.breadcrumb_link(cdedblink("event/show_event"), ambience['event']['title'], icon="blackboard") }}
{{ util.breadcrumb_link(cdedblink("event/course_choices"), "Kurseinteilung", active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        Kurseinteilung
        <small>{{ util.make_icon('blackboard') }} {{ ambience['event']['title']|e }}</small>
    </h1>
{% endblock %}
{% macro course_cell(course_id, track_id, border_left=False, complain_empty=False, primary=False, filtered=False) %}
    {% if course_id %}
        {% with course = courses[course_id] %}
            {% set attendees = course_infos[(course_id, track_id)]['assigned'] %}
            {% set aclass = 'course-cancelled' if track_id not in course['active_segments'] else
                           ('course-manyp' if course['max_size'] and attendees > course['max_size'] else
                            ('course-fewp' if course['min_size'] and attendees < course['min_size'] else '')) %}
            <td class="{% if border_left %}b-left{% endif %} text-center {% if primary %}course-primary{% endif %}
                       {% if filtered %}filtered_column{% endif %} {{ aclass }}">
                <span title="{{ course['nr'] }}. {{ course['shortname'] }}
                             ({{ attendees|e }}
                              {% if course['max_size']|e %} von {{ course['max_size']|e }}{% endif %} TN)"
                      data-id="{{ course_id|e }}"
                      class="event_course_id">
                   {{ course['nr']|e }}
                </span>
            </td>
        {% endwith %}
    {% else %}
        {% set aclass = 'course-cancelled' if complain_empty else '' %}
        <td class="{% if border_left %}b-left{% endif %} {% if primary %}course-primary{% endif %} {{ aclass }}
                   {% if filtered %}filtered_column{% endif %}">
        </td>
    {% endif %}
{% endmacro %}

{% block content %}
    {% call util.bootstrap_panel(title="Filter", icon="search", aclass='panel-primary') %}
        <form action="{{ cdedblink('event/course_choices_form')|e }}" method="GET" id="choicefilterform">
            <p>
                Teilnehmer, die in Teil
                {# jinja does not support list comprehension ... #}
                {% set myentries = [('', '— egal —')] %}
                {% for track_id, track in ambience['event']['tracks']|dictsort %}
                    {{ myentries.append((track_id, track['title']))|e }}
                {% endfor %}
                {{ util.input_select(name="track_id", entries=myentries, aclass="form-control input-slim") }}
                {# jinja does not support list comprehension ... #}
                {% set myentries = [] %}
                {% for course_id, course in courses|dictsort %}
                    {{ myentries.append((course_id, "{}. {}".format(course['nr'], course['shortname']))) }}
                {% endfor %}
                den Kurs
                {{ util.input_select(name="course_id", entries=myentries, nulloption=True, aclass="form-control input-slim") }}
                {# jinja does not support list comprehension ... #}
                {% set myentries = [('', "— kein Filter —"),
                                    (enums.CourseFilterPositions.anywhere.value, "irgendwie kennen"),
                                    (enums.CourseFilterPositions.assigned.value, "besuchen"),
                                    (enums.CourseFilterPositions.instructor.value, "anbieten"),
                                    (enums.CourseFilterPositions.any_choice.value, "gewählt haben"),
                                    (enums.CourseFilterPositions.first_choice.value, "als 1. Wahl haben"),
                                    (enums.CourseFilterPositions.second_choice.value, "als 2. Wahl haben"),
                                    (enums.CourseFilterPositions.third_choice.value, "als 3. Wahl haben")] %}
                {{ util.input_select(name="position", entries=myentries, aclass="form-control input-slim") }}<br />
                {# TODO Link to query page with matching query (if possible) #}
                mit einer der folgenden IDs:
                {{ util.input_text(name='ids', aclass="form-control input-slim") }}
            </p>
            <p class="nosp">
                {{ util.input_submit(value="anzeigen", icon="search") }}
                &emsp;oder
                {{ util.href(cdedblink("event/course_choices",{}), "alle anzeigen", icon="remove",
                             aclass="btn btn-default") }}
            </p>
        </form>
    {% endcall %}

    <form action="{{ cdedblink('event/course_choices')|e }}" method="POST" id="choiceactionform">
        {% call util.bootstrap_panel(title="Zuteilen", icon="screenshot", aclass='panel-warning') %}
            <div class="row">
                <div class="col-md-3">
                    Markierte Personen in
                </div>
                {% if ambience['event']['tracks']|length == 1 %}
                    {{ util.input_hidden(name="track_ids", value=(ambience['event']['tracks']|list)[0]) }}
                {% else %}
                    <div class="col-md-3 strip-inner-space">
                        {# jinja does not support list comprehension ... #}
                        {% set myentries = [] %}
                        {% for track_id, track in ambience['event']['tracks']|dictsort %}
                            {{ myentries.append((track_id, track['title']))|e }}
                        {% endfor %}
                        {{ util.input_checkboxes(name="track_ids", entries=myentries) }}
                    </div>
                {% endif %}
                <div class="col-md-4">
                    <div class="form-group">
                        {{ util.input_select(name="action", anid="input-action", entries=(
                            (enums.CourseChoiceToolActions.assign_first_choice.value, "in ihre Erstwahl"),
                            (enums.CourseChoiceToolActions.assign_second_choice.value, "in ihre Zweitwahl"),
                            (enums.CourseChoiceToolActions.assign_third_choice.value, "in ihre Drittwahl"),
                            (enums.CourseChoiceToolActions.assign_fixed.value, "in den Kurs …"),
                            (enums.CourseChoiceToolActions.assign_auto.value, "automatisch"))) }}
                    </div>
                    <div class="form-group">
                        {# jinja does not support list comprehension ... #}
                        {% set myentries = [] %}
                        {% for course_id, course in courses|dictsort %}
                            {{ myentries.append((course_id, "{}. {}".format(course['nr'], course['shortname'])))|e }}
                        {% endfor %}
                        {{ util.input_select(name="course_id", anid="input-course_id", entries=myentries, nulloption=True) }}
                    </div>
                </div>
                <div class="col-md-2">
                    {{ util.input_submit(value="einteilen.") }}
                </div>
                <script type="text/javascript">
                    {
                        var $actionSelect = $('#input-action');
                        var $courseSelect = $('#input-course_id');
                        var updateCourseVisibility = function() {
                            if ($actionSelect.val() == {{ enums.CourseChoiceToolActions.assign_fixed.value|e }})
                                $courseSelect.show();
                            else
                                $courseSelect.hide();
                        };
                        $actionSelect.change(updateCourseVisibility);
                        updateCourseVisibility();
                    }
                </script>
            </div>
        {% endcall %}

        <table class="table table-condensed table-hover">
            <thead>
                <tr>
                    <th rowspan="2"></th>
                    <th rowspan="2">Name</th>
                    {% for track_id, track in ambience['event']['tracks']|dictsort %}
                        <th colspan="5" class="b-left">{{ track['title']|e }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {# TODO markup filtered columns with th.filtered_column #}
                    {% for track_id in ambience['event']['tracks']|sort %}
                        <th class="b-left text-center">
                            {{ util.make_icon('screenshot') }}
                        </th>
                        <th class="b-left text-center">KL</th>
                        <th class="text-center">1.</th>
                        <th class="text-center">2.</th>
                        <th class="text-center">3.</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for reg_id, registration in registrations|dictsort %}
                    <tr>
                        <td>
                            {{ util.input_checkbox("registration_ids", value=reg_id) }}
                        </td>
                        <td>
                            {% with persona = personas[registration['persona_id']] %}
                                {{ util.href(cdedblink("event/show_registration", {'registration_id': reg_id}),
                                             "{} {}".format(persona['given_names'], persona['family_name'])) }}
                            {% endwith %}
                        </td>
                        {# TODO markup filtered columns with td.filtered_column #}
                        {% for track_id, track in ambience['event']['tracks']|dictsort %}
                            {% set track_is_filtered = (values['track_id'] in ('', track_id)) %}
                            {% if registration['parts'][track['part_id']]['status'] == enums['RegistrationPartStati'].participant %}
                                {{ course_cell(registration['tracks'][track_id]['course_id'], track_id, border_left=True,
                                               complain_empty=True, primary=True) }}
                                {{ course_cell(registration['tracks'][track_id]['course_instructor'], track_id,
                                               border_left=True) }}
                                {% for j in range(3) %}
                                    {{ course_cell(registration['tracks'][track_id]['choices'][j]
                                                   if registration['tracks'][track_id]['choices']|length > j else None,
                                                   track_id) }}
                                {% endfor %}
                            {% else %}
                                <td class="b-left"></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
    <script type="text/javascript">
        $('.event_course_id').dblclick(function() {
            location.href =
                "{{ cdedblink('event/show_course', {'course_id': 12345}) }}".replace('12345', $(this).attr('data-id'));
        });
    </script>
{% endblock %}
