{# This contains generic pages. Currently these are those for managing users. #}

{% import "web/de/util.tmpl" as util with context %}

{% macro create_user(realm) %}
    <form action="{{ cdedblink('{}/create_user'.format(realm))|e }}" method="POST" id="newuserform"
      class="form-horizontal">
        <h4 class="heading-underline">Person</h4>
        {{ util.form_input_text(name="title", label="Titel") }}
        {{ util.form_input_text(name="given_names", label="Vorname(n)") }}
        {{ util.form_input_text(name="family_name", label="Nachname") }}
        {% if realm == "cde" %}
            {{ util.form_input_text(name="birth_name", label="Geburtsname") }}
        {% endif %}
        {{ util.form_input_text(name="name_supplement", label="Namenszusatz") }}
        {{ util.form_input_text(name="display_name", label="Rufname") }}
        {% if realm == "cde" %}
            {{ util.form_input_textarea(name="specialisation", label="Fachgebiet") }}
            {{ util.form_input_textarea(name="affiliation", label="Schule, Uni, ...") }}
            {{ util.form_input_textarea(name="timeline", label="Jahrgang, Matrikel, ...") }}
            {{ util.form_input_textarea(name="interests", label="Interessen") }}
            {{ util.form_input_textarea(name="free_form", label="Sonstiges", rows="5") }}
        {% endif %}
        {% if realm in ("cde", "event") %}
            {{ util.form_input_select(name="gender", entries=default_selections['gender'], label="Geschlecht") }}
            {{ util.form_input_text(name="birthday", label="Geburtstag", type="date", placeholder="YYYY-MM-DD") }}
        {% endif %}

        <h4 class="heading-underline">Kontakt</h4>
        {{ util.form_input_text(name="username", label="E-Mail") }}
        {% if realm in ("cde", "event") %}
            {{ util.form_input_text(name="telephone", label="Telefon") }}
            {{ util.form_input_text(name="mobile", label="Mobiltelefon") }}
        {% endif %}
        {% if realm == "cde" %}
            {{ util.form_input_text(name="weblink", label="WWW") }}
        {% endif %}

        {% if realm in ("cde", "event") %}
            <h4 class="heading-underline">Adresse</h4>
            {{ util.form_input_text(name="address", label="Straße") }}
            {{ util.form_input_text(name="address_supplement", label="Addresszusatz") }}
            {{ util.form_input_text(name="postal_code", label="Postleitzahl") }}
            {{ util.form_input_text(name="location", label="Stadt") }}
            {{ util.form_input_text(name="country", label="Land") }}
        {% endif %}
        {% if realm == "cde" %}
            <h4 class="heading-underline">Zweitadresse</h4>
            {{ util.form_input_text(name="address2", label="Straße") }}
            {{ util.form_input_text(name="address_supplement2", label="Addresszusatz") }}
            {{ util.form_input_text(name="postal_code2", label="Postleitzahl") }}
            {{ util.form_input_text(name="location2", label="Stadt") }}
            {{ util.form_input_text(name="country2", label="Land") }}
        {% endif %}

        <h4 class="heading-underline">Account</h4>
        {% if realm == "cde" %}
            {{ util.form_input_checkbox(name="is_member", label="CdE-Mitgliedschaft",
                                   anid="input_checkbox_is_member") }}
            {{ util.form_input_checkbox(name="is_searchable", label="Sichtbarkeit (falls Einwilligung vorhanden)",
                                   anid="input_checkbox_is_searchable") }}
            {{ util.form_input_checkbox(name="trial_member", label="Probemitgliedschaft",
                                       anid="input_checkbox_trial_member") }}
            {{ util.form_input_checkbox(name="bub_search", label="Zugriff für BuB", anid="input_checkbox_bub_search") }}
        {% endif %}
        {{ util.form_input_checkbox(name="cloud_account", label="Cloud Account",
                                   anid="input_checkbox_cloud_account") }}
        {{ util.form_input_textarea(name="notes", label="Notizen", rows="7", info="Unterstützt reStructuredText") }}


        {{ util.form_input_submit(value="Nutzer anlegen", cancellink=cdedblink("{}/user_search".format(realm))) }}
    </form>
    <script type="text/javascript">
        $('#newuserform').cdedbProtectChanges();
    </script>
{% endmacro %}

{% macro genesis(realm) %}
    <p>Hallo {{ case['given_names'] }},</p>

    <p>
        Um Dein Konto für die CdE Datenbank anzulegen, trage bitte in das folgende Formular Deine Daten ein. Sobald Du
        dieses Formluar bestätigt hast, kannst Du ein Passwort einrichten und Dein Zugang wird freigeschaltet.
    </p>

    <form action="{{ cdedblink('{}/genesis'.format(realm))|e }}" method="POST" id="newuserform" class="form-horizontal">
        {{ util.input_hidden(name="case_id") }}
        {{ util.input_hidden(name="secret") }}

        <h4 class="heading-underline">Person</h4>
        {{ util.form_input_text(name="title", label="Titel", info="z.B. Prof. Dr.") }}
        {{ util.form_input_static(label="Vorname(n)", value=case['given_names']) }}
        {{ util.form_input_static(label="Nachname", value=case['family_name']) }}
        {{ util.form_input_text(name="name_supplement", label="Namenszusatz") }}
        {{ util.form_input_text(name="display_name", label="Rufname", info="Wie wirst Du genannt?") }}
        {% if realm == "event" %}
            {{ util.form_input_text(name="birthday", label="Geburtstag", type="date", placeholder="YYYY-MM-DD") }}
            {{ util.form_input_select(name="gender", entries=default_selections['gender'], label="Geschlecht") }}
        {% endif %}

        <h4 class="heading-underline">Kontakt</h4>
        {{ util.form_input_static(label="E-Mail-Adresse", value=case['username']) }}
        {% if realm == "event" %}
            {{ util.form_input_text(name="telephone", label="Telefon", placeholder="+49 (0000) 000000") }}
            {{ util.form_input_text(name="mobile", label="Mobiltelefon", placeholder="+49 (000) 0000000") }}

            <h4 class="heading-underline">Adresse</h4>
            {{ util.form_input_text(name="address", label="Straße") }}
            {{ util.form_input_text(name="address_supplement", label="Addresszusatz") }}
            {{ util.form_input_text(name="postal_code", label="Postleitzahl") }}
            {{ util.form_input_text(name="location", label="Stadt") }}
            {{ util.form_input_text(name="country", label="Land") }}
        {% endif %}
        {{ util.form_input_submit(value="Account anlegen", cancellink=cdedblink('core/index')) }}
    </form>
{% endmacro %}

{% macro user_search(realm) %}
    <div class="row">
        <div class="col-md-4">
            {% call util.bootstrap_panel(title="Aktionen", aclass="panel-warning") %}
                {{ util.href(cdedblink("{}/create_user".format(realm)), "Nutzer anlegen",
                        icon="plus", aclass="btn btn-success") }}
            {% endcall %}
        </div>
        <div class="col-md-8">
            {% with TITLES = {
                "all": "Alle Accounts",} %}
                <div>
                    {{ util.place_default_queries("{}/user_search".format(realm), default_queries, TITLES) }}
                </div>
            {% endwith %}
        </div>
    </div>

    {{ user_search_mask(realm) }}

    {% if values['is_search'] %}
        <h3>Ergebnis [{{ result|length|e }}]</h3>
        {{ user_search_result(result, realm) }}
    {% endif %}
{% endmacro %}


{% macro user_search_mask(realm, selection_blacklist=[]) %}
    {% with TITLES = {
        "fulltext": "Volltext",
        "personas.id": "ID",
        "username": "E-Mail",
        "is_active": "Aktiver Account",
        "cloud_account": "Cloud Account",
        "family_name": "Nachname",
        "birth_name": "Geburtsname",
        "given_names": "Vorname",
        "display_name": "Rufname",
        "title": "Titel",
        "name_supplement": "Namenszusatz",
        "gender": "Geschlecht",
        "birthday": "Geburtstag",
        "telephone": "Telefon",
        "mobile": "Mobilfunk",
        "address": "Anschrift",
        "address_supplement": "Adresszusatz",
        "postal_code": "PLZ",
        "location": "Ort",
        "country": "Land",
        "address2": "Anschrift (2)",
        "address_supplement2": "Adresszusatz (2)",
        "postal_code2": "PLZ (2)",
        "location2": "Ort (2)",
        "country2": "Land (2)",
        "weblink": "WWW",
        "specialisation": "Fachgebiet",
        "affiliation": "Schule, Uni, …",
        "timeline": "Jahrgang, Matrikel, …",
        "interests": "Interessen",
        "free_form": "Sonstige Angaben",
        "pevent_id": "abg. Veranstaltung",
        "pcourse_id": "abg. Kurs",
        "balance": "Mitgliedsbeitrag-Guthaben",
        "decided_search": "Suchbarkeit entschieden",
        "trial_member": "Probemitglied",
        "bub_search": "Sichtbarkeit für BuB",
        "notes": "Admin-Notizen",
        'is_member': "CdE-Mitglied",
        'is_searchable': "Suchbarkeit",
        'is_ml_realm': "Bereich: Mailinglisten",
        'is_event_realm': "Bereich: Veranstaltungen",
        'is_assembly_realm': "Bereich: Versammlungen",
        'is_cde_realm': "Bereich: CdE",
        'is_ml_admin': "Admin: Mailinglisten",
        'is_event_admin': "Admin: Veranstaltungen",
        'is_assembly_admin': "Admin: Versammlungen",
        'is_cde_admin': "Admin: CdE",
        'is_core_admin': "Admin: Core",
        'is_admin': "Admin: Super",
    } %}

        {% if realm == "archived" %}
            {% set target=cdedblink('core/archived_user_search') %}
        {% else %}
            {% set target=cdedblink('{}/user_search'.format(realm)) %}
        {% endif %}
            {{ util.format_query(spec, TITLES, choices, target, selection_blacklist=selection_blacklist) }}
        </form>

    {% endwith %}
{% endmacro %}

{% macro user_search_result(result, realm) %}
    {# warning: titles will not be escaped! #}
    {% with TITLES = {
        "fulltext": "Volltext",
        "personas.id": "ID",
        "username": "E-Mail",
        "is_active": "Aktiv",
        "cloud_account": "Cloud",
        "family_name": "Nachname",
        "birth_name": "Geburtsname",
        "given_names": "Vorname",
        "display_name": "Rufname",
        "title": "Titel",
        "name_supplement": "Namenszusatz",
        "gender": "Geschlecht",
        "birthday": "Geburtstag",
        "telephone": "Telefon",
        "mobile": "Mobilfunk",
        "address": "Anschrift",
        "address_supplement": "Adresszusatz",
        "postal_code": "PLZ",
        "location": "Ort",
        "country": "Land",
        "address2": "Anschrift (2)",
        "address_supplement2": "Adresszusatz (2)",
        "postal_code2": "PLZ (2)",
        "location2": "Ort (2)",
        "country2": "Land (2)",
        "weblink": "WWW",
        "specialisation": "Fachgebiet",
        "affiliation": "Schule, Uni, …",
        "timeline": "Jahrgang, Matrikel, …",
        "interests": "Interessen",
        "free_form": "Sonstige Angaben",
        "pevent_id": "abg. Veranstaltung",
        "pcourse_id": "abg. Kurs",
        "balance": "Guthaben",
        "decided_search": "Suchbarkeit entschieden",
        "trial_member": "Probemitglied",
        "bub_search": "BuB-Sichtbar",
        "notes": "Admin-Notizen",
        'is_member': "Mitglied",
        'is_searchable': "Suchbar",
        'is_ml_realm': util.make_icon('envelope', title="Bereich: Mailinglisten"),
        'is_event_realm': util.make_icon('blackboard', title="Bereich: Veranstaltungen"),
        'is_assembly_realm': util.make_icon('bullhorn', title="Bereich: Versammlungen"),
        'is_cde_realm': util.make_icon('education', title="Bereich: CdE"),
        'is_ml_admin': "Admin " + util.make_icon('envelope', title="Admin: Mailinglisten"),
        'is_event_admin': "Admin " + util.make_icon('blackboard', title="Admin: Veranstaltungen"),
        'is_assembly_admin': "Admin " + util.make_icon('bullhorn', title="Admin: Versammlungen"),
        'is_cde_admin': "Admin " + util.make_icon('education', title="Admin: CdE"),
        'is_core_admin': "Admin " + util.make_icon('user', title="Admin: Core"),
        'is_admin': "Admin " + util.make_icon('wrench', title="Admin: Super"),
    } %}

        {{ util.display_query_result(result, query, TITLES, choices) }}
    {% endwith %}
{% endmacro %}
