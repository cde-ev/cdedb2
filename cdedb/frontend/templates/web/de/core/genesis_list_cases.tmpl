{% set sidenav_active='core_genesis_list' %}
{% extends "web/de/core/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('helper') }}{% endblock %}
{% set jshint='weak' %}
{% block title %}Accountanfragen{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("core/index"), "Start") }}
{{ util.breadcrumb_link(cdedblink("core/genesis_list_cases"), "Accountanfragen", active="True") }}
{% endblock %}
{% block content %}
    <h2>Ausstehende Anfragen [{{ to_review|length|e }}]</h2>

    <script type="text/javascript">
        $(function() {
            $('.rejection-form').cdedbProtectAction("Die Account-Anfrage wird irreversibel gelöscht.");
        });
    </script>
    <p>
        Die im Folgenden aufgeführten Personen haben einen Account für den angegebenen Bereich der CdE-Datenbank
        beantragt. Nach dem Genehmigen einer Anfrage wird der entsprechende erhält der Bewerber eine E-Mail mit Link zu einem Formular
        zum Anlegen seines Accounts. Wird die Anfrage abgelehnt, so erhält er eine E-Mail, die ihn darüber
        informiert.
    </p>
    {% if 'event_admin' in user.roles or 'core_admin' in user.roles %}
        <h3>Veranstaltungs-Anfragen</h3>
        {% if event_cases|length > 0 %}
            {% for case_id, entry in event_cases|dictsort %}
                <div class="row">
                    <div class="col-sm-2">
                        {{ util.href(cdedblink('core/genesis_modify_form', {'case_id': case_id}), "Bearbeiten",
                            aclass="btn btn-info btn-sm") }}
                    </div>
                    <div class="col-sm-3">
                        <p>
                            {{ entry['given_names']|e }} {{ entry['family_name']|e }}
                            &lt;{{ util.href('mailto:'+entry['username']|e,entry['username']|e) }}&gt;
                        </p>
                        {# FIXME maybe display more information?#}
                    </div>
                    <div class="col-sm-4">
                        {% with realms = {'event': ('Veranstaltung', 'blackboard'), 'ml': ('Mailingliste', 'envelope')} %}
                            {{ util.make_icon(realms[entry['realm']][1]) }} {{ realms[entry['realm']][0] }}
                        {% endwith %}
                        {% if entry['notes'] %}<p class="textbox">{{ entry['notes']|e }}</p>{% endif %}
                    </div>
                    <div class="col-sm-3">
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id})|e }}" method="POST"
                         id="genesiseventrejectionform{{ loop.index|e }}" class="pull-left rejection-form">
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].rejected.value) }}
                            {{ util.input_submit(icon="remove", value="Ablehnen", aclass="btn btn-sm btn-danger") }}
                        </form>
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id})|e }}" method="POST"
                         id="genesiseventapprovalform{{ loop.index|e }}" style="display: inline;">
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].approved.value) }}
                            {{ util.input_submit(value="Genehmigen", aclass="btn btn-sm btn-success") }}
                        </form>
                    </div>
                </div>
                {% if not loop.last %}
                    <hr />
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="text-muted">Zur Zeit liegen keine Veranstaltungs-Anfragen vor.</p>
        {% endif %}
    {% endif %}
    {% if 'ml_admin' in user.roles or 'core_admin' in user.roles %}
        <h3>Malinglisten-Anfragen</h3>
        {% if ml_cases|length > 0 %}
            {% for case_id, entry in ml_cases|dictsort %}
                <div class="row">
                    <div class="col-sm-2">
                        {{ util.href(cdedblink('core/genesis_modify_form', {'case_id': case_id}), "Bearbeiten",
                            aclass="btn btn-info btn-sm") }}
                    </div>
                    <div class="col-sm-3">
                        <p>
                            {{ entry['given_names']|e }} {{ entry['family_name']|e }}
                            &lt;{{ util.href('mailto:'+entry['username']|e,entry['username']|e) }}&gt;
                        </p>
                    </div>
                    <div class="col-sm-4">
                        {% with realms = {'event': ('Veranstaltung', 'blackboard'), 'ml': ('Mailingliste', 'envelope')} %}
                            {{ util.make_icon(realms[entry['realm']][1]) }} {{ realms[entry['realm']][0] }}
                        {% endwith %}
                        {% if entry['notes'] %}<p class="textbox">{{ entry['notes']|e }}</p>{% endif %}
                    </div>
                    <div class="col-sm-3">
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id})|e }}" method="POST"
                         id="genesismlrejectionform{{ loop.index|e }}" class="pull-left rejection-form">
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].rejected.value) }}
                            {{ util.input_submit(icon="remove", value="Ablehnen", aclass="btn btn-sm btn-danger") }}
                        </form>
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id})|e }}" method="POST"
                         id="genesismlapprovalform{{ loop.index|e }}" style="display: inline;">
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].approved.value) }}
                            {{ util.input_submit(value="Genehmigen", aclass="btn btn-sm btn-success") }}
                        </form>
                    </div>
                </div>
                {% if not loop.last %}
                    <hr />
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="text-muted">Zur Zeit liegen keine Mailinglisten-Anfragen vor.</p>
        {% endif %}
    {% endif %}
{% endblock %}
