{% extends "web/de/core/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% import "web/de/generic.tmpl" as generic with context %}
{% block scripts %}{{ util.cdedb_script('historycollapse') }}{% endblock %}
{% block title %}Geschichte von {{ current['given_names']|e }} {{ current['family_name']|e }}{% endblock %}
{% block breadcrumb %}
    {{ util.breadcrumb_link(cdedblink("core/index"), "Start") }}
    {{ util.breadcrumb_link(show_user_link(current['id']), current['given_names'] + " " + current['family_name'],
            icon="user") }}
    {{ util.breadcrumb_link(cdedblink("core/show_history"), "Geschichte", active=True) }}
{% endblock %}
{% macro print_history(f) %}
    {% for c in entries[f] %}
        {% if c not in constants[f] or loop.first %}
            <div class="row history-row">
                <div class="col-xs-3">Gen {{ c }}</div>
                <div class="col-xs-9">
                    {% if caller %}{{ caller(c) }}{% else %}{{ entries[f][c]|e }}{% endif %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}
{% macro print_multifield_history(fields=[]) %}
    {% for c in entries[fields[0]] %}
        {% set vars = {'has_nonconstant' : False} %}
        {% for f in fields %}
            {% if c not in constants[f] %}{% set tmp = vars.update({'has_nonconstant' : True}) %}{% endif %}
        {% endfor %}
        {% if vars['has_nonconstant'] or loop.first %}
            <div class="row history-row">
                <div class="col-xs-3">Gen {{ c }}</div>
                <div class="col-xs-9">
                    {% if caller %}{{ caller(c) }}{% endif %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}
{% macro history_field(title) %}
    <div class="form-group">
        <label class="col-sm-3">{{ title|e }}</label>
        <div class="col-sm-9 history-container">
            {{ caller() }}
        </div>
    </div>
{% endmacro %}

{% block content %}
    <div class="float-along">
        {% if not current['is_active'] %}
            <p class="text-danger">
                Der Benutzer ist deaktiviert.
            </p>
        {% endif %}
        {% if current['is_archived'] %}
            <p class="text-danger">
                Der Benutzer ist archiviert.
            </p>
        {% endif %}

        <script type="text/javascript">
            $(function() {
                $('.history-container').cdedbHistoryCollapse();
            });
        </script>

        <div class="form-horizontal">
            <h4 class="heading-underline">Person</h4>
            {% call history_field('Name') %}
                {% call(c) print_multifield_history(
                        ['title','given_names', 'display_name', 'family_name', 'name_supplement']) %}
                    {{ entries['title'][c]|e }}
                    {{ util.output_given_displayname(entries['given_names'][c], entries['display_name'][c]) }}
                    {{ entries['family_name'][c]|e }} {{ entries['name_supplement'][c]|e }}
                {% endcall %}
            {% endcall %}
            
            {% call history_field("Geburtsname") %}
                {{ print_history('birth_name') }}
            {% endcall %}
     
            {% call history_field("Geburtstag") %}
                {% call(c) print_history('birthday') %}
                     {{ entries['birthday'][c]|date|e }}
                {% endcall %}
            {% endcall %}

            {% call history_field("Geschlecht") %}
                {% call(c) print_history('gender') %}
                     {{ entries['gender'][c]|gender|e }}
                {% endcall %}
            {% endcall %}

        
            <h4 class="heading-underline">Account &amp; Mitgliedschaft</h4>
            
            {% call history_field('Aktiv') %}
                {{ print_history('is_active') }}
            {% endcall %}
            
            {% call history_field('Bereiche') %}
                {% call(c) print_multifield_history(
                        ['is_cde_realm','is_event_realm', 'is_ml_realm', 'is_assembly_realm']) %}
                    {% for bit, desc, icon in (("is_cde_realm", "CdE", "education"),
                                               ("is_event_realm", "Veranstaltungen", "blackboard"),
                                               ("is_ml_realm", "Mailinglisten", "envelope"),
                                               ("is_assembly_realm", "Versammlungen", "stats"),)%}
                        {% if entries[bit][c] %}
                            {{ util.make_icon(icon) }} {{ desc|e }},
                        {% endif %}
                    {% endfor %}
                {% endcall %}    
            {% endcall %}
            
            {% call history_field('Admin-Privilegien') %}
                {% call(c) print_multifield_history(['is_admin','is_core_admin','is_cde_admin','is_event_admin',
                                                     'is_ml_admin', 'is_assembly_admin']) %}
                    {% set vars = {'any_privilege': False} %}
                    {% for bit, desc, icon in (("is_admin", "Super", "wrench"),
                                              ("is_core_admin", "Core", "user"),
                                              ("is_cde_admin", "CdE", "education"),
                                              ("is_event_admin", "Veranstaltungs", "blackboard"),
                                              ("is_ml_admin", "Mailinglisten", "envelope"),
                                              ("is_assembly_admin", "Versammlungs", "stats"),)%}
                        {% if entries[bit][c] %}
                            {{ util.make_icon(icon) }} {{ desc|e }}-Admin,
                            {# Dirty hack to workaround Jinjas set drawbacks #}
                            {% set tmp = vars.update({'any_privilege': True}) %}
                        {% endif %}
                    {% endfor %}
                    {% if not vars['any_privilege'] %}<i>Keine</i>{% endif %}
                {% endcall %}    
            {% endcall %}
            
            {% call history_field('CdE-Mitgliedschaft') %}
                {% call(c) print_multifield_history(['is_member', 'trial_member']) %}
                    {% if entries['is_member'][c] %}
                        {% if entries['trial_member'][c] %}
                            Probemitgliedschaft
                        {% else %}
                            Mitglied
                        {% endif %}
                    {% else %}
                        Kein Mitglied
                    {% endif %}
                {% endcall %}    
            {% endcall %}
            
            {% call history_field('Sichtbarkeit') %}
                {% call(c) print_multifield_history(['is_searchable', 'decided_search']) %}
                    {% if entries['decided_search'][c] %}
                        {% if entries['is_searchable'][c] %}
                            sichtbar
                        {% else %}
                            nicht sichtbar
                        {% endif %}
                    {% else %}
                        (unentschieden)
                    {% endif %}
                {% endcall %}    
            {% endcall %}
            
            {% for name, field in (("Guthaben", 'balance'),
                                   ("Sichtbar für BuB", 'bub_search'),
                                   ("Wolken-Zugriff", 'cloud_account'),
                                   ("Notizen", 'notes')) %}
                {% call history_field(name) %}
                    {{ print_history(field) }}
                {% endcall %}
            {% endfor %}
            
            <h4 class="heading-underline">Kontakt</h4>
            
            {% for name, field in (("E-Mail", 'username'),
                                   ("Telefon", 'telephone'),
                                   ("Mobiltelefon", 'mobile'),
                                   ("WWW", 'weblink')) %}
                {% call history_field(name) %}
                    {{ print_history(field) }}
                {% endcall %}
            {% endfor %}
            
            {% call history_field('Adresse') %}
                {% call(c) print_multifield_history(
                        ['address','address_supplement', 'postal_code', 'location', 'country']) %}
                    {{ entries['address'][c] }}{% if entries['address'][c] %}<br />{% endif %}
                    {{ entries['address_supplement'][c] }}{% if entries['address_supplement'][c] %}<br />{% endif %}
                    {{ entries['postal_code'][c] }} {{ entries['location'][c] }}
                    {% if entries['location'][c] %}<br />{% endif %}
                    {{ entries['country'][c] }}
                {% endcall %}    
            {% endcall %}
            
            {% call history_field('Adresse') %}
                {% call(c) print_multifield_history(
                        ['address2','address_supplement2', 'postal_code2', 'location2', 'country2']) %}
                    {{ entries['address2'][c] }}{% if entries['address2'][c] %}<br />{% endif %}
                    {{ entries['address_supplement2'][c] }}{% if entries['address_supplement2'][c] %}<br />{% endif %}
                    {{ entries['postal_code2'][c] }} {{ entries['location2'][c] }}
                    {% if entries['location2'][c] %}<br />{% endif %}
                    {{ entries['country2'][c] }}
                {% endcall %}    
            {% endcall %}
        
            <h4 class="heading-underline">Lebenslauf</h4>
            
            {% for name, field in (("Fachgebiet", 'specialisation'),
                                   ("Schule, Uni, …", 'affiliation'),
                                   ("Jahrgang, Matrikel, …", 'timeline'),
                                   ("Interessen", 'interests'),
                                   ("Sonstiges …", 'free_form')) %}
                {% call history_field(name) %}
                    {{ print_history(field) }}
                {% endcall %}
            {% endfor %}
            
        </dl>
    </div>
{% endblock %}
