{% extends "web/de/core/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% import "web/de/generic.tmpl" as generic with context %}
{% block scripts %}{{ util.cdedb_script('historycollapse') }}{% endblock %}
{% set jshint='weak' %}
{% block title %}Geschichte von {{ current['given_names']|e }} {{ current['family_name']|e }}{% endblock %}
{% block breadcrumb %}
    {{ util.breadcrumb_link(cdedblink("core/index"), "Start") }}
    {{ util.breadcrumb_link(show_user_link(current['id']), current['given_names'] + " " + current['family_name'],
            icon="user") }}
    {{ util.breadcrumb_link(cdedblink("core/show_history"), "Geschichte", active=True) }}
{% endblock %}
{% set STATUS={enums["MemberChangeStati"].pending: ('pending','check','ausstehend'),
                enums["MemberChangeStati"].committed: ('','',''),
                enums["MemberChangeStati"].superseded: ('superseded', 'refresh', 'obsolet'),
                enums["MemberChangeStati"].nacked: ('nacked', 'ban-circle', 'abgelehnt'),
                enums["MemberChangeStati"].displaced: ('displaced', 'refresh', 'obsolet'),
                -1: ('complicated','question-sign','kompliziert'),} %}
{% macro print_history(f) %}
    {% for c in entries %}
        {% if c not in constants[f] %}
            <div class="row history-row {{ STATUS[eventual_status[f][c]][0] }}">
                <div class="col-xs-3">
                    Gen {{ c }}
                    {% if entries[c]['change_status'] != 1 %}
                        {{ util.make_icon(STATUS[eventual_status[f][c]][1],
                                title=STATUS[eventual_status[f][c]][2]) }}
                    {% endif %}
                </div>
                <div class="col-xs-9">
                    {% if caller %}{{ caller(c) }}{% else %}{{ entries[c][f]|e }}{% endif %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}
{% macro print_multifield_history(fields=[]) %}
    {% for c in entries %}
        {% set vars = {'has_nonconstant' : False, 'eventual_status': None} %}
        {% for f in fields %}
            {% if c not in constants[f] %}
                {{ vars.update({'has_nonconstant' : True})|e }}
                {% if vars['eventual_status'] is none %}
                    {{ vars.update({'eventual_status' : eventual_status[f][c]})|e }}
                {% elif vars['eventual_status'] == eventual_status[f][c] %}
                    {# pass #}
                {% else %}
                    {# Here something complicated happened and we cannot condense it properly
                       so we have to error out. #}
                    {{ vars.update({'eventual_status' : -1})|e }}
                {% endif %}
            {% endif %}
        {% endfor %}
        {% if vars['has_nonconstant'] %}
            <div class="row history-row {{ STATUS[vars['eventual_status']][0] }}">
                <div class="col-xs-3">
                    Gen {{ c }}
                    {% if entries[c]['change_status'] != 1 %}
                        {{ util.make_icon(STATUS[vars['eventual_status']][1],
                                title=STATUS[vars['eventual_status']][2]) }}
                    {% endif %}                </div>
                <div class="col-xs-9">
                    {% if caller %}{{ caller(c) }}{% endif %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}
{% macro history_field(title) %}
    <div class="form-group">
        <label class="col-sm-3">{{ title|e }}</label>
        <div class="col-sm-9 history-container">
            {{ caller() }}
        </div>
    </div>
{% endmacro %}

{% block content %}
    {% if pending|length > 0 %}
        <p>
            {{ util.href(cdedblink('core/inspect_change', {'persona_id': current['id']}), "Änderung prüfen",
                    icon="check", aclass="btn btn-sm btn-info") }}
        </p>
    {% endif %}
    {% if not current['is_active'] %}
        <p class="text-danger">
            Der Benutzer ist deaktiviert.
        </p>
    {% endif %}
    {% if current['is_archived'] %}
        <p class="text-danger">
            Der Benutzer ist archiviert.
        </p>
    {% endif %}

    <script type="text/javascript">
        $(function() {
            $('.history-container').cdedbHistoryCollapse();
        });
    </script>

    <div class="form-horizontal">
        <h4 class="heading-underline">Person</h4>
        {% call history_field('Name') %}
            {% call(c) print_multifield_history(
                    ['title','given_names', 'display_name', 'family_name', 'name_supplement']) %}
                {{ entries[c]['title']|e }}
                {{ util.output_given_displayname(entries[c]['given_names'], entries[c]['display_name']) }}
                {{ entries[c]['family_name']|e }} {{ entries[c]['name_supplement']|e }}
            {% endcall %}
        {% endcall %}

        {% call history_field("Geburtsname") %}
            {{ print_history('birth_name') }}
        {% endcall %}

        {% call history_field("Geburtstag") %}
            {% call(c) print_history('birthday') %}
                 {{ entries[c]['birthday']|date(lang=lang)|e }}
            {% endcall %}
        {% endcall %}

        {% call history_field("Geschlecht") %}
            {% call(c) print_history('gender') %}
                 {{ entries[c]['gender']|gender|e }}
            {% endcall %}
        {% endcall %}


        <h4 class="heading-underline">Account &amp; Mitgliedschaft</h4>

        {% call history_field('Aktiv') %}
            {{ print_history('is_active') }}
        {% endcall %}

        {% call history_field('Bereiche') %}
            {% call(c) print_multifield_history(
                    ['is_cde_realm','is_event_realm', 'is_ml_realm', 'is_assembly_realm']) %}
                {% for bit, desc, icon in (("is_cde_realm", "CdE", "education"),
                                           ("is_event_realm", "Veranstaltungen", "blackboard"),
                                           ("is_ml_realm", "Mailinglisten", "envelope"),
                                           ("is_assembly_realm", "Versammlungen", "bullhorn"),)%}
                    {% if entries[c][bit] %}
                        {{ util.make_icon(icon) }} {{ desc|e }},
                    {% endif %}
                {% endfor %}
            {% endcall %}
        {% endcall %}

        {% call history_field('Admin-Privilegien') %}
            {% call(c) print_multifield_history(['is_admin','is_core_admin','is_cde_admin','is_event_admin',
                                                 'is_ml_admin', 'is_assembly_admin']) %}
                {% set vars = {'any_privilege': False} %}
                {% for bit, desc, icon in (("is_admin", "Super", "wrench"),
                                          ("is_core_admin", "Core", "user"),
                                          ("is_cde_admin", "CdE", "education"),
                                          ("is_event_admin", "Veranstaltungs", "blackboard"),
                                          ("is_ml_admin", "Mailinglisten", "envelope"),
                                          ("is_assembly_admin", "Versammlungs", "bullhorn"),)%}
                    {% if entries[c][bit] %}
                        {{ util.make_icon(icon) }} {{ desc|e }}-Admin,
                        {# Dirty hack to workaround Jinjas set drawbacks #}
                        {% set tmp = vars.update({'any_privilege': True}) %}
                    {% endif %}
                {% endfor %}
                {% if not vars['any_privilege'] %}<i>Keine</i>{% endif %}
            {% endcall %}
        {% endcall %}

        {% call history_field('CdE-Mitgliedschaft') %}
            {% call(c) print_multifield_history(['is_member', 'trial_member']) %}
                {% if entries[c]['is_member'] %}
                    {% if entries[c]['trial_member'] %}
                        Probemitgliedschaft
                    {% else %}
                        Mitglied
                    {% endif %}
                {% else %}
                    Kein Mitglied
                {% endif %}
            {% endcall %}
        {% endcall %}

        {% call history_field('Sichtbarkeit') %}
            {% call(c) print_multifield_history(['is_searchable', 'decided_search']) %}
                {% if entries[c]['decided_search'] %}
                    {% if entries[c]['is_searchable'] %}
                        sichtbar
                    {% else %}
                        nicht sichtbar
                    {% endif %}
                {% else %}
                    (unentschieden)
                {% endif %}
            {% endcall %}
        {% endcall %}

        {% for name, field in (("Guthaben", 'balance'),
                               ("Sichtbar für BuB", 'bub_search'),
                               ("Wolken-Zugriff", 'cloud_account'),
                               ("Notizen", 'notes')) %}
            {% call history_field(name) %}
                {{ print_history(field) }}
            {% endcall %}
        {% endfor %}

        <h4 class="heading-underline">Kontakt</h4>

        {% for name, field in (("E-Mail", 'username'),
                               ("Telefon", 'telephone'),
                               ("Mobiltelefon", 'mobile'),
                               ("WWW", 'weblink')) %}
            {% call history_field(name) %}
                {{ print_history(field) }}
            {% endcall %}
        {% endfor %}

        {% call history_field('Adresse') %}
            {% call(c) print_multifield_history(
                    ['address','address_supplement', 'postal_code', 'location', 'country']) %}
                {{ entries[c]['address'] }}{% if entries[c]['address'] %}<br />{% endif %}
                {{ entries[c]['address_supplement'] }}{% if entries[c]['address_supplement'] %}<br />{% endif %}
                {{ entries[c]['postal_code'] }} {{ entries[c]['location'] }}
                {% if entries[c]['location'] %}<br />{% endif %}
                {{ entries[c]['country'] }}
            {% endcall %}
        {% endcall %}

        {% call history_field('Adresse') %}
            {% call(c) print_multifield_history(
                    ['address2','address_supplement2', 'postal_code2', 'location2', 'country2']) %}
                {{ entries[c]['address2'] }}{% if entries[c]['address2'] %}<br />{% endif %}
                {{ entries[c]['address_supplement2'] }}{% if entries[c]['address_supplement2'] %}<br />{% endif %}
                {{ entries[c]['postal_code2'] }} {{ entries[c]['location2'] }}
                {% if entries[c]['location2'] %}<br />{% endif %}
                {{ entries[c]['country2'] }}
            {% endcall %}
        {% endcall %}

        <h4 class="heading-underline">Lebenslauf</h4>

        {% for name, field in (("Fachgebiet", 'specialisation'),
                               ("Schule, Uni, …", 'affiliation'),
                               ("Jahrgang, Matrikel, …", 'timeline'),
                               ("Interessen", 'interests'),
                               ("Sonstiges …", 'free_form')) %}
            {% call history_field(name) %}
                {{ print_history(field) }}
            {% endcall %}
        {% endfor %}

    </div>
    {# FIXME formatting #}
    <h3>Veränderungen</h4>
    <ul>
        {% for _, entry in entries|xdictsort('generation')|reverse %}
            <li>
                Gen {{ entry['generation']|e }} durch {{ util.persona_anchor(personas[entry['submitted_by']]) }}
                {% if entry['reviewed_by'] %}
                    gesichtet von {{ util.persona_anchor(personas[entry['reviewed_by']]) }}
                {% endif %}
                {{ entry['change_status']|enum(enums['MemberChangeStati'])|e }}
                ({{ entry['ctime']|datetime(lang=lang)|e }}): {{ entry['change_note']|e }}
            </li>
        {% endfor %}
    </ul>
{% endblock %}
