{% set sidenav_active='assembly_show' %}
{% extends "web/de/assembly/base.tmpl" %}
{% block title %}{{ ambience['assembly']['title']|e }}{% endblock %}
{% block breadcrumb %}
    {{ util.breadcrumb_link(cdedblink("assembly/index"), "Versammlungen") }}
    {{ util.breadcrumb_link(cdedblink("assembly/show_assembly"), ambience['assembly']['title'], icon="bullhorn",
            active=True) }}
{% endblock %}
{% block content %}
    <div class="p">
        {% if is_admin and ambience['assembly']['is_active'] %}
            <form action="{{ cdedblink('assembly/conclude_assembly')|e }}" method="POST" id="concludeassemblyform"
                    style="display: inline;">
                {{ util.input_submit(value="Archivieren", readonly=has_activity, aclass="btn btn-sm btn-danger",
                        icon="ban-circle") }}
            </form>
            {{ util.href(cdedblink("assembly/view_log", {'assembly_id': ambience['assembly']['id']}), "Log",
                    icon="list-alt") }}
        {% endif %}
    </div>
    {% if is_admin and now() < ambience['assembly']['signup_end'] %}
        {# FIXME formatting #}
        <div class="panel panel-success">
            <div class="panel-heading">
                <h4 class="panel-title">Externe Teilnehmer hinzufügen</h4>
            </div>
            <div class="panel-body">
                <form action="{{ cdedblink('assembly/external_signup')|e }}" method="POST" id="addattendeeform">
                    <div class="row">
                        <div class="col-sm-7">
                            {{ util.input_text(name="persona_id", placeholder="DB-XXXX-X",
                                    anid="input-add-attendee") }}
                            {# FIXME this is somehow broken :( #}
                            <script type="text/javascript">
                                $('#input-add-attendee').cdedbSearchPerson(
                                    '{{ cdedblink('core/select_persona') + '?kind=pure_assembly_user&phrase=%s'}}',
                                    {{ attendees|list|json }}
                                );
                            </script>
                            {{ util.output_errors('persona_id') }}
                        </div>
                        <div class="col-sm-3">
                            {{ util.input_submit(value="hinzufügen", icon="plus") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}

    <dl class="dl-horizontal">
        <dt>Anmeldeschluss</dt>
        <dd>{{ ambience['assembly']['signup_end']|datetime|e }}</dd>
        <dt>Partizipationsstatus</dt>
        <dd>
            {% if attends %}
                <strong class="text-success">Du nimmst an der Versammlung teil.</strong>
            {% else %}
                <p><strong class="text-muted">Du nimmst nicht teil.</strong></p>
                {% if "member" in user.roles and now() < ambience['assembly']['signup_end'] %}
                    <form action="{{ cdedblink('assembly/signup')|e }}" method="POST" id="signupform">
                        {{ util.input_submit(value="Teilnehmen", icon="log-in") }}
                    </form>
                {% endif %}
            {% endif %}
        </dd>
    </dl>

    {{ ambience['assembly']['description']|rst }}

    {% if is_admin and ambience['assembly']['notes'] %}
        <h3>Admin-Notizen</h3>
        {{ ambience['assembly']['notes']|rst }}
    {% endif %}

    {% call util.bootstrap_panel(title="Dateien", icon='file') %}
            {% if attachments %}
                <ul>
                    {% for attachment_id, attachment in attachments|dictsort %}
                        <li>
                            {{ util.href(cdedblink("assembly/get_attachment", {'attachment_id': attachment_id}),
                                    attachment['title'])}}
                            {% if is_admin %}
                                <form action="{{ cdedblink('assembly/remove_attachment',
                                                           {'attachment_id': attachment_id})|e }}"
                                        method="POST" id="removeattachmentform{{ attachment_id|e }}",
                                        style="display: inline;">
                                    {{ util.input_submit(value="", aclass="btn btn-xs btn-danger", icon="trash",
                                            title="Datei löschen") }}
                                </form>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if is_admin %}
                {{ util.href(cdedblink("assembly/add_attachment_form"), "Datei anhängen",
                             aclass="btn btn-success btn-sm", icon="plus") }}
            {% endif %}
    {% endcall %}
{% endblock %}
