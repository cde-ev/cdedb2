{% set sidenav_active='assembly_ballots' %}
{% extends "web/de/assembly/base.tmpl" %}
{% block scripts %}{{ util.jquery_with_ui_preamble() }}{% endblock %}
{% block javascripthint %}{{ util.javascript_hint() }}{% endblock %}
{% block title %}{{ ambience['ballot']['title']|e }} ({{ ambience['assembly']['title']|e }}){% endblock %}
{% block content %}
    <p>{{ ambience['ballot']['description']|rst }}</p>
    <p>
        Abstimmungszeitraum: {{ ambience['ballot']['vote_begin']|datetime|e }} bis {{ ambience['ballot']['vote_end']|datetime|e }}<br>
        {% if ambience['ballot']['extended'] is none %}
            {% if ambience['ballot']['quorum'] %}
                Falls das Quorum von {{ ambience['ballot']['quorum']|e }} Stimmen nicht erreicht wird, wird die Abstimmung bis
                {{ ambience['ballot']['vote_extension_end']|datetime|e }} verlängert.
            {% endif %}
        {% else %}
            {% if ambience['ballot']['extended'] %}
                Die Abstimmung hat das Quorum von {{ ambience['ballot']['quorum']|e }} Stimmen nicht erreicht, und wurde bis
                {{ ambience['ballot']['vote_extension_end']|datetime|e }} verlängert.
            {% elif ambience['ballot']['quorum'] %}
                Die Abstimmung hat das Quorum von {{ ambience['ballot']['quorum']|e }} Stimmen erreicht und wurde nicht
                verlängert.
            {% endif %}
        {% endif %}
    </p>
    {% if is_admin %}
        <p>Notizen: {{ ambience['ballot']['notes']|rst }}</p>
    {% endif %}
    {% if is_admin and now() < ambience['ballot']['vote_begin']  %}
        <p>
            {{ util.href(cdedblink("assembly/change_ballot_form"), "Bearbeiten")}}
            <form action="{{ cdedblink('assembly/delete_ballot')|e }}" method="POST"
             class="jsConfirmed" id="deleteballotform">
                <div>
                    {{ util.form_input_checkbox(name="ack_delete", label="Ich bin mir sicher") }}
                    {{ util.form_input_submit(value="Löschen") }}
                </div>
            </form>
            <form action="{{ cdedblink('assembly/add_candidate')|e }}" method="POST" id="addcandidateform">
                <table>
                    {{ util.form_input_text(name="moniker", label="Kurzname") }}
                    {{ util.form_input_text(name="description", label="Beschreibung") }}
                </table>
                <div>
                    {{ util.form_input_submit(value="Option hinzufügen") }}
                </div>
            </form>
        </p>
    {% endif %}
    {% if ambience['ballot']['votes'] %}
        <p>
            {% if not attends %}
                Du nimmst nicht an der Versammlung teil.
            {% elif not values['vote'] %}
                {% if ambience['assembly']['is_active'] %}
                    Du hast noch nicht abgestimmt.
                {% endif %}
            {% else %}
                {% if split_vote|length == 1 %}
                    Du hast Dich enthalten.
                {% elif split_vote|length == 2 %}
                    Du hast Dich gegen alle Kandidaten entschieden.
                {% else %}
                    Du hast für folgende Kandidaten gestimmt:
                    <ul>
                        {% for voted in split_vote[0] %}
                            <li>
                                {{ candidates[voted]['description']|e }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endif %}
        </p>
        {% if ambience['ballot']['is_voting'] %}
            <form action="{{ cdedblink('assembly/vote') }}" method="POST" id="voteform">
                <div>
                    {% if ambience['ballot']['votes'] == 1 %}
                        {# jinja does not support list comprehension ... #}
                        {% set myentries = [("special: none", "keiner der Kandidaten")] %}
                        {% for candidate_id, cdata in ambience['ballot']['candidates']|dictsort %}
                            {% if candidate_id != ambience['ballot']['bar'] %}
                                {{ myentries.append((cdata['moniker'], cdata['description']))|e }}
                            {% endif %}
                        {% endfor %}
                        {{ util.form_input_checkboxes("vote", label="Kandidaten", entries=myentries, radio=True) }}
                    {% else %}
                        {# jinja does not support list comprehension ... #}
                        {% set myentries = [] %}
                        {% for candidate_id, cdata in ambience['ballot']['candidates']|dictsort %}
                            {% if candidate_id != ambience['ballot']['bar'] %}
                                {{ myentries.append((cdata[ 'moniker'], cdata['description']))|e }}
                            {% endif %}
                        {% endfor %}
                        {{ util.form_input_checkboxes("vote", label="Kandidaten", entries=myentries) }}
                    {% endif %}
                    {{ util.form_input_submit(value="Abstimmen") }}
                </div>
            </form>
            {% if ambience['ballot']['votes'] > 1 %}
                <form action="{{ cdedblink('assembly/vote') }}" method="POST" id="rejectionform">
                    <div>
                        {{ util.input_hidden(name="vote", value="special: none") }}
                        {{ util.form_input_submit(value="Keiner der Kandidaten") }}
                    </div>
                </form>
            {% endif %}
            <form action="{{ cdedblink('assembly/vote') }}" method="POST" id="abstentionform">
                <div>
                    {{ util.input_hidden(name="vote", value="special: abstain") }}
                    {{ util.form_input_submit(value="Enthalten") }}
                </div>
            </form>
        {% elif ambience['ballot']['is_tallied'] %}
            <p>{{ util.href(cdedblink("assembly/get_result"), "Ergebnisdatei herunterladen")}}</p>
            {% if len(result['winners']) <= ambience['ballot']['votes'] %}
                <h3>Gewählte Kandidaten</h3>
                <p>
                    <ul>
                        {% for candidate_id, cdata in ambience['ballot']['candidates']|dictsort %}
                            {% if candidate_id in result['winners'] %}
                                <li><strong>{{ cdata['moniker']|e }}</strong> {{ cdata['description']|e }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </p>
                <h3>Nicht-gewählte Kandidaten</h3>
                <p>
                    <ul>
                        {% for candidate_id, cdata in ambience['ballot']['candidates']|dictsort %}
                            {% if candidate_id not in result['winners'] and candidate_id != ambience['ballot']['bar'] %}
                                <li><strong>{{ cdata['moniker']|e }}</strong> {{ cdata['description']|e }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </p>
            {% else %}
                <p>Das Ergebnis ist leider nicht aussagekräftig (zu viele Gewinner).</p>
            {% endif %}
        {% else %}
            <h3>Kandidatenliste</h3>
            <p>
                <ul>
                    {% for candidate_id, cdata in ambience['ballot']['candidates']|dictsort %}
                        {% if candidate_id != ambience['ballot']['bar'] or is_admin %}
                            <li>
                                <strong>{{ cdata['moniker']|e }}</strong> {{ cdata['description']|e }}
                                {% if is_admin and now() < ambience['ballot']['vote_begin'] %}
                                    <form action="{{ cdedblink('assembly/remove_candidate',
                                                               {'candidate_id': candidate_id})|e }}"
                                     method="POST" id="removecandidateform{{ candidate_id|e }}">
                                        <div>
                                            {{ util.form_input_submit(value="Löschen") }}
                                        </div>
                                    </form>
                                {% endif %}
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </p>
        {% endif %}
    {% else %}
        <h3>Kandidatenliste</h3>
        <p>
            <ul>
                {% for candidate_id, cdata in ambience['ballot']['candidates']|dictsort %}
                    <li>
                        <strong>{{ cdata['moniker']|e }}</strong> {{ cdata['description']|e }}
                        {% if is_admin and now() < ambience['ballot']['vote_begin'] %}
                            <form action="{{ cdedblink('assembly/remove_candidate',
                                                       {'candidate_id': candidate_id})|e }}"
                             method="POST" id="removecandidateform{{ candidate_id|e }}">
                                <div>
                                    {{ util.form_input_submit(value="Löschen") }}
                                </div>
                            </form>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            {% if ambience['ballot']['bar'] %}
                Die Option {{ ambience['ballot']['candidates'][ambience['ballot']['bar']]['moniker']|e }} ist hierbei die
                Schwellwertoption.
            {% endif %}
        </p>
        {% if ambience['ballot']['is_voting'] %}
            <p>
                {% if not attends %}
                    Du nimmst nicht an der Versammlung teil.
                {% elif values['vote'] %}
                    Du hast mit {{ values['vote']|e }} gestimmt.
                {% elif ambience['assembly']['is_active'] %}
                    Du hast noch nicht abgestimmt.
                {% endif %}
            </p>
            {# TODO do something nice and interactive here (with drag and drop ...) #}
            <form action="{{ cdedblink('assembly/vote') }}" method="POST" id="voteform">
                <div>
                    {{ util.form_input_text(name="vote", label="Präferenzliste") }}
                    {{ util.form_input_submit(value="Abstimmen") }}
                </div>
            </form>
        {% elif ambience['ballot']['is_tallied'] %}
            <p>{{ util.href(cdedblink("assembly/get_result"), "Ergebnisdatei herunterladen")}}</p>
        {% endif %}
    {% endif %}
    {% if attachments %}
        <h2>Verfügbare Dateien</h2>
        <ul>
            {% for attachment_id, adata in attachments|dictsort %}
                <li>
                    {{ util.href(cdedblink("assembly/get_attachment", {'attachment_id': attachment_id}),
                                           adata['title'])}}
                    {% if is_admin and now() < ambience['ballot']['vote_begin'] %}
                        <form action="{{ cdedblink('assembly/remove_attachment', {'attachment_id': attachment_id})|e }}"
                         method="POST" id="removeattachmentform{{ attachment_id|e }}">
                            <div>
                                {{ util.form_input_submit(value="Löschen") }}
                            </div>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}
    {% if is_admin and now() < ambience['ballot']['vote_begin'] %}
        {{ util.href(cdedblink("assembly/add_attachment_form", {'ballot_id': ambience['ballot']['id']}), "Datei anhängen")}}
    {% endif %}
{% endblock %}
