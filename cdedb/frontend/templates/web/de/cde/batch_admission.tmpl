{% set sidenav_active='cde_manage_users' %}
{% extends "web/de/cde/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block title %}Accounts anlegen{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("cde/index"), "CdE") }}
{{ util.breadcrumb_link(cdedblink("cde/user_search"), "Nutzer verwalten") }}
{{ util.breadcrumb_link(cdedblink("cde/batch_admission_form"), "Massenaufnahme", active=True) }}
{% endblock %}
{% block content %}
    <form action="{{ cdedblink('cde/batch_admission')|e }}" method="POST" id="admissionform">
        {{ util.input_hidden("finalized") }}
        <div class="row">
            <div class="col-md-6">
                {{ util.form_input_checkbox("membership", label="CdE-Mitgliedschaft eintragen", horizontal=False) }}
                {{ util.form_input_checkbox("trial_membership", label="Probemitgliedschaft gutschreiben", horizontal=False) }}
            </div>
            <div class="col-md-6">
                {{ util.form_input_checkbox("consent", label="Datenschutzeinwilligung gegeben", horizontal=False) }}
                {{ util.form_input_checkbox("sendmail", label="Willkommensmail verschicken", horizontal=False) }}
            </div>
        </div>
        {{ util.form_input_textarea(name="accounts", label="Daten",
                info='Hier einen Datensatz pro Zeile eingeben.', horizontal=False, rows=8) }}
                               
        <p class="help-block">
            <span class="glyphicon glyphicon-info-sign"></span> Das Format ist
        </p>
        <pre>&quot;Akademie&quot;;&quot;Kurs&quot;;&quot;Nachname&quot;;&quot;Vorname&quot;;&quot;Titel&quot;;<!--
-->&quot;Namenszusatz&quot;;&quot;Geburtsname&quot;;&quot;Geschlecht&quot;;&quot;Adresszusatz&quot;;<!--
-->&quot;Straße&quot;;&quot;Postleitzahl&quot;;&quot;Wohnort&quot;;&quot;Land&quot;;<!--
-->&quot;Telefonnummer&quot;;&quot;Mobilnummer&quot;;&quot;Email&quot;;&quot;Geburtstag&quot;</pre>
        <p class="help-block">
            Bei Geschlecht 0 für weiblich, 1 für männlich und 2 für alles andere eintragen.
        </p>
        {% for dataset in data %}
            <div>
                {{ util.input_hidden("hash{}".format(dataset['lineno'] - 1)) }}
                Zeile {{ dataset['lineno']|e }} für Eintrag {{ dataset['raw']['given_names']|e }}
                {{ dataset['raw']['family_name']|e }}, {{ dataset['raw']['username']|e }},
                geb. am {{ dataset['raw']['birthday']|e }}.<br>
                {% if dataset['problems'] or dataset['warnings'] %}
                    Die folgenden Probleme sind in dieser Zeile aufgetreten.
                    <ul>
                        {% for key, problem in dataset['problems'] %}
                            <li>Problem{% if key %} bei {{ key|e }}{% endif %}: {{ i18n(problem|string)|e }}</li>
                        {% endfor %}
                        {% for key, warning in dataset['warnings'] %}
                            <li>Warnung{% if key %} bei {{ key|e }}{% endif %}: {{ i18n(warning|string)|e }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {# jinja does not support list comprehension ... #}
                {% set myentries = [] %}
                {% for resolution in enums['LineResolutions'] %}
                    {{ myentries.append((resolution.value, i18n(resolution|string)))|e }}
                {% endfor %}
                {{ util.form_input_checkboxes("resolution{}".format(dataset['lineno'] - 1), myentries, label="Aktion",
                        radio=True) }}
                {% if dataset['doppelgangers'] %}
                    Die folgenden Accounts sind diesem ähnlich. Wähle einen
                    aus, um ihn mit der passenden Aktion zu modifizieren.
                    {# jinja does not support list comprehension ... #}
                    {% set myentries = [('', '--')] %}
                    {% for key, value in dataset['doppelgangers']|dictsort %}
                        {% with description = "{} {} ({}), {}, geb. am {}, ID {} ({})".format(
                                value['given_names'], value['family_name'], value['birth_name'] or value['family_name'],
                                value['username'], value['birthday'], key|cdedbid,
                                'Mitglied' if value['is_member'] else 'kein Mitglied') %}
                            {{ myentries.append((key, description))|e }}
                        {% endwith %}
                    {% endfor %}
                    {{ util.form_input_checkboxes("doppelganger_id{}".format(dataset['lineno'] - 1), myentries,
                            label="Mögliche Duplikate", info='Accounts die dem gegebenen ähnlich sehen', radio=True) }}
                {% endif %}
            </div>
        {% endfor %}
        <div>
            {% if values['finalized'] %}
                {{ util.form_input_submit(value="Anlegen", horizontal=False) }}
            {% else %}
                {{ util.form_input_submit(value="Validieren", horizontal=False) }}
            {% endif %}
        </div>
    </form>
{% endblock %}
