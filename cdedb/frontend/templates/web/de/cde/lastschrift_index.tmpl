{% set sidenav_active='cde_lastschrift' %}
{% extends "web/de/cde/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('helper') }}{% endblock %}
{% block title %}Übersicht Einzugsermächtigungen{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("cde/index"), "CdE") }}
{{ util.breadcrumb_link(cdedblink("cde/lastschrift_index"), "Einzugsermächtigungen", active="True") }}
{% endblock %}
{% block content %}
    <script type="text/javascript">
        $(function() {
            $('.skip-form').cdedbProtectAction();
            $('.failure-form').cdedbProtectAction();
            $('.success-form').cdedbProtectAction();
        });
    </script>
    
    <h2>Offene Einzugsermächtigungen</h2>
    <p>
        Im Laufe dieses Semesters – und dabei möglichst früh, aber erst nach der Zahlungsinformation – sind noch
        folgende Lastschriften auszuführen. Dazu eine dtx-Datei generieren und in die Online-Banking-Software
        importieren.
    </p>
    
    <table class="table table-condensed">
        <thead>
            <tr><th>Mitglied</th><th></th><th></th></tr>
        </thead>
        <tbody>
        {% for lastschrift_id, lastschrift in lastschrift_data|dictsort %}
            {% if lastschrift['open'] %}
               <tr>
                    <td>
                        {{ util.persona_anchor(persona_data[lastschrift['persona_id']]) }}
                        ({{ util.href(cdedblink('cde/lastschrift_show', {'persona_id': lastschrift['persona_id']}),
                                    "Ermächtigung", icon="euro") }})
                    </td>
                    <td>
                        <form action="{{ cdedblink('cde/lastschrift_generate_transactions')|e }}" method="POST"
                                id="generatetransactionform{{ lastschrift_id|e }}">
                            {{ util.input_hidden(name="lastschrift_id", value=lastschrift_id) }}
                            <button type="submit" class="btn btn-xs btn-default">
                                <span class="glyphicon glyphicon-download"></span> Einzeldatei
                            </button>
                        </form>
                    </td>
                    <td>
                        <form action="{{ cdedblink('cde/lastschrift_skip', {'lastschrift_id': lastschrift_id})|e }}"
                                method="POST" id="skiptransactionform{{ lastschrift_id|e }}" class="skip-form">
                            {{ util.input_hidden(name="lastschrift_id", value=lastschrift_id) }}
                            <button type="submit" class="btn btn-xs btn-warning">
                                <span class="glyphicon glyphicon-pause"></span> Pausieren
                            </button>
                        </form>
                    </td>
               </tr>
            {% endif %}
        {% endfor %}
        </tbody>
    </table>
    
    <form action="{{ cdedblink('cde/lastschrift_generate_transactions')|e }}" method="POST"
      id="generatetransactionsform">
        <button type="submit" class="btn btn-primary">
            <span class="glyphicon glyphicon-download"></span> SEPA-Datei generieren
        </button>
    </form>
    
    <h2>Offene Einzüge</h2>
    <p>
        Folgende Einzüge befinden sich derzeit in der Schwebe. Sobald diese ausgeführt wurden, bitte hier eintragen, ob
        diese erfolgreich ausgeführt wurden, gar nicht ausgeführt wurden oder geplatzt sind. Im letzteren Falle wird die
        Ermächtigung als Widerrufen angesehen.
    </p>
    <table class="table table-condensed">
        <thead>
            <tr><th>Mitglied</th><th>Datum</th><th>Betrag</th><th></th><th></th><th></th></tr>
        </thead>
        <tbody>
        {% for transaction_id, transaction in transaction_data|xdictsort('issued_at')|reverse %}
            <tr>
                <td>
                {{ util.persona_anchor(persona_data[lastschrift_data[transaction['lastschrift_id']]['persona_id']]) }}
                </td>
                <td>{{ transaction['issued_at']|datetime|e }}</td>
                <td>{{ transaction['amount']|e }}€</td>
                <td>
                    <form action="{{ cdedblink('cde/lastschrift_finalize_transaction', 
                                               {'lastschrift_id': transaction['lastschrift_id'], 
                                                'transaction_id': transaction_id})|e }}" method="POST"
                            id="transactionsuccessform{{ transaction_id|e }}" class="success-form">
                        {{ util.input_hidden(name="transaction_id", value=transaction_id) }}
                        {{ util.input_hidden(name="status",
                                value=enums['LastschriftTransactionStati'].success.value) }}
                    </form>
                </td>
                <td>
                    <form action="{{ cdedblink('cde/lastschrift_finalize_transaction', 
                                               {'lastschrift_id': transaction['lastschrift_id'], 
                                                'transaction_id': transaction_id})|e }}" method="POST"
                            id="transactioncancelform{{ transaction_id|e }}">
                        {{ util.input_hidden(name="transaction_id", value=transaction_id) }}
                        {{ util.input_hidden(name="status",
                                value=enums['LastschriftTransactionStati'].cancelled.value) }}
                        <button type="submit" class="btn btn-xs btn-danger">
                            <span class="glyphicon glyphicon-remove"></span> Abbruch
                        </button>
                    </form>
                </td>
                <td>
                    <form action="{{ cdedblink('cde/lastschrift_finalize_transaction', 
                                               {'lastschrift_id': transaction['lastschrift_id'], 
                                                'transaction_id': transaction_id})|e }}" method="POST"
                            id="transactionfailureform{{ transaction_id|e }}" class="failure-form">
                        {{ util.input_hidden(name="transaction_id", value=transaction_id) }}
                        {{ util.input_hidden(name="status", value=enums['LastschriftTransactionStati'].failure.value) }}
                        <button type="submit" class="btn btn-xs btn-danger">
                            <span class="glyphicon glyphicon-exclamation-sign"></span> Geplatzt
                        </button>
                    </form>
                </td>
           </tr>
        {% endfor %}
        </tbody>
    </table>

    <h2>Alle aktiven Einzugsermächtigungen</h2>
    <ul>
        {% for lastschrift_id, lastschrift in lastschrift_data|dictsort %}
           <li>
                {{ util.persona_anchor(persona_data[lastschrift['persona_id']]) }}
                ({{ util.href(cdedblink('cde/lastschrift_show', {'persona_id': lastschrift['persona_id']}),
                              "Ermächtigung") }})
           </li>
        {% endfor %}
    </ul>
{% endblock %}
