{# FIXME navigation and formatting #}
{% set sidenav_active='cde_manage_users' %}
{% extends "web/de/cde/base.tmpl" %}
{% import "web/de/util.tmpl" as util with context %}
{% block title %}Überweisungen eintragen{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("cde/index"), "CdE") }}
{{ util.breadcrumb_link(cdedblink("cde/user_search"), "Nutzer verwalten") }}
{{ util.breadcrumb_link(cdedblink("cde/batch_admission_form"), "Massenaufnahme", active=True) }}
{% endblock %}
{% block content %}
    <form action="{{ cdedblink('cde/money_transfers')|e }}" method="POST" id="transfersform">
        {{ util.input_hidden("checksum") }}
        <div class="row">
            {{ util.form_input_checkbox("sendmail", label="Benachritigung verschicken", horizontal=False) }}
        </div>
        {{ util.form_input_textarea(name="transfers", label="Daten", horizontal=False, rows=8) }}

        <p class="help-block">
            <span class="glyphicon glyphicon-info-sign"></span> Bitte einen Datensatz pro Zeile einfügen. Das Format ist
        </p>
        <pre>&quot;ID&quot;;&quot;Nachname&quot;;&quot;Vorname&quot;;&quot;Betrag&quot;;&quot;Kommentar&quot;</pre>
        <p class="help-block">
            <span class="glyphicon glyphicon-info-sign"></span> Der Kommentar ist optional.
        </p>

        {% if data %}
            <h2>Validierungsergebnisse</h2>
            {% for dataset in data %}
                <strong>
                    Zeile {{ dataset['lineno']|e }}: {{ dataset['amount']|money }} für
                    {{ dataset['raw']['given_names']|e }} {{ dataset['raw']['family_name']|e }}
                </strong>
                <div class="batch-line-body">
                    {% if dataset['problems'] or dataset['warnings'] %}
                        <ul class="list-unstyled"">
                            {% for key, problem in dataset['problems'] %}
                                <li class="text-danger">
                                    {{ util.make_icon('exclamation-sign', title="Fehler") }}
                                    {% if key %}<em>{{ key|e }}</em>:{% endif %}
                                    {{ i18n(problem|string)|e }}
                                </li>
                            {% endfor %}
                            {% for key, warning in dataset['warnings'] %}
                                <li class="text-warning">
                                    {{ util.make_icon('warning-sign', title="Warnung") }}
                                    {% if key %}<em>{{ key|e }}</em>:{% endif %}
                                    {{ i18n(warning|string)|e }}
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {% if values['checksum'] %}
            <p class="help-block">
                <span class="glyphicon glyphicon-info-sign"></span> Falls die Eingabe geändert wird, wird das Validierungsergebnis erneut angezeigt.
            </p>
            {{ util.form_input_submit(value="Abschicken", horizontal=False) }}
        {% else %}
            {{ util.form_input_submit(value="Validieren", horizontal=False) }}
        {% endif %}
    </form>
{% endblock %}
