{% set sidenav_active='assembly_ballots' %}
{% extends "web/assembly/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% import "web/assembly/_ballot_meta.tmpl" as ballot_meta with context %}
{% import "web/assembly/_ballot_result.tmpl" as ballot_result with context %}
{% import "web/assembly/_ballot_voting.tmpl" as ballot_voting with context %}

{% block scripts %}
    {{ util.cdedb_script('cdedb_helper.js') }}
    {{ util.cdedb_script('cdedb_voting.js') }}
    {{ util.cdedb_script('cdedb_dynamicrow.js') }}
{% endblock %}

{% set jshint = 'weak' %}
{% block title %}{{ ambience['ballot']['title'] }} ({{ ambience['assembly']['title'] }}){% endblock %}

{% block heading %}
    <h1 class="title">
        {{ ambience['ballot']['title'] }}
    </h1>
{% endblock %}

{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("assembly/show_assembly"), ambience['assembly']['title'], icon="bullhorn") }}
    {{ util.breadcrumb_link(cdedblink("assembly/list_ballots"), gettext("Ballots")) }}
    {{ util.breadcrumb_link(cdedblink("assembly/show_ballot"), ambience['ballot']['title'], icon="thumbs-up",
                            active=True) }}
{% endblock %}

{% block content %}
    {% set edit_mode = "assembly_presider" in user.admin_views and now() < ambience['ballot']['vote_begin'] %}
    {% set classical = ambience['ballot']['votes'] %}
    {% set preferential = not ambience['ballot']['votes'] %}

    {# Admin modification options (delete and edit) #}
    {% if edit_mode %}
        <div class="p">
            {{ util.href(cdedblink("assembly/change_ballot_form"), gettext("Edit"), icon="pen",
                    aclass="btn btn-sm btn-warning") }}
            {% if CDEDB_DEV %}
                <form action="{{ cdedblink("assembly/ballot_start_voting") }}" method="POST"
                      id="startvotingform" style="display: inline;">
                    {{ util.anti_csrf_token("assembly/ballot_start_voting") }}
                    {{ util.input_submit(value=gettext("Start Voting"), aclass="btn btn-sm btn-success",
                            icon="check-square") }}
                </form>
            {% endif %}
        </div>
    {% endif %}

    {# General information about ballot and personalized state info #}
    {{ ambience['ballot']['description']|md }}

    {{ ballot_meta.show_status() }}

    {# Display of result #}
    {% if ambience['ballot']['is_tallied'] %}
        <h3>{% trans %}Result{% endtrans %}</h3>
        {{ ballot_result.show_result(ambience['ballot'], result) }}
        {{ ballot_result.explain_result(classical=classical, preferential=preferential, use_bar=ambience['ballot']['use_bar']) }}

        <h4>{% trans %}Summary{% endtrans %}</h4>
        {% if preferential  %}
            {{ ballot_result.show_summary() }}
        {% endif %}
        <p>{{ util.href(cdedblink("assembly/get_result"), gettext("Download Results"), icon="download") }}</p>

        {{ ballot_result.show_own_vote() }}
    {% else %}
        {% if edit_mode %}
            {{ ballot_voting.add_candidate_form() }}
        {% else %}
            {# Classical voting, not tallied #}
            {% if ambience['ballot']['votes'] %}
                {% if ambience['ballot']['is_voting'] and attends %}
                    {{ ballot_voting.show_classical_voting() }}
                {% else %}
                    {{ ballot_voting.show_classical_candidates() }}
                {% endif %}
            {# Preferential voting, not tallied #}
            {% else %}
                {{ ballot_voting.show_preferential_candidates() }}
                {% if ambience['ballot']['is_voting'] and attends %}
                    {{ ballot_voting.show_preferential_voting() }}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}


    {% if attachments or edit_mode %}
        <br />
        {{ ballot_meta.show_attachments(edit_mode) }}
    {% endif %}
    {{ ballot_meta.show_navigation() }}

    {% if edit_mode %}
        {{ ballot_meta.ballot_action_panel() }}
    {% endif %}
{% endblock %}
