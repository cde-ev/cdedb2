{% set sidenav_active='assembly_show' %}
{% extends "web/assembly/base.tmpl" %}
{% block scripts %}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% set jshint = 'weak' %}
{% block title %}{{ ambience['assembly']['title'] }}{% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("assembly/show_assembly"), ambience['assembly']['title'], icon="glyphicon-bullhorn",
            active=True) }}
{% endblock %}
{% block content %}
    <div class="p">
        {% if is_admin and ambience['assembly']['is_active'] %}
            {{ util.href(cdedblink('assembly/change_assembly'), gettext("Configuration"), aclass="btn btn-sm btn-warning",
                         icon="glyphicon-cog") }}
        {% endif %}
    </div>

    <div id="description">
        {{ ambience['assembly']['description']|md }}
    </div>

    <dl class="dl-horizontal">
        <dt>{% trans %}Participation Deadline{% endtrans %}</dt>
        <dd id="participation-deadline">
            {{ ambience['assembly']['signup_end']|datetime(lang=lang) }}
        </dd>
        <dt>{% trans %}Participation Status{% endtrans %}</dt>
        <dd id="participation-status">
            {% if attends %}
                <strong class="text-success">{% trans %}You are participating in this assembly.{% endtrans %}</strong>
            {% else %}
                <p><strong class="text-muted">{% trans %}You are not participating.{% endtrans %}</strong></p>
                {% if "member" in user.roles and now() < ambience['assembly']['signup_end'] %}
                    <form action="{{ cdedblink('assembly/signup') }}" method="POST" id="signupform">
                        {{ util.anti_csrf_token('assembly/signup') }}
                        {{ util.input_submit(value=gettext("Participate"), icon="glyphicon-log-in") }}
                    </form>
                {% endif %}
            {% endif %}
        </dd>
    </dl>

    {% if is_admin and ambience['assembly']['notes'] %}
        {% call util.bootstrap_panel(title=gettext("Admin-Notes"), icon="glyphicon-tag", aclass="panel-default panel-condensed") %}
            <div id="notes">
                {{ ambience['assembly']['notes']|md }}
            </div>
        {% endcall %}
    {% endif %}

    {% if attachments or is_admin or has_ballot_attachments %}
        {% call util.bootstrap_panel(title=gettext("Files"), icon='glyphicon-file') %}
        <div class="row">
            {% if attachments or is_admin %}
                <div class="col-sm-6">
                    <h4>{% trans %}General Files{% endtrans %}</h4>
                    <ul class="slim" id="attachments">
                        {% for attachment_id, attachment in attachments|xdictsort("title") %}
                            <li class="hide-hover-container clearfix-after">
                                {{ util.href(cdedblink("assembly/get_attachment", {'attachment_id': attachment_id}),
                                        attachment['title']) }}
                                {% if is_admin %}
                                    <form action="{{ cdedblink('assembly/remove_attachment',
                                                               {'attachment_id': attachment_id}) }}"
                                            method="POST" id="removeattachmentform{{ attachment_id }}",
                                            class="hide-hover display-inline">
                                        {{ util.anti_csrf_token('assembly/remove_attachment') }}
                                        {{ util.input_checkbox("attachment_ack_delete", gettext("Are you sure?")) }}
                                        {{ util.input_submit(value="", aclass="btn btn-xs btn-danger list-button-float", icon="glyphicon-trash",
                                                title=gettext("Delete File")) }}
                                    </form>
                                    <script type="text/javascript" nonce="{{ csp_nonce }}">
                                        $('#removeattachmentform{{ attachment_id }}').cdedbProtectAction("{{ gettext("The attachment will be permanently deleted.") }}");
                                        $('#removeattachmentform{{ attachment_id }}').find('[name="attachment_ack_delete"]').prop('checked', true).parent().hide();
                                    </script>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                    {% if is_admin %}
                        <div class="p">
                            {{ util.href(cdedblink("assembly/add_attachment_form"), gettext("Attach File"),
                                         aclass="btn btn-success btn-sm", icon="glyphicon-plus") }}
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            {% if has_ballot_attachments %}
                <div class="col-sm-6">
                <h4>{% trans %}Ballot Files{% endtrans %}</h4>
                    {% for ballot_id, ballot in ballots|xdictsort('title') %}
                        {% if ballot_attachments[ballot_id] %}
                            <ul class="slim">
                                {% for battachment_id, battachment in ballot_attachments[ballot_id]|xdictsort('title') %}
                                    <li>
                                        {{ util.href(cdedblink("assembly/get_attachment",
                                                     {'attachment_id': battachment_id, 'ballot_id': ballot_id}),
                                                     battachment['title']) }}
                                        (<small class="text-muted">
                                            {{- util.make_icon('thumbs-up', arialabel=gettext("ballot_file_arialabel")) }}
                                            {{ ballot['title'] -}}
                                         </small>)
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        {% endcall %}
    {% endif %}

    {% if is_admin %}
        {% if ambience['assembly']['is_active'] or "vote_begin" not in delete_blockers %}
            {% call util.bootstrap_panel(title=gettext("Actions"), icon="glyphicon-warning-sign", aclass="panel-danger mosp") %}
                {% if ambience['assembly']['is_active'] %}
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="p">
                                <form action="{{ cdedblink('assembly/conclude_assembly') }}" method="POST"
                                      id="concludeassemblyform" style="display: inline;">
                                    {{ util.anti_csrf_token('assembly/conclude_assembly') }}
                                    {{ util.input_submit(value=gettext("Archive"), readonly="ballot" in conclude_blockers, aclass="btn btn-danger",
                                            icon="glyphicon-folder-close", title=gettext("Assembly still has open ballots.") if "ballot" in conclude_blockers else "") }}
                                    {{ util.input_checkbox(name="ack_conclude", label=gettext("Are you sure?")) }}
                                </form>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted">
                                {% trans %}
                                    Archives the assembly. The configuration cannot be changed after this.
                                    The private keys used to sign the votes will be deleted from the database.
                                    This should typically be done shortly after all ballots have been conlcuded.
                                {% endtrans %}
                            </p>
                        </div>
                    </div>
                {% endif %}
                {% if "vote_begin" not in delete_blockers %}
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="p">
                                <form action="{{ cdedblink('assembly/delete_assembly') }}" method="POST"
                                      id="deleteassemblyform" style="display: inline;">
                                    {{ util.anti_csrf_token('assembly/delete_assembly') }}
                                    {{ util.input_submit(value=gettext("Delete"), aclass="btn btn-danger", icon="glyphicon-trash") }}
                                    {{ util.input_checkbox(name="ack_delete", label=gettext("Are you sure?")) }}
                                </form>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted">
                                {% trans %}
                                    Permanently deletes the assembly including all ballots and attendee information.
                                    This is only possible while no ballots have begun voting.
                                {% endtrans %}
                            </p>
                        </div>
                    </div>
                {% endif %}
            {% endcall %}
            <script type="text/javascript" nonce="{{ csp_nonce }}">
                $(function() {
                    $('#concludeassemblyform').cdedbProtectAction("{{ gettext("The assembly will be permanently archived.") }}");
                    $('#concludeassemblyform').find('[name="ack_conclude"]').prop('checked', true).parent().hide();
                    $('#deleteassemblyform').cdedbProtectAction("{{ gettext("The assembly will be permanently deleted.") }}");
                    $('#deleteassemblyform').find('[name="ack_delete"]').prop('checked', true).parent().hide();
                });
            </script>
        {% endif %}
    {% endif %}

{% endblock %}
