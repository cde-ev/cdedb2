{% set sidenav_active='assembly_show' %}
{% extends "web/assembly/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% import "web/assembly/util.tmpl" as assembly_util with context %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_helper.js') }}
    {{ util.cdedb_script('cdedb_searchpersona.js') }}
{% endblock %}
{% set jshint = 'weak' %}
{% block title %}{{ ambience['assembly']['title'] }}{% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("assembly/show_assembly"), ambience['assembly']['title'], icon="bullhorn",
            active=True) }}
{% endblock %}
{% block content %}
    <div class="p">
        {% if ambience['assembly']['is_active'] and ("assembly_presider" in user.admin_views
                                                     or ambience['assembly']['id'] in user.presider) %}
            {{ util.href(cdedblink('assembly/change_assembly'), gettext("Configuration"), aclass="btn btn-sm btn-warning",
                         icon="cog") }}
        {% endif %}
    </div>

    <div id="description">
        {{ ambience['assembly']['description']|md }}
    </div>

    <dl class="dl-horizontal">
        <dt>{% trans %}Participation Deadline{% endtrans %}</dt>
        <dd id="participation-deadline">
            {{ ambience['assembly']['signup_end']|datetime(lang=lang) }}
        </dd>
        <dt>{% trans %}Participation Status{% endtrans %}</dt>
        <dd id="participation-status">
            {% if attends %}
                <strong class="text-success">{% trans %}You are participating in this assembly.{% endtrans %}</strong>
            {% else %}
                <p><strong class="text-muted">{% trans %}You are not participating.{% endtrans %}</strong></p>
                {% if "member" in user.roles and now() < ambience['assembly']['signup_end'] %}
                    <form action="{{ cdedblink('assembly/signup') }}" method="POST" id="signupform">
                        {{ util.anti_csrf_token('assembly/signup') }}
                        {{ util.input_submit(value=gettext("Participate"), icon="sign-in-alt") }}
                    </form>
                {% endif %}
            {% endif %}
        </dd>
        {% if presiders %}
            <dt>{% trans %}Presiders{% endtrans %}</dt>
            <dd id="assembly-presiders">
                {% for anid, entry in presiders|keydictsort(EntitySorter.persona) %}
                    {{ util.persona_anchor(entry) }}{% if not loop.last %},{% endif %}
                {% endfor %}
            </dd>
        {% endif %}
    </dl>

    {% if "assembly_mgmt" in user.admin_views %}
        <div class="row">
        <div class="col-md-6" id="manage-presiders">
            {% call util.bootstrap_panel(title=gettext("Presiders"), icon='user-friends') %}
            <ul>
                {% for anid, entry in presiders|keydictsort(EntitySorter.persona) %}
                    <li class="hide-hover-container clearfix-after">
                        {{ util.persona_anchor(entry) }} ({{ anid|cdedbid }})
                        <form action="{{ cdedblink('assembly/remove_presider') }}" method="POST"
                                id="removepresiderform{{ anid }}" class="hide-hover display-inline">
                            {{ util.anti_csrf_token('assembly/remove_presider') }}
                            {{ util.input_hidden(name="presider_id", value=anid) }}
                            {{ util.input_submit(value="", title=gettext("Remove Presider"), icon='minus',
                                                 aclass='btn btn-xs btn-danger list-button-float') }}
                        </form>
                    </li>
                {% endfor %}
            </ul>
            <form action="{{ cdedblink('assembly/add_presiders') }}" method="POST" id="addpresidersform" class="p">
                {{ util.anti_csrf_token('assembly/add_presiders') }}
                {% call util.output_errors('presider_ids', wrapper=True) %}
                    <div class="input-group has-success">
                        <span class="input-group-addon">{{ util.make_icon('plus', title=gettext("Add Presiders")) }}</span>
                        {{ util.input_text(name="presider_ids", placeholder="DB-XXXX-X, DB-XXXX-X, â€¦",
                                           anid='input-add-presiders', arialabel=gettext("IDs of the new Presiders.")) }}
                        <script nonce="{{ csp_nonce }}">
                            $('#input-add-presiders').cdedbSearchPerson(
                                '{{ (cdedblink('core/select_persona')|e) + ('?kind=assembly_user&phrase=%s'|s) }}',
                                {{ ambience['assembly']['presiders']|list|json|s }}, false, true,
                                "{{ gettext("ID, name, email") }}"
                            );
                        </script>
                        <div class="input-group-btn">
                            {{ util.input_submit(value=gettext("Add"), aclass='btn btn-success') }}
                        </div>
                    </div>
                {% endcall %}
            </form>
            {% endcall %}
        </div>
        </div>
    {% endif %}

    {% if ambience['assembly']['notes'] and ("assembly_presider" in user.admin_views
                                             or ambience['assembly']['id'] in user.presider) %}
        {% call util.bootstrap_panel(title=gettext("Admin-Notes"), icon="tag", aclass="panel-default panel-condensed") %}
            <div id="notes">
                {{ ambience['assembly']['notes']|md }}
            </div>
        {% endcall %}
    {% endif %}

    {% if attachments or has_ballot_attachments or ("assembly_presider" in user.admin_views
                                                    or ambience['assembly']['id'] in user.presider) %}
        {% call util.bootstrap_panel(title=gettext("Files"), icon='file') %}
        <div class="row">
            {% if attachments or ("assembly_presider" in user.admin_views
                                  or ambience['assembly']['id'] in user.presider) %}
                <div class="col-sm-6">
                    <h4>{% trans %}General Files{% endtrans %}</h4>
                    <ul class="slim" id="attachments">
                        {% for attachment_id, attachment in attachments|keydictsort(EntitySorter.get_attachment_sorter(attachment_histories)) %}
                            <li class="hide-hover-container clearfix-after">
                                {{ assembly_util.print_attachment(
                                        attachment, attachment_histories[attachment_id],
                                        edit=("assembly_presider" in user.admin_views
                                              and ambience['assembly']['is_active'])) }}
                            </li>
                        {% endfor %}
                    </ul>
                    {% if ambience['assembly']['is_active'] and ("assembly_presider" in user.admin_views
                                                                 or ambience['assembly']['id'] in user.presider) %}
                        <div class="p">
                            {{ util.href(cdedblink("assembly/add_attachment_form"), gettext("Add File"),
                                         aclass="btn btn-success btn-sm", icon="plus") }}
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            {% if has_ballot_attachments %}
                <div class="col-sm-6">
                <h4>{% trans %}Ballot Files{% endtrans %}</h4>
                    {% for ballot_id, ballot in ballots|keydictsort(EntitySorter.ballot) %}
                        {% if ballot_attachments[ballot_id] %}
                            <ul class="slim">
                                {% for battachment_id, battachment in ballot_attachments[ballot_id].items() %}
                                    <li>
                                        {{ assembly_util.print_attachment(
                                                battachment, attachment_histories[battachment_id], ballot=ballot) }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        {% endcall %}
    {% endif %}

    {% if "assembly_mgmt" in user.admin_views %}
        {% if ambience['assembly']['is_active'] or "vote_begin" not in delete_blockers %}
            {% call util.bootstrap_panel(title=gettext("Actions"), icon="exclamation-triangle", aclass="panel-danger mosp") %}
                {% if ambience['assembly']['is_active'] %}
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="p">
                                <form action="{{ cdedblink('assembly/conclude_assembly') }}" method="POST" id="concludeassemblyform" style="display: inline;">
                                    {{ util.anti_csrf_token('assembly/conclude_assembly') }}
                                    {{ util.input_submit(value=gettext("Archive"), readonly="ballot" in conclude_blockers, aclass="btn btn-danger",
                                            icon="folder", title=gettext("Assembly still has open ballots.") if "ballot" in conclude_blockers else "") }}
                                    {{ util.input_checkbox(name="ack_conclude", label=gettext("Are you sure?")) }}
                                </form>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted">
                                {% trans %}
                                    Archives the assembly. The configuration cannot be changed after this.
                                    The private keys used to sign the votes will be deleted from the database.
                                    This should typically be done shortly after all ballots have been conlcuded.
                                {% endtrans %}
                            </p>
                        </div>
                    </div>
                {% endif %}
                {% if "vote_begin" not in delete_blockers %}
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="p">
                                <form action="{{ cdedblink('assembly/delete_assembly') }}" method="POST" id="deleteassemblyform" style="display: inline;">
                                    {{ util.anti_csrf_token('assembly/delete_assembly') }}
                                    {{ util.input_submit(value=gettext("Delete"), aclass="btn btn-danger", icon="trash-alt") }}
                                    {{ util.input_checkbox(name="ack_delete", label=gettext("Are you sure?")) }}
                                </form>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted">
                                {% trans %}
                                    Permanently deletes the assembly including all ballots and attendee information.
                                    This is only possible while no ballots have begun voting.
                                {% endtrans %}
                            </p>
                        </div>
                    </div>
                {% endif %}
            {% endcall %}
            <script nonce="{{ csp_nonce }}">
                $(function() {
                    $('#concludeassemblyform').cdedbProtectAction("{{ gettext("The assembly will be permanently archived.") }}");
                    $('#concludeassemblyform').find('[name="ack_conclude"]').prop('checked', true).parent().hide();
                    $('#deleteassemblyform').cdedbProtectAction("{{ gettext("The assembly will be permanently deleted.") }}");
                    $('#deleteassemblyform').find('[name="ack_delete"]').prop('checked', true).parent().hide();
                });
            </script>
        {% endif %}
    {% endif %}

{% endblock %}
