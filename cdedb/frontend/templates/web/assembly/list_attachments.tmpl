{% set sidenav_active='assembly_attachments' %}
{% extends "web/assembly/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% import "web/assembly/util.tmpl" as assembly_util with context %}
{% block scripts %}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% set jshint = 'weak' %}

{% block title %}
    {% trans title=ambience['assembly']['title'] %}
        Attachments ({{ title }})
    {% endtrans %}
{% endblock %}

{% block heading %}
    {{ util.context_heading(gettext("Attachments"), ambience['assembly']['title'], 'bullhorn', gettext("Assembly")) }}
{% endblock %}

{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("assembly/show_assembly"), ambience['assembly']['title'], icon="bullhorn") }}
    {{ util.breadcrumb_link(cdedblink("assembly/list_attachments"), gettext("Attachments"), active=True) }}
{% endblock %}

{% macro print_attachment_version(version, add=False, delete=False, delete_attachment=False) %}
    {% set edit_right = ambience['assembly']['is_active'] and ("assembly_presider" in user.admin_views
                                                           or ambience['assembly']['id'] in user.presider) %}
    {% if not version["dtime"] %}
        {{ util.href(cdedblink("assembly/get_attachment_version",
                               {'attachment_id': version["attachment_id"], 'version_nr': version["version_nr"]}),
                     version["title"]|string + " " + gettext("(Version %(version)s)")|format(version=version["version_nr"]),
                     icon="file") }}
        {% if edit_right and (add or delete) %}
            <div class="list-button-float" id="versionmanagement">
                {% if add %}
                    {{ util.href(cdedblink("assembly/add_attachment_version_form", {'attachment_id': version['attachment_id']}),
                                label=util.make_icon("file-medical"), aclass="btn btn-success btn-xs hide-hover",
                                title=gettext("Add Version")) }}
                {% endif %}
                {% if delete_attachment %}
                    <form action="{{ cdedblink("assembly/delete_attachment", {'attachment_id': version["attachment_id"]}) }}"
                          method="POST" id="deleteattachmentform{{ version["attachment_id"] }}"
                          class="hide-hover display-inline">
                        {{ util.anti_csrf_token("assembly/delete_attachment") }}
                        {{ util.input_checkbox("attachment_ack_delete", gettext("Are you sure?")) }}
                        {{ util.input_submit(label="", aclass="btn btn-xs btn-danger hide-hover", icon="fire",
                                title=gettext("Delete Attachment")) }}
                    </form>
                    <script nonce="{{ csp_nonce }}">
                        $('#deleteattachmentform{{ version["attachment_id"] }}').cdedbProtectAction(
                            "{{ gettext("The attachment will be permanently deleted.") }}");
                        $('#deleteattachmentform{{ version["attachment_id"] }}').find(
                            '[name="attachment_ack_delete"]').prop('checked', true).parent().hide();
                    </script>
                {% elif delete %}
                    <form action="{{ cdedblink('assembly/delete_attachment_version',
                                               {'attachment_id': version["attachment_id"],
                                                'version_nr': version['version_nr']}) }}"
                            method="POST"
                            id="removeattachmentversionform{{ version["attachment_id"] }}_{{ version["version_nr"] }}"
                            class="hide-hover display-inline">
                        {{ util.anti_csrf_token('assembly/delete_attachment_version') }}
                        {{ util.input_checkbox("attachment_ack_delete", gettext("Are you sure?")) }}
                        {{ util.input_submit(label="", aclass="btn btn-xs btn-danger hide-hover", icon="trash-alt",
                                title=(gettext("Delete Version %(version)s")|format(version=version['version_nr']))) }}
                    </form>
                    <script nonce="{{ csp_nonce }}">
                        $('#removeattachmentversionform{{ version['attachment_id'] }}_{{ version["version_nr"] }}').cdedbProtectAction(
                            "{{ gettext("The version of the attachment will be permanently deleted.") }}");
                        $('#removeattachmentversionform{{ version['attachment_id'] }}_{{ version["version_nr"] }}').find(
                            '[name="attachment_ack_delete"]').prop('checked', true).parent().hide();
                    </script>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div>{% trans version_nr=version["version_nr"] %}Version {{ version_nr }} was deleted.{% endtrans %}</div>
    {% endif %}
    <div class="text-muted small">
        {% if version["authors"] %}
            {% trans %}by{% endtrans %} {{ version["authors"] }} <br />
        {% endif %}
        {% trans ctime=version["ctime"]|datetime(lang=lang) %}uploaded {{ ctime }}{% endtrans %}
        {%- if version["dtime"] -%}
            , {% trans dtime=version["dtime"]|datetime(lang=lang) %}deleted {{ dtime }}{% endtrans %}
        {% endif %}
    </div>
{% endmacro %}

{% block content %}
    {% set edit_right = ambience['assembly']['is_active'] and ("assembly_presider" in user.admin_views
                                                               or ambience['assembly']['id'] in user.presider) %}
    {% if attachments %}
        <ul class="slim" id="attachments">
            {# This is already sorted #}
            {% for attachment_id, attachment in attachments.items() %}
                {% set attachment_versions = attachments_versions[attachment_id] %}
                {% set latest_version = attachment_versions[attachment["latest_version_nr"]] %}
                <li id="attachment{{ attachment_id }}_version{{ latest_version["version_nr"] }}">
                    <div class="p">
                        {{ print_attachment_version(
                                latest_version,
                                add=are_attachment_versions_creatable[attachment_id],
                                delete=are_attachment_versions_deletable[attachment_id],
                                delete_attachment=are_attachments_deletable[attachment_id]) }}
                        {% if attachment_versions|length > 1 %}
                            <ul>
                                {% for version_nr, version in attachment_versions|keydictsort(EntitySorter.attachment_version)|reverse %}
                                    {% if version_nr != latest_version['version_nr'] %}
                                        <li id="attachment{{ attachment_id }}_version{{ version_nr }}">
                                            {{ print_attachment_version(
                                                    version,
                                                    add=False,
                                                    delete=are_attachment_versions_deletable[attachment_id],
                                                    delete_attachment=False) }}
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% endif %}
    {% if not attachments and not edit_right %}
        <p class="text-muted">
            {% trans %}No attachments have been uploaded yet.{% endtrans %}
        </p>
    {% endif %}

    {% if edit_right %}
        {{ util.href(cdedblink("assembly/add_attachment_form"),
                    label=gettext("Add Attachment"), aclass="btn btn-success", icon=util.make_icon("plus")) }}
    {% endif %}
{% endblock %}
