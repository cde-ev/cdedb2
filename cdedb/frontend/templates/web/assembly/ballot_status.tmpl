{% macro show_result(result) -%}
    <h3>{% trans -%}Result{%- endtrans %}</h3>
    {% if result['winners'] %}
        <ol>
            {% for candidate_ids in result['winners'] %}
                <li value="{{ loop.index }}">
                    {% for candidate_id in candidate_ids %}
                        {% if not ambience['ballot']['votes'] %}
                            <span class="label label-primary">
                                {{- ambience['ballot']['candidates'][candidate_id]['moniker'] -}}
                            </span>
                        {% endif %}
                        {{ ambience['ballot']['candidates'][candidate_id]['description'] }}
                        {% if result['counts'] %}
                            {% set candidate_moniker = ambience['ballot']['candidates'][candidate_id]['moniker'] %}
                            {% trans count=result['counts'][candidate_moniker] -%}
                                ({{ count }} votes)
                            {%- endtrans %}
                        {% endif %}
                        {% if not loop.last %}
                            <br /><span class="sr-only">{% trans -%}and{%- endtrans %}</span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endfor %}
        </ol>
    {% endif %}

    {% if ambience['ballot']['use_bar'] and result['losers'] %}
        <p class="text-info">
            {% if ambience['ballot']['votes'] %}
                {% trans against_all=gettext("Against all Candidates") -%}
                    The following candidates have less votes than the {{ against_all }} choice.
                {%- endtrans %}
            {% else %}
                {% trans abm="<code>%(abm)s</code>"|s|format(abm=ASSEMBLY_BAR_MONIKER) -%}
                    The following candidates lost against the bar ({{ abm }}).
                {%- endtrans %}
            {% endif %}
        <ol>
            {% for candidate_ids in result['losers'] %}
                <li value="{{ (loop.index + result['winners']|length) }}">
                    {% for candidate_id in candidate_ids %}
                        {% if not ambience['ballot']['votes'] %}
                            <span class="label label-primary">
                                {{- ambience['ballot']['candidates'][candidate_id]['moniker'] -}}
                            </span>
                        {% endif %}
                        {{ ambience['ballot']['candidates'][candidate_id]['description'] }}
                        {% if result['counts'] %}
                            {% set candidate_moniker = ambience['ballot']['candidates'][candidate_id]['moniker'] %}
                            {% trans count=result['counts'][candidate_moniker] -%}
                                ({{ count }} votes)
                            {%- endtrans %}
                        {% endif %}
                        {% if not loop.last %}
                            <br /><span class="sr-only">{% trans -%}and{%- endtrans %}</span>
                        {% endif %}
                    {% endfor %}
                </li>
            {% endfor %}
        </ol>
    {% endif %}
{%- endmacro %}

{% macro show_summary(result) -%}
    <h4>{% trans -%}Summary{%- endtrans %}</h4>
    {% if not ambience['ballot']['votes'] %}
        <pre style="max-width: 500px;">{{ result['result'] }}</pre>

        {# info box for preferential votes #}
        {% call util.bootstrap_panel(title=gettext("Help"), icon='info-sign', aclass='panel-default mosp') %}
            <p>
                {% trans link=gettext("<a href='https://en.wikipedia.org/w/index.php?title=Schulze_method&oldid=904460701'>Schulze method</a>")|s -%}
                    This vote was a preferential vote. Voters arranged the candidates according to their preference.
                    The preferences of all participants were evaluated using the {{ link }},
                    to determine the winner.
                {%- endtrans %}
            </p>
            <p>
                {% trans  gt="<code>></code>"|s, eq="<code>=</code>"|s -%}
                    The summary shows the combined preference list of all participant.
                    The greater-than character {{ gt }} means that the candidate, represented by their
                    shortname, on the left has higher overall preference than the one on the right.
                    The equals character {{ eq }} means that two or more candidates have the same overall
                    preference across all participants.
                {%- endtrans %}
            </p>
            {% if ambience['ballot']['use_bar'] %}
                <p>
                    {% trans abm="<code>%(abm)s</code>"|s|format(abm=ASSEMBLY_BAR_MONIKER) -%}
                        Additionally the moniker {{ abm }} shows where in the rejection bar was ranked in the
                        overall preference list.
                        Should no candidate have won against the bar, the board may take additional measures.
                    {%- endtrans %}
                </p>
            {% endif %}
        {% endcall %}
    {% endif %}
    
    <p>{{ util.href(cdedblink("assembly/get_result"), gettext("Download Results"), icon="download") }}</p>
{%- endmacro %}

{% macro show_own_vote() -%}
    <h3>{% trans -%}Your Vote{%- endtrans %}</h3>
    <p>
        {% set is_active = ambience["assembly"]["is_active"] %}
        {% if not attends %}
            {% trans -%}You are not participating in this assembly.{%- endtrans %}
        {% elif not is_active and not own_vote %}
            {% if not has_voted %}
                {% trans -%}You did not vote.{%- endtrans %}
            {% else %}
                {% if not secret %}
                    <p>
                        {{ util.make_icon('info-sign') }}
                        {% trans -%}The assembly concluded and the votes got encrypted.{%- endtrans %}
                        {% trans -%}To show your vote, enter the secret you were sent when registering for the assembly.{%- endtrans %}
                    </p>
                {% else %}
                    <p>
                        {{ util.make_icon('info-sign') }}
                        {% trans -%}You entered an invalid secret.{%- endtrans %}
                        {% trans -%}To show your vote, enter the secret you were sent when registering for the assembly.{%- endtrans %}
                    </p>
                {% endif %}
                <form action="{{ cdedblink("assembly/show_old_vote") }}" id="showoldvoteform" method="POST">
                    {{ util.anti_csrf_token("assembly/show_old_vote") }}
                    <div class="input-group">
                        <span class="input-group-addon"><label for="input-secret">
                            {% trans %}Secret{% endtrans %}
                        </label></span>
                        {{ util.input_text(name="secret", anid="input-secret") }}
                        <div class="input-group-btn">
                            {{ util.input_submit(value=gettext("Show Vote"), aclass="btn btn-success", icon="lock") }}
                        </div>
                    </div>
                    {{ util.output_errors('secret', wrapper=True) }}
                </form>
            {% endif %}
        {% elif not own_vote %}
            {% if ambience['ballot']['is_voting'] %}
                {% trans -%}You have not voted yet.{%- endtrans %}
            {% else %}
                {% trans -%}You did not vote.{%- endtrans %}
            {% endif %}
        {% elif ambience['ballot']['votes'] %}
            {# Show own vote under result: Classical vote #}
            {% if split_vote|length == 1 %}
                {% trans -%}You abstained.{%- endtrans %}
            {% elif split_vote|length == 2 and split_vote[0] == [ASSEMBLY_BAR_MONIKER] %}
                {% trans -%}You voted against all candidates.{%- endtrans %}
            {% else %}
                {% trans -%}You voted for the following candidates:{%- endtrans %}<br />
                {% for vote in split_vote[0] %}
                    {{ candidates[vote]['description'] }}{% if not loop.last %},{% endif %}
                {% endfor %}
            {% endif %}
        {% else %}
            {# Show own vote under result: Preferential vote #}
            {%- trans vote="<code>%(vote)s</code>"|s|format(vote=own_vote) -%}
                You voted {{ vote }}.
            {%- endtrans -%}
        {% endif %}
    </p>
{%- endmacro %}

{% macro show_status() -%}
<dl class="dl-horizontal">
    <dt>{% trans -%}Voting Period{%- endtrans %}</dt>
        <dd>
            {% trans begin=ambience['ballot']['vote_begin']|datetime(lang=lang),
                     end=ambience['ballot']['vote_end']|datetime(lang=lang) -%}
            From {{ begin }} until {{ end }}.
            {%- endtrans %}
            {% if ambience['ballot']['extended'] is none %}
                {% if ambience['ballot']['quorum'] %}
                    <br />
                    {% trans extension=ambience['ballot']['vote_extension_end']|datetime(lang=lang),
                             quorum=ambience['ballot']['quorum'] -%}
                    Extension until {{ extension }} if {{ quorum }} votes are not reached.
                    {%- endtrans %}
                {% endif %}
            {% else %}
                {% if ambience['ballot']['extended'] %}
                    <br />
                    {% trans extension=ambience['ballot']['vote_extension_end']|datetime(lang=lang),
                             quorum=ambience['ballot']['quorum'] -%}
                    Extended until {{ extension }} because {{ quorum }} votes were not reached.
                    {%- endtrans %}
                {% elif ambience['ballot']['quorum'] %}
                    <br />
                    {% trans quorum=anbience['ballot']['quorum'] -%}
                    No extension neccessary, because {{ quorum }} votes were reached.
                    {%- endtrans %}
                {% endif %}
            {% endif %}
        </dd>
        <dt>{% trans -%}Status{%- endtrans %}</dt>
        <dd>
            {% if now() < ambience['ballot']['vote_begin'] %}
                <strong>{% trans -%}This ballot has not yet begun.{%- endtrans %}</strong><br />
                {% trans -%}Admins can still make changes to description, files and candidates.{%- endtrans %}
                {% if is_admin %}
                    {% trans -%}
                        All CdE-Members and external assembly participants can already
                        see this ballot and all associated information.
                    {%- endtrans %}
                {% endif %}
            {% elif ambience['ballot']['is_tallied'] %}
                <strong>{% trans -%}This ballot has been concluded.{%- endtrans %}</strong><br />
                {% trans -%}You can see the results below.{%- endtrans %}
            {% elif not attends %}
                {% trans -%}
                    You are not participating in this assembly, therefore you cannot vote in this ballot.
                {%- endtrans %}
            {% elif ambience['ballot']['is_voting'] %}
                <strong>{% trans -%}This ballot is currently open for voting.{%- endtrans %}</strong><br />
                {% if own_vote %}
                    {% if split_vote|length == 1 %}
                        <span class='text-warning'>{% trans -%}You have abstained.{%- endtrans %}</span>
                        {% trans -%}You can make your choice below, during the voting period.{%- endtrans %}
                    {% else %}
                        <span class='text-success'>{% trans -%}You already voted.{%- endtrans %}</span>
                        {% trans -%}
                            You can check your vote below and change it
                            before the end of the voting period.
                        {%- endtrans %}
                    {% endif %}
                {% endif %}
            {% endif %}
        </dd>
    </dl>

    {% if is_admin and ambience['ballot']['notes'] %}
        {% call util.bootstrap_panel(title=gettext("Admin-Notes"), icon="tag", aclass="panel-default panel-condensed") %}
            {{ ambience['ballot']['notes']|md }}
        {% endcall %}
    {% endif %}
{%- endmacro %}

{% macro show_tailled_ballot(result) -%}
    {{ show_result(result) }}
    {{ show_summary(result) }}
    {{ show_own_vote() }}
{%- endmacro %}
