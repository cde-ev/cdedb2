{% macro print_attachment(history, full_history=False, edit=False, ballot=None) %}
    {% set x = [] %}
    {% for i, v in history.items() if v['dtime'] is none %}
        {% do x.append(i) %}
    {% endfor %}
    {% with current_version = history[x|max] if x else history[history.keys()|max] %}
        <div class="p" id="attachment_container_{{ current_version["attachment_id"] }}">
            {{ print_attachment_link(current_version, edit, ballot, add=True) }}
            {% if full_history %}
                {% if history|length > 1 %}
                    <ul>
                        {% for i, version in history|keydictsort(EntitySorter.attachment_version)|reverse %}
                            {% if i != current_version['version'] %}
                                <li>
                                    {{ print_attachment_link(version, edit, ballot) }}
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% endif %}
                {% if edit %}
                    <div class="">
                        {{ util.href(cdedblink("assembly/add_attachment_form",
                                     {'attachment_id': current_version["attachment_id"],
                                      'ballot_id': ballot['id'] if ballot else None}),
                                     gettext("Add Version"), aclass="btn btn-success btn-sm", icon="plus") }}
                        {{ util.href(cdedblink("assembly/change_attachment_form",
                                     {'attachment_id': current_version["attachment_id"],
                                      'ballot_id': ballot['id'] if ballot else None}),
                                     gettext("Change Attachment"), aclass="btn btn-warning btn-sm", icon="pen") }}
                        <form action="{{ cdedblink("assembly/delete_attachment",
                                                   {'attachment_id': current_version["attachment_id"],
                                                    'ballot_id': ballot['id'] if ballot else None}) }}"
                              method="POST" id="deleteattachmentform{{ current_version["attachment_id"] }}" style="display: inline;">
                            {{ util.anti_csrf_token("assembly/delete_attachment") }}
                            {{ util.input_checkbox("attachment_ack_delete", gettext("Are you sure?")) }}
                            {{ util.input_submit(value=gettext("Delete Attachment"), aclass="btn btn-sm btn-danger", icon="trash-alt",
                                    title=gettext("Delete Attachment")) }}
                        </form>
                        <script nonce="{{ csp_nonce }}">
                            $('#deleteattachmentform{{ current_version['attachment_id'] }}').cdedbProtectAction("{{ gettext("The attachment will be permanently deleted.") }}");
                            $('#deleteattachmentform{{ current_version['attachment_id'] }}').find('[name="attachment_ack_delete"]').prop('checked', true).parent().hide();
                        </script>
                    </div>
                {% endif %}
            {% else %}
                {{ util.href(cdedblink("assembly/show_attachment", {'attachment_id': current_version['attachment_id'],
                                                                    'ballot_id': ballot['id'] if ballot else None}),
                             gettext("Attachment Details")) }}
            {% endif %}
        </div>
    {% endwith %}
{% endmacro %}

{% macro print_attachment_link(version, edit, ballot, add=False) %}
    {% if not version["dtime"] %}
        {{ util.href(cdedblink("assembly/get_attachment",
                               {'attachment_id': version["attachment_id"],
                                'version': version["version"], 'ballot_id': ballot['id'] if ballot else None}),
                     version["title"]|string + " " + gettext("(Version %(version)s)")|format(version=version["version"]),
                     icon="file") }}
        {% if edit %}
            <div class="list-button-float">
            {% if add %}
                {{ util.href(cdedblink('assembly/add_attachment',
                             {'attachment_id': version["attachment_id"],
                              'ballot_id': ballot['id'] if ballot else None}),
                             title=gettext("Add Version"), label=util.make_icon("plus"),
                             aclass="btn btn-xs btn-success hide-hover") }}
            {% endif %}
            {{ util.href(cdedblink('assembly/edit_attachment_version',
                         {'attachment_id': version["attachment_id"],
                          'version': version["version"],
                          'ballot_id': ballot['id'] if ballot else None}),
                         title=gettext("Edit File"), label=util.make_icon("pen"),
                         aclass="btn btn-xs btn-warning hide-hover") }}
            <form action="{{ cdedblink('assembly/delete_attachment',
                                       {'attachment_id': version["attachment_id"],
                                        'ballot_id': ballot['id'] if ballot else None}) }}"
                    method="POST"
                    id="removeattachmentversionform{{ version["attachment_id"] }}_{{ version["version"] }}"
                    class="hide-hover display-inline">
                {{ util.anti_csrf_token('assembly/delete_attachment') }}
                {{ util.input_hidden(name="version", value=version["version"]) }}
                {{ util.input_checkbox("attachment_ack_delete", gettext("Are you sure?")) }}
                {{ util.input_submit(value="", aclass="btn btn-xs btn-danger", icon="trash-alt",
                        title=gettext("Delete File")) }}
            </form>
            </div>
            <script nonce="{{ csp_nonce }}">
                $('#removeattachmentversionform{{ version['attachment_id'] }}_{{ version["version"] }}').cdedbProtectAction(
                    "{{ gettext("The version of the attachment will be permanently deleted.") }}");
                $('#removeattachmentversionform{{ version['attachment_id'] }}_{{ version["version"] }}').find(
                    '[name="attachment_ack_delete"]').prop('checked', true).parent().hide();
            </script>
        {% endif %}
        {% if ballot %}
            <div class="text-muted small">
                ({{- util.make_icon('thumbs-up', arialabel=gettext("ballot_file_arialabel")) }}
                {{ ballot['title'] -}})
             </div>
        {% endif %}
    {% else %}
        <div class="text-info">{% trans version=version["version"] %}Version {{ version }} was deleted.{% endtrans %}</div>
    {% endif %}
    <div class="text-muted small">
        {% if version["authors"] %}
            {% trans %}by{% endtrans %} {{ version["authors"] }},
        {% endif %}
        {% trans ctime=version["ctime"]|datetime(lang=lang) %}uploaded {{ ctime }}{% endtrans %}
        {% if version["dtime"] %}
            , {% trans dtime=version["dtime"]|datetime(lang=lang) %}deleted {{ dtime }}{% endtrans %}
        {% endif %}
    </div>
{% endmacro %}

{% macro small_attachment_title(history) %}
    {% with current = history[history.keys()|max] %}
        <small>
            {{- util.make_icon('file', arialabel='Attachment') }} {{ current['title'] -}}
        </small>
    {% endwith %}
{% endmacro %}

{% macro attachment_box(attachments, ballot=None, edit=False, full_history=False, new_attachment_button=False) %}
    {% call util.bootstrap_panel(
            title=("Files â€“ {link}".format(link=util.href(cdedblink("assembly/show_ballot", {'ballot_id': ballot['id']}),
                                                          ballot['title'], icon="thumbs-up"))|s
                  if ballot else gettext("General Files")),
            icon='file') %}
    <div class="row">
        <div class="col-sm-12">
            <ul class="slim" id="attachments-{{ "ballot-{}".format(ballot['id']) if ballot else "general"}}">
                {% for attachment_id, history in attachments.items() %}
                    <li class="hide-hover-container clearfix-after" id="attachment{{ attachment_id }}">
                        {{ print_attachment(history, edit=("assembly_contents" in user.admin_views),
                                            full_history=True, ballot=ballot) }}
                    </li>
                    <br />
                {% endfor %}
            </ul>
            {% if (ballot is none or now() < ballot['vote_begin']) and new_attachment_button and
                    "assembly_contents" in user.admin_views %}
                <div class="p">
                    {{ util.href(cdedblink("assembly/add_attachment_form",
                                           {'ballot_id': ballot['id'] if ballot else None}),
                                 gettext("Attach File"), aclass="btn btn-success btn-sm", icon="plus") }}
                </div>
            {% endif %}
        </div>
    </div>
    {% endcall %}
{% endmacro %}