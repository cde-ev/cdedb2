{% set sidenav_active='core_genesis_list' %}
{% extends "web/core/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% set jshint='weak' %}
{% block title %}
    {% trans -%}
    	Account Requests
    {%- endtrans %}{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("core/genesis_list_cases"), gettext("Account Requests"), active="True") }}
{% endblock %}
{% block content %}
    <script type="text/javascript">
        $(function() {
            $('.rejection-form').cdedbProtectAction("{{ gettext("The Account Request will be permanently deleted.") }}");
        });
    </script>
    {% if 'event_admin' in user.roles or 'core_admin' in user.roles %}
        <h3>
            {% trans count=event_cases|length -%}
                Event-Account Requests [{{ count }}]
            {%- endtrans %}
        </h3>
        {% if event_cases|length > 0 %}
            {% for case_id, entry in event_cases|dictsort %}
                <div class="row">
                    <div class="col-sm-3">
                        <p>
                            {{ entry['given_names'] }} {{ entry['family_name'] }}
                            &lt;{{ util.href('mailto:%s'|format(entry['username']), entry['username']) }}&gt;
                        </p>
                        {# FIXME maybe display more information?#}
                    </div>
                    <div class="col-sm-4">
                        {% with realms = {'event': (gettext("Event"), 'blackboard'),
                                          'ml': (gettext("Mailinglist"), 'envelope')} %}
                            {{ util.make_icon(realms[entry['realm']][1]) }} {{ realms[entry['realm']][0] }}
                        {% endwith %}
                        {% if entry['notes'] %}<p class="textbox">{{ entry['notes'] }}</p>{% endif %}
                    </div>
                    <div class="col-sm-5    button-par">
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id}) }}" method="POST"
                         id="genesiseventapprovalform{{ loop.index }}" style="display: inline;">
                            {{ util.anti_csrf_token('core/genesis_decide') }}
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].approved.value) }}
                            {{ util.input_submit(value=gettext("Approve"), aclass="btn btn-sm btn-success") }}
                        </form>
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id}) }}" method="POST"
                         id="genesiseventrejectionform{{ loop.index }}" class="rejection-form" style="display: inline;">
                            {{ util.anti_csrf_token('core/genesis_decide') }}
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].rejected.value) }}
                            {{ util.input_submit(icon="remove", value=gettext("Reject"),
                                aclass="btn btn-sm btn-danger") }}
                        </form>
                        {{ util.href(cdedblink('core/genesis_modify_form', {'case_id': case_id}), gettext("Edit"),
                            aclass="btn btn-warning btn-sm", icon="pencil") }}
                    </div>
                </div>
                {% if not loop.last %}
                    <hr />
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="text-muted">{% trans -%}There are currently no Event-Account Requests pending.{%- endtrans %}</p>
        {% endif %}
    {% endif %}
    {% if 'ml_admin' in user.roles or 'core_admin' in user.roles %}
        <h3>
            {% trans count=ml_cases|length -%}
            	Malinglist-Account Requests [{{ count }}]
            {%- endtrans %}
        </h3>
        {% if ml_cases|length > 0 %}
            {% for case_id, entry in ml_cases|dictsort %}
                <div class="row">
                    <div class="col-sm-3">
                        <p>
                            {{ entry['given_names'] }} {{ entry['family_name'] }}
                            &lt;{{ util.href('mailto:%s'|format(entry['username']), entry['username']) }}&gt;
                        </p>
                    </div>
                    <div class="col-sm-4">
                        {% with realms = {'event': (gettext("Event"), 'blackboard'),
                                          'ml': (gettext("Mailinglist"), 'envelope')} %}
                            {{ util.make_icon(realms[entry['realm']][1]) }} {{ realms[entry['realm']][0] }}
                        {% endwith %}
                        {% if entry['notes'] %}<p class="textbox">{{ entry['notes'] }}</p>{% endif %}
                    </div>
                    <div class="col-sm-5 button-par">
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id}) }}" method="POST"
                         id="genesismlapprovalform{{ loop.index }}" style="display: inline;">
                            {{ util.anti_csrf_token('core/genesis_decide') }}
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].approved.value) }}
                            {{ util.input_submit(value=gettext("Approve"), aclass="btn btn-sm btn-success") }}
                        </form>
                        <form action="{{ cdedblink('core/genesis_decide', {'case_id': case_id}) }}" method="POST"
                         id="genesismlrejectionform{{ loop.index }}" class="rejection-form" style="display: inline;">
                            {{ util.anti_csrf_token('core/genesis_decide') }}
                            {{ util.input_hidden(name="case_id", value=case_id) }}
                            {{ util.input_hidden(name="case_status", value=enums['GenesisStati'].rejected.value) }}
                            {{ util.input_submit(icon="remove", value=gettext("Reject"),
                                aclass="btn btn-sm btn-danger") }}
                        </form>
                        {{ util.href(cdedblink('core/genesis_modify_form', {'case_id': case_id}), gettext("Edit"),
                            aclass="btn btn-warning btn-sm", icon="pencil") }}
                    </div>
                </div>
                {% if not loop.last %}
                    <hr />
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="text-muted">
                {% trans -%}There are currently no Mailinglist-Account Requests pending.{%- endtrans %}
            </p>
        {% endif %}
    {% endif %}
{% endblock %}
