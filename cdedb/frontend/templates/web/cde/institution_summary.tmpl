{% set sidenav_active='cde_past_events_org' %}
{% extends "web/cde/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% set jshint='strong' %}
{% block scripts %}{{ util.cdedb_script('helper') }}{{ util.cdedb_script('dynamicrow') }}{% endblock %}
{% block title %}Organisationen der verg. Veranstaltungen verwalten{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("cde/institution_summary"), "Organisationen verwalten", active="True") }}
{% endblock %}
{# Macro for a general institution row, that can have each role in the DynamicRow workflow.
   non-deletable rows have a disabled 'delete'-checkbox,
   aclass is used to pass classes to the row, such as drow-row, drow-prototype, drow-new
   newrow rows will have 'create' instead of 'delete' checkbox and have 'data-basename' attributes #}
{% macro print_row(institution_id, deletable, aclass="", newrow=False) %}
    <tr class="{{ aclass }}" role="group" aria-label="Institution {{ institution_id }}">
        <td>
            {{ util.input_text('title_{}'.format(institution_id), aclass='drow-input form-control',
                    attributes=('data-basename="title_"' if newrow else ''), arialabel="Name") }}
            {{ util.output_errors('title_{}'.format(institution_id)) }}
        </td>
        <td>
            {{ util.input_text('moniker_{}'.format(institution_id), aclass='drow-input form-control',
                    attributes=('data-basename="moniker_"' if newrow else ''), arialabel="Kürzel") }}
            {{ util.output_errors('moniker_{}'.format(institution_id)) }}
        </td>
        <td>
            <span class="drow-buttonspace">
                {% if newrow %}
                    {{ util.input_checkbox("create_{}".format(institution_id), label="Hinzufügen",
                                           attributes='data-basename="create_"', aclass='drow-indicator')}}
                {% else %}
                    {{ util.input_checkbox("delete_{}".format(institution_id), label="Löschen",
                                           readonly=not deletable, aclass='drow-indicator') }}
                {% endif %}
            </span>
        </td>
    </tr>
{% endmacro %}


{% block content %}
    <script type="text/javascript">
        $(function() {
            $('#drow-table').cdedbDynamicRow({
                addButton: $('#drow-addbutton'),
                delButtonTitle: "Zeile löschen"});
            $('#institutionsummaryform').cdedbProtectChanges();
        });
    </script>
    <form action="{{ cdedblink('cde/institution_summary')|e }}" method="POST" id="institutionsummaryform">
        <table class="table table-condensed" id="drow-table">
            <thead>
                <tr><th>Name</th><th>Kürzel</th><th></th></tr>
            </thead>
            <tbody>
                {# Old items, already stored in the database #}
                {% for institution_id, institution in institutions|dictsort %}
                    {{ print_row(institution_id, institution_id not in is_referenced, 'drow-row') }}
                {% endfor %}
                {# Items that were added by the user but failed validation. They are still new and have no official id.
                    #}
                {% for i in range(1, values.get('create_last_index', 0) + 1) %}
                    {{ print_row(-i, False, 'drow-new', newrow=True) }}
                {% endfor %}
                {# Prototype row. For non-JS users: an empty row with 'create'-checkbox, for JS: prototype for new rows.
                    #}
                {{ print_row(-values.get('create_last_index', 0) - 1, False, 'drow-prototype', newrow=True) }}
            </tbody>
        </table>
        <p>
            <button type="button" class="btn btn-success softhide pull-right" id="drow-addbutton">
                {{ util.make_icon('plus') }} Organisation hinzufügen
            </button>
        </p>
        {{ util.input_submit(value="Speichern", readonly=is_locked) }}
    </form>
{% endblock %}
