{% set sidenav_active='cde_transfers' %}
{% extends "web/cde/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('csv-tools') }}{% endblock %}
{% block title %}
    {% trans -%}
        Enter Money Transfers
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("cde/user_search"), gettext("Manage Users")) }}
{{ util.breadcrumb_link(cdedblink("cde/batch_admission_form"), gettext("Enter Bank Transfers"), active=True) }}
{% endblock %}
{% block content %}
    <form action="{{ cdedblink('cde/money_transfers')|e }}" method="POST" id="transfersform">
        {{ util.input_hidden("checksum") }}
        {{ util.form_input_checkbox("sendmail", label=gettext("Send Notification"), horizontal=False) }}
        {{ util.form_input_textarea(name="transfers", label=gettext("Transfers"), horizontal=False, rows=8, anid="input-data") }}

        <p class="help-block">
            {{ util.make_icon('info-sign') }} {% trans -%}Enter one dataset per line.{%- endtrans %}
            {% trans -%}Use the following format:{%- endtrans %}
        </p>
        <pre>{{ "&quot;%s&quot;;&quot;%s&quot;;&quot;%s&quot;;&quot;%s&quot;;&quot;%s&quot;"|
                format(_("ID"), _("Family Name"), _("Given Names"), _("Amount"), _("Comment")) }}</pre>
        <p class="help-block">
            {{ util.make_icon('info-sign') }} {% trans -%}The Comment is optional.{%- endtrans %}
        </p>

        {% if data %}
            <h2>{% trans -%}Validation results{%- endtrans %}</h2>
            {% for dataset in data %}
                <strong>
                    <span class="row-key" data-row="{{ dataset['lineno']|e }}">
                        {% trans lineno=dataset['lineno'] -%}Line {{ lineno }}{%- endtrans -%}
                    </span>:
                    {% trans amount=dataset['amount']|money|e, given_names=dataset['raw']['given_names']|e,
                             family_name=dataset['raw']['family_name']|e -%}
                        {{ amount }} for {{ given_names }} {{ family_name }}
                    {%- endtrans %}
                </strong>
                <div class="batch-line-body">
                    {% if dataset['problems'] or dataset['warnings'] %}
                        <ul class="list-unstyled">
                            {% for key, problem in dataset['problems'] %}
                                <li class="text-danger">
                                    {{ util.make_icon('exclamation-sign', title=gettext("Error")) }}
                                    {% if key %}
                                        <em class="row-col-key clickable" data-row="{{ dataset['lineno']|e }}"
                                            data-col="{{ csvfields.get(key, -1) }}">
                                            {{ key|e -}}
                                        </em>:
                                    {% endif %}
                                    {{ util.format_error(problem) }}
                                </li>
                            {% endfor %}
                            {% for key, warning in dataset['warnings'] %}
                                <li class="text-warning">
                                    {{ util.make_icon('warning-sign', title=gettext("Warning")) }}
                                    {% if key %}
                                        <em class="row-col-key clickable" data-row="{{ dataset['lineno']|e }}"
                                            data-col="{{ csvfields.get(key, -1) }}">
                                            {{ key|e -}}
                                        </em>:
                                    {% endif %}
                                    {{ util.format_error(warning) }}
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            {% endfor %}
            <script type="text/javascript">
                $(function() {
                    var $textinput = $('#input-data');
                    $('.row-col-key').addClass('clickable').click(function() {
                        $textinput.jumpCsvPosition($(this).attr('data-row'),$(this).attr('data-col'));
                    });
                    $('.row-key').addClass('clickable').click(function() {
                        $textinput.jumpCsvPosition($(this).attr('data-row'),-1);
                    });
                });
            </script>
        {% endif %}

        {% if values['checksum'] %}
            <p class="help-block">
                {{ util.make_icon('info-sign') }}
                {% trans -%}If the input changed, the validation results will be displayed again.{%- endtrans %}
            </p>
            {{ util.form_input_submit(value=gettext("Confirm"), horizontal=False) }}
        {% else %}
            {{ util.form_input_submit(value=gettext("Validate"), horizontal=False) }}
        {% endif %}
    </form>
{% endblock %}
