{% set sidenav_active='cde_parse' %}
{% extends "web/cde/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_csv_tools.js') }}
    {{ util.cdedb_script('cdedb_searchpersona.js') }}
{% endblock %}
{% block title %}
    {% trans %}
        Parse Bank Statement
    {% endtrans %}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("cde/parse_statement_form"), gettext("Parse Bank Statement"), active=True) }}
{% endblock %}
{% macro print_transaction(t_id) %}
    <strong>
        <span class="row-key" data-row="{{ t_id }}">
            {% trans lineno=t_id -%}Line {{ lineno }}{%- endtrans -%}
        </span>:
    </strong>
    {% with transaction_keys =
        ("reference", "account", "statement_date", "amount",
        "account_holder", "posting", "iban", "t_id") %}
    <div class="batch-line-body">
        <div class="row">
            <div class="col-md-6">
                <ul>
                    {% for key in transaction_keys %}
                        <li>{{ key }}: {{ data["{}{}".format(key, t_id)] }}</li>
                        {{ util.input_hidden(name="{}{}".format(key, t_id)) }}
                    {% endfor %}
                </ul>
                <ul class="list-unstyled">
                    <div id="transaction{{ t_id }}_errors">
                        {% for key, problem in data["errors{}".format(t_id)] %}
                            <li class="text-danger">
                                {{ util.make_icon('exclamation-sign', title=gettext("Error")) }}
                                <em>{{ key }}</em>:
                                {{ util.format_error(problem) }}
                            </li>
                        {% endfor %}
                    </div>
                    <div id="transaction{{ t_id }}_warnings">
                        {% for key, problem in data["warnings{}".format(t_id)] %}
                            <li class="text-warning">
                                {{ util.make_icon('warning-sign', title=gettext("Warning")) }}
                                <em>{{ key }}</em>:
                                {{ util.format_error(problem) }}
                            </li>
                        {% endfor %}
                    </div>
                </ul>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-1">
                        {{ util.input_checkbox(name="transaction_type_confirm{}".format(t_id)) }}
                        {{ util.input_hidden(name="transaction_type_confidence{}".format(t_id)) }}
                    </div>
                    <div class="col-md-11">
                        {{ util.form_input_select(name="transaction_type{}".format(t_id),
                                    entries=TransactionType|enum_entries,
                                    label=gettext("Transaction Type"), horizontal=False, small=True) }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-1">
                        {{ util.input_checkbox(name="persona_id_confirm{}".format(t_id)) }}
                        {{ util.input_hidden(name="persona_id_confidence{}".format(t_id)) }}
                    </div>
                    <div class="col-md-11">
                        {{ util.form_input_text(name="cdedbid{}".format(t_id), small=True, horizontal=False,
                                    label=gettext("Member"), anid="input-cdedbid-{}".format(t_id)) }}
                            <script type="text/javascript" nonce="{{ csp_nonce }}">
                                $('#input-cdedbid-{{ t_id }}').cdedbSearchPerson(
                                    '{{ (cdedblink('core/select_persona')|e) + ('?kind=admin_persona&phrase=%s'|s) }}',
                                    [], false, false, "{{ gettext("CdEDB-ID, Name or E-Mail") }}"
                                );
                            </script>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-1">
                        {{ util.input_checkbox(name="event_id_confirm{}".format(t_id)) }}
                        {{ util.input_hidden(name="event_id_confidence{}".format(t_id)) }}
                    </div>
                    <div class="col-md-11">
                        {{ util.form_input_select(name="event_id{}".format(t_id), entries=events, small=True,
                                    nulloption="", label=gettext("Event"), horizontal=False) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endwith %}
{% endmacro %}

{% block content %}
    <form action="{{ cdedblink('cde/parse_statement') }}" method="POST" id="statementform" enctype="multipart/form-data">
        {{ util.anti_csrf_token('cde/parse_statement') }}
        {{ util.form_input_file(name="statement_file", label=gettext("Statement"), horizontal=False, accept="text/csv") }}
        {{ util.form_input_textarea(name="statement", horizontal=False,
                rows=8, anid="input-data",
                info=gettext("Directly paste the Bank Statement from Bank f√ºr Sozialwirtschaft here.")) }}

        {{ util.form_input_submit(value=gettext("Parse"), horizontal=False) }}
    </form>

    {% if data %}
        {% if "files" in data %}
            {% for key, value in data["files"]|dictsort %}
                <form action="{{ cdedblink('cde/parse_download') }}" method="POST" id="{{ key }}">
                    {{ util.anti_csrf_token('cde/parse_download') }}
                    {{- util.input_hidden("data", value=value) -}}
                    {{- util.input_hidden("filename", value="{}.csv".format(key)) -}}
                    {%- trans count=(value.split("\n")|length - (2 if key == "other_transactions" else 1)) %}
                        {{ count }} entries.
                    {% endtrans -%}
                    {{- util.form_input_submit(value=gettext("Download %s.csv ")|format(key),
                        aclass="btn btn-info btn-sm", icon="download", horizontal=False) -}}
                </form>
            {% endfor %}
        {% endif %}
    {% endif %}
    <br>
    {% if data %}
        <h2>{% trans -%}Validation results{%- endtrans %}</h2>
        <form action="{{ cdedblink("cde/parse_download") }}" method="POST" id="parsedownloadform">
            {{ util.anti_csrf_token("cde/parse_download") }}
            {{ util.input_hidden(name="count") }}
            {{ util.input_hidden(name="start") }}
            {{ util.input_hidden(name="end") }}
            {{ util.input_hidden(name="timestamp") }}
            {% if data["has_error"] %}
                <h3 class="heading-underline" id="has_error_summary">
                    {% trans count=data["has_error"]|length -%}{{ count }} Transactions with Errors{%- endtrans %}
                </h3>
                {% for t_id in data["has_error"] %}
                    {{ print_transaction(t_id) }}
                {% endfor %}
            {% endif %}
            {% if data["has_warning"] %}
                <h3 class="heading-underline" id="has_warning_summary">
                    {% trans count=data["has_warning"]|length -%}{{ count }} Transactions with Warnings{%- endtrans %}
                </h3>
                {% for t_id in data["has_warning"] %}
                    {{ print_transaction(t_id) }}
                {% endfor %}
            {% endif %}
            {% if data["has_none"] %}
                <h3 class="heading-underline" id="has_none_summary">
                    {% trans count=data["has_none"]|length -%}{{ count }} Successful Transactions{%- endtrans %}
                </h3>
                {% for t_id in data["has_none"] %}
                    {{ print_transaction(t_id) }}
                {% endfor %}
            {% endif %}
            {% if data["has_error"] %}
                {{ util.form_input_submit(name="validate", value=gettext("Validate"), horizontal=False) }}
            {% else %}
                <button type="submit" name="gnucash" value="gnucash" class="btn btn-primary">
                    {{ util.make_icon("download") }} {% trans %}GnuCash Download{% endtrans %}
                </button>
                {% for account in data["accounts"]|sort %}
                    <button type="submit" name="excel" value="{{ account }}" class="btn btn-primary">
                        {{ util.make_icon("download") }} {% trans %}Excel Download ({{ account }}){% endtrans %}
                    </button>
                {% endfor %}
                {% if data["memberships"] %}
                    <button type="submit" name="membership" value="membership" class="btn btn-primary">
                        {{ util.make_icon("download") }} {% trans %}Download Membership Fees{% endtrans %}
                    </button>
                {% endif %}
                {% for event_id in data["events"] %}
                    <button type="submit" name="event" value="{{ event_id }}" class="btn btn-primary">
                        {{ util.make_icon("download") }} {% trans shortname=event_id %}Download {{ shortname }}{% endtrans %}
                    </button>
                {% endfor %}
            {% endif %}
        </form>
    {% endif %}
{% endblock %}
