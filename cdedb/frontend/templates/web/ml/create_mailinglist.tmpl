{% set sidenav_active='ml_index' %}
{% extends "web/ml/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_helper.js') }}
    {{ util.cdedb_script('cdedb_change_mailinglist.js') }}
    {{ util.cdedb_script('cdedb_searchpersona.js') }}
{% endblock %}
{% set jshint='weak' %}
{% block title %}
    {% trans %}Create Mailinglist{% endtrans %}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("ml/create_mailinglist"), gettext("Create Mailinglist"), active=True) }}
{% endblock %}
{% block content %}
    {% if ml_type is none %}
        <form action="{{ cdedblink('ml/create_mailinglist_form') }}" method="GET" id="selectmltypeform",
              class="form-horizontal">
            {{ util.form_input_select(name="ml_type", label=gettext("Mailinglist Type"), entries=available_types|enum_entries(processing=gettext)) }}
            {{ util.form_input_submit(value=gettext("Continue"), cancellink=cdedblink("ml/index"), icon="pen") }}
        </form>
    {% else %}
    <script nonce="{{ csp_nonce }}">
        $(function() {
            $('#createlistform').cdedbProtectChanges().cdedbChangeMailinglist();
        });
    </script>
    <form action="{{ cdedblink('ml/create_mailinglist') }}" method="POST" id="createlistform" class="form-horizontal">
        {{ util.anti_csrf_token('ml/create_mailinglist') }}
        <h4 class="heading-underline">{% trans %}Meta{% endtrans %}</h4>
        {{ util.form_input_checkbox(name="is_active", label=gettext("Active"), defaultvalue='True') }}
        {{ util.form_input_text(name="title", label=gettext("Title")) }}
        {{ util.form_input_text(name="local_part", label=gettext("Address"),
            addon=(available_domains|enum_entries(processing=gettext, prefix="@"))[0][1]) }}
        {{ util.form_input_select(name="domain", entries=available_domains|enum_entries(processing=gettext, prefix="@"),
                                  label=gettext("Domain")) }}
            <script nonce="{{ csp_nonce }}">
                dm_inp = $('#createlistform').find("[name='domain']");
                function update_domain() {
                    $('#createlistform').find("[name='local_part']").siblings("span.input-group-addon")
                        .text(dm_inp.children(":selected").text());
                }
                dm_inp.on('input', update_domain);
                update_domain();
            </script>
        {{ util.form_input_textarea(name="description", label=gettext("Description"), rows="5",
                                    info=gettext("Supports %(infolink)s.")|format(
                                    infolink=util.href(docurl("Handbuch_Markdown"), gettext("Markdown"), title=gettext("Short Markdown summary")))|s) }}
        {{ util.form_input_textarea(name="notes", label=gettext("Admin-Notes"), rows="5",
                                    info=gettext("Supports %(infolink)s.")|format(
                                    infolink=util.href(docurl("Handbuch_Markdown"), gettext("Markdown"), title=gettext("Short Markdown summary")))|s) }}

        <h4 class="heading-underline">{% trans %}Moderation & Subscribers{% endtrans %}</h4>
        {{ util.form_input_select(name="mod_policy", label=gettext("Moderation"),
                entries=enums['ModerationPolicy']|enum_entries(processing=gettext)) }}
        {{ util.input_hidden("ml_type", value=ml_type.value) }}
        {{ util.form_input_select(name="ml_type", label=gettext("Mailinglist Type"),
                entries=enums['MailinglistTypes']|enum_entries(processing=gettext), readonly=True) }}
        {{ util.form_input_select(name="event_id", label=gettext("Event"), nulloption="&nbsp;"|s, entries=events|dictsort|dict_entries('id', 'title'),
                info=gettext("The participants of this event will be subscribers of this mailinglist. (Opt-Out)"), sort=True) }}
        {{ util.form_input_checkboxes(name="registration_stati", label=gettext("Event Audience"),
                entries=enums['RegistrationPartStati']|enum_entries(processing=gettext)) }}
        {{ util.form_input_select(name="assembly_id", label=gettext("Assembly"), nulloption="&nbsp;"|s,
                entries=assemblies|dictsort|dict_entries('id', 'title'),
                info=gettext("The participants of this assembly will be subscribers of this mailinglist. (Opt-Out)"), sort=True) }}

        <h4 class="heading-underline">{% trans %}Moderators{% endtrans %}</h4>

        {{ util.form_input_text(name="moderator_ids", label=gettext("Moderators"), placeholder="DB-XXXX-X,DB-XXXX-X,â€¦",
            anid="input-moderators") }}
        <script nonce="{{ csp_nonce }}">
            $('#input-moderators').cdedbSearchPerson(
                '{{ (cdedblink('core/select_persona')|e) + ('?kind=ml_admin_user&phrase=%s'|s) }}',
                [],
                false,
                true,
                "{{ gettext("CdEDB-ID, Name or E-Mail") }}"
            );
        </script>

        <h4 class="heading-underline">{% trans %}Mails{% endtrans %}</h4>
        {{ util.form_input_text(name="subject_prefix", label=gettext("Subject Prefix")) }}
        {{ util.form_input_select(name="attachment_policy", label=gettext("MIME filter / Attachments"),
                entries=enums['AttachmentPolicy']|enum_entries(processing=gettext)) }}
        {{ util.form_input_text(name="maxsize", label=gettext("max. message size (in kB)"), type="number") }}
        {{ util.form_input_submit(value=gettext("Create"), cancellink=cdedblink('ml/index')) }}
    </form>
    {% endif %}
{% endblock %}
