{% set sidenav_active='ml_manage' %}
{% extends "web/ml/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}{{ util.cdedb_script('cdedb_helper.js') }}{% endblock %}
{% block title %}
    {% trans title=ambience['mailinglist']['title'] -%}
        {{ title }} â€“ Consistency-Check
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
{{ super() }}
{{ util.breadcrumb_link(cdedblink("ml/show_mailinglist"), ambience['mailinglist']['title'], icon="envelope") }}
{{ util.breadcrumb_link(cdedblink("ml/management"), gettext("Manage")) }}
{{ util.breadcrumb_link(cdedblink("ml/check_states"), gettext("Consistency-Check"), active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans -%}Consistency-Check{%- endtrans %}
        <small>
            {{- util.make_icon('envelope', arialabel=gettext("Mailinglist")) }} {{ ambience['mailinglist']['title'] -}}
        </small>
    </h1>
{% endblock %}
{% block content %}
    <h2>{% trans -%}Problematic Subscribers{%- endtrans %}</h2>
    {% if not problems%}
        {% trans -%}All subscribers belong to the configured audience.{%- endtrans %}
    {% else %}
        {% trans -%}The following subscribers do not belong to the configured audience.{%- endtrans %}
        <ul>
            {% for problem in problems|sort %}
                <li>
                    {{ util.persona_anchor(personas[problem], ml_id=ambience['mailinglist']['id']) }}
                    <form action="{{ cdedblink('ml/remove_subscriber') }}" method="POST"
                            id="removeproblemform{{ problem }}" style="display: inline;">
                        {{ util.anti_csrf_token('ml/remove_subscriber') }}
                        {{ util.input_hidden(name="subscriber_id", value=problem) }}
                        {{ util.input_submit(value='', aclass="btn btn-xs btn-danger", icon="minus",
                                title=gettext("Remove %(given_names)s %(family_name)s as subscriber")|format(
                                    given_names=personas[problem]['given_names'],
                                    family_name=personas[problem]['family_name'])) }}
                    </form>
                    <form action="{{ cdedblink('ml/mark_override') }}" method="POST"
                            id="markoverrideform{{ problem }}" style="display: inline;">
                        {{ util.anti_csrf_token('ml/mark_override') }}
                        {{ util.input_hidden(name="subscriber_id", value=problem) }}
                        {{ util.input_submit(value='', aclass="btn btn-xs btn-success", icon="flag",
                                title=gettext("Mark %(given_names)s %(family_name)s as an exception.")|format(
                                    given_names=personas[problem]['given_names'],
                                    family_name=personas[problem]['family_name'])) }}
                    </form>
                </li>
            {% endfor %}
        </ul>
        <form action="{{ cdedblink('ml/remove_subscribers') }}" method="POST"
                id="removeallproblemsform" style="display: inline;">
            {{ util.anti_csrf_token('ml/remove_subscribers') }}
            {{ util.input_hidden(name="subscriber_ids", value=problems|join(",")) }}
            {{ util.input_submit(value=gettext("Remove All"), aclass="btn btn-danger", icon="minus",
                    title=gettext("Remove all the above as subscribers.")) }}
            {{ util.input_checkbox(name="ack_delete", label=gettext("Are you sure?")) }}
        </form>
        <script type="text/javascript" nonce="{{ csp_nonce }}">
            $('#removeallproblemsform').cdedbProtectAction(
                "{{ gettext("All problematic subscribers will be removed.") }}");
            $('#removeallproblemsform').find('[name="ack_delete"]').prop('checked', true)
                .parent().hide();
        </script>
    {% endif %}
    {% if overrides %}
        <h2>{% trans -%}Exceptions{%- endtrans %}</h2>
        {% trans -%}
            The following subscribers do not belong to the configured audience, but were marked as exceptions.
        {%- endtrans %}
        <ul>
            {% for problem in overrides|sort %}
                <li>
                    {{ util.persona_anchor(personas[problem], ml_id=ambience['mailinglist']['id']) }}
                    <form action="{{ cdedblink('ml/remove_subscriber') }}" method="POST"
                            id="removeproblemform{{ problem }}" style="display: inline;">
                        {{ util.anti_csrf_token('ml/remove_subscriber') }}
                        {{ util.input_hidden(name="subscriber_id", value=problem) }}
                        {{ util.input_submit(value='', aclass="btn btn-xs btn-danger", icon="minus",
                                title=gettext("Remove %(given_names)s %(family_name)s as subscriber")|format(
                                    given_names=personas[problem]['given_names'],
                                    family_name=personas[problem]['family_name'])) }}
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}
