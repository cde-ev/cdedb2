{% set sidenav_active='ml_manage' %}
{% extends "web/ml/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block title %}{{ ambience['mailinglist']['title']|e }} – Konsistenzcheck{% endblock %}
{% block breadcrumb %}
{{ util.breadcrumb_link(cdedblink("ml/index"), "Mailinglisten") }}
{{ util.breadcrumb_link(cdedblink("ml/show_mailinglist"), ambience['mailinglist']['title'], icon="envelope") }}
{{ util.breadcrumb_link(cdedblink("ml/management"), "Verwalten") }}
{{ util.breadcrumb_link(cdedblink("ml/check_states"), "Konsistenzcheck", active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        Konsistenzcheck
        <small>
            {{- util.make_icon('envelope', arialabel="Mailingliste") }} {{ ambience['mailinglist']['title']|e -}}
        </small>
    </h1>
{% endblock %}
{% block content %}
    <h2>Problematische Abonennten</h2>
    {% if not problems%}
        Alle Abonennten gehören zur konfigurierten Zielgruppe.
    {% else %}
        Die folgenden Abonennten gehören nicht zur konfigurierten Zielgruppe.
        <ul>
            {% for problem in problems|sort %}
                <li>
                    {{ util.persona_anchor(personas[problem]) }}
                    <form action="{{ cdedblink('ml/remove_subscriber')|e }}" method="POST"
                            id="removeproblemform{{ problem|e }}" style="display: inline;">
                        {{ util.input_hidden(name="subscriber_id", value=problem) }}
                        {{ util.input_submit(value='', aclass="btn btn-xs btn-danger", icon="minus",
                                title=personas[problem]['given_names'] + " " + personas[problem]['family_name'] +
                                " als Abonnent entfernen") }}
                    </form>
                    <form action="{{ cdedblink('ml/mark_override')|e }}" method="POST"
                            id="markoverrideform{{ problem|e }}" style="display: inline;">
                        {{ util.input_hidden(name="subscriber_id", value=problem) }}
                        {{ util.input_submit(value='', aclass="btn btn-xs btn-success", icon="flag",
                                title=personas[problem]['given_names'] + " " + personas[problem]['family_name'] +
                                " als Ausnahme markieren") }}
                    </form>
                </li>
            {% endfor %}
        </ul>
        <form action="{{ cdedblink('ml/remove_subscribers')|e }}" method="POST"
                id="removeallproblemsform" style="display: inline;">
            {{ util.input_hidden(name="subscriber_ids", value=problems|join(",")) }}
            {{ util.input_submit(value='', aclass="btn btn-xs btn-danger", icon="minus",
                    title="Alle obigen Abonnenments entfernen") }}
        </form>
    {% endif %}
    {% if overrides %}
        <h2>Ausnahmen</h2>
        Die folgenden Abonennten gehören nicht zur konfigurierten Zielgruppe, wurden aber explizit markiert.
        <ul>
            {% for problem in overrides|sort %}
                <li>
                    {{ util.persona_anchor(personas[problem]) }}
                    <form action="{{ cdedblink('ml/remove_subscriber')|e }}" method="POST"
                            id="removeproblemform{{ problem|e }}" style="display: inline;">
                        {{ util.input_hidden(name="subscriber_id", value=problem) }}
                        {{ util.input_submit(value='', aclass="btn btn-xs btn-danger", icon="minus",
                                title=personas[problem]['given_names'] + " " + personas[problem]['family_name'] +
                                " als Abonnent entfernen") }}
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}
