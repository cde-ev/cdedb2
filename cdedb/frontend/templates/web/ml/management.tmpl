{% set sidenav_active='ml_manage' %}
{% extends "web/ml/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_searchpersona.js') }}
    {{ util.cdedb_script('cdedb_helper.js') }}
{% endblock %}
{% set jshint='strong' %}
{% block title %}
    {% trans title=ambience['mailinglist']['title'] %}{{ title }} – Management
    {% endtrans %}
{% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {% if is_admin %}
        {{ util.breadcrumb_link(cdedblink("ml/list_mailinglists"), gettext("All Mailinglists")) }}
    {% endif %}
    {{ util.breadcrumb_link(cdedblink("ml/show_mailinglist"), ambience['mailinglist']['title'], icon="envelope") }}
    {{ util.breadcrumb_link(cdedblink("ml/management"), gettext("Management"), active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans %}Manage Mailinglist{% endtrans %}
        <small>{{ util.make_icon('envelope') }} {{ ambience['mailinglist']['title'] }}</small>
    </h1>
{% endblock %}
{% block content %}
    <p class="text-info">
        {{ util.make_icon('info-circle') }}
        {% trans %}
            Note that every change can take up to 15 minutes to take effect.
        {% endtrans %}
    </p>

    <div class="row">
        <div class="col-md-6">
            <h2>{% trans %}Moderators{% endtrans %} [{{ ambience['mailinglist']['moderators']|length }}]</h2>
                <p class="text-muted">
                {{ util.make_icon('info-circle') }}
                    {% trans %}
                        Only users can be moderators.
                    {% endtrans %}
                </p>
            <form action="{{ cdedblink('ml/add_moderators') }}" method="POST"
                  id="addmoderatorform" class="p">
                {{ util.anti_csrf_token('ml/add_moderators') }}
                <div class="input-group has-success">
                    <span class="input-group-addon">{{ util.make_icon('plus') }}</span>
                    {{ util.input_text(name="moderators", anid="input-add-moderator",
                                       placeholder="DB-XXXX-X,DB-XXXX-X,…",
                                       arialabel=gettext("IDs of the new moderators")) }}
                    <script nonce="{{ csp_nonce }}">
                        $('#input-add-moderator').cdedbSearchPerson(
                            '{{ (cdedblink('core/select_persona')|e) + ('?kind=mod_ml_user&phrase=%s&aux='|s) +
                                (ambience['mailinglist']['id']|string|e) }}', {{ ambience['mailinglist']['moderators']|list|json|s }},
                            false, true, "{{ gettext("CdEDB-ID, Name or E-Mail") }}"
                        );
                    </script>
                    <div class="input-group-btn">
                        {{ util.input_submit(value=gettext("Add"), aclass="btn btn-success") }}
                    </div>
                </div>
                {{ util.output_errors('moderators', wrapper=True) }}
            </form>

            <ul id="moderator_list">
                {% for moderator, persona in moderators.items() %} {# This is already sorted. #}
                    <li class="hide-hover-container clearfix-after">
                        {{ util.persona_anchor(persona, ml_id=ambience['mailinglist']['id']) }}
                        {% if is_relevant_admin(mailinglist_id=ambience['mailinglist']['id']) or moderator != user.persona_id %}
                            <form action="{{ cdedblink('ml/remove_moderator') }}"
                                  method="POST"
                                  id="removemoderatorform{{ moderator }}"
                                  class="hide-hover display-inline">
                                {{ util.anti_csrf_token('ml/remove_moderator') }}
                                {{ util.input_hidden(name="moderator_id", value=moderator) }}
                                {{ util.input_submit(value='', aclass="btn btn-xs btn-danger list-button-float", icon="minus",
                                        title=gettext("Remove %(given_names)s %(family_name)s as moderator")|format(
                                            given_names=persona['given_names'],
                                            family_name=persona['family_name'])) }}
                            </form>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="col-md-6">
            <h2>{% trans %}Subscription Requests{% endtrans %}</h2>
                <p class="text-muted">
                    {{ util.make_icon('info-circle') }}
                    {% trans %}
                        Subscription Requests of other users to this mailinglist.
                    {% endtrans %}
                </p>
            {# TODO Restyle #}
            {% if requests|length > 0 %}
                <ul>
                    {% for request, persona in requests.items() %} {# This is already sorted. #}
                        <li class="hide-hover-container clearfix-after">
                            {{ util.persona_anchor(persona, ml_id=ambience['mailinglist']['id']) }}
                            <div class="nowrap display-inline">
                                {# TODO consider merging endpoints and use a single form - would enable usage of btn-group #}
                                <form action="{{ cdedblink('ml/approve_request') }}"
                                      method="POST"
                                      id="approverequestform{{ request }}"
                                      class="hide-hover display-inline">
                                    {{ util.anti_csrf_token('ml/approve_request') }}
                                    {{ util.input_hidden(name="persona_id", value=request) }}
                                    {{ util.input_submit(icon="check", value=gettext("Accept"),
                                        aclass="btn btn-xs btn-success list-button-float") }}
                                </form>
                                <form action="{{ cdedblink('ml/deny_request') }}"
                                      method="POST"
                                      id="denyrequestform{{ request }}"
                                      class="hide-hover display-inline">
                                    {{ util.anti_csrf_token('ml/deny_request') }}
                                    {{ util.input_hidden(name="persona_id", value=request) }}
                                    {{ util.input_submit(icon="times-circle", value=gettext("Reject"),
                                        aclass="btn btn-xs btn-danger list-button-float") }}
                                </form>
                                <form action="{{ cdedblink('ml/block_request') }}"
                                      method="POST"
                                      id="blockrequestform{{ request }}"
                                      class="hide-hover display-inline">
                                    {{ util.anti_csrf_token('ml/block_request') }}
                                    {{ util.input_hidden(name="persona_id", value=request) }}
                                    {{ util.input_submit(icon="ban", value=gettext("Block"),
                                        aclass="btn btn-xs btn-danger list-button-float") }}
                                </form>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>{% trans %}
                    There are currently no Subscription Requests pending.
                {% endtrans %}</p>
            {% endif %}
        </div>
    </div>

    <h2>{% trans %}Subscribers{% endtrans %} [{{ subscribers|length }}]</h2>
        <p class="text-muted">
            {{ util.make_icon('info-circle') }}
            {% trans link = util.href(cdedblink('ml/show_subscription_details'), label=gettext("advanced management")) %}
                Forced subscribers cannot be unsubscribed; blocked subscribers cannot be subscribed here.
                Use the {{ link }} site instead. People who are already subscribed are not proposed for adding.
            {% endtrans %}
        </p>
    <form action="{{ cdedblink('ml/add_subscribers') }}" method="POST"
          id="addsubscriberform" class="p">
        {{ util.anti_csrf_token('ml/add_subscribers') }}
        <div class="input-group has-success">
            <span class="input-group-addon">{{ util.make_icon('plus') }}</span>
            {{ util.input_text(name="subscriber_ids", placeholder="DB-XXXX-X,DB-XXXX-X,…", anid="input-add-subscriber",
                               arialabel=gettext("ID of the new Subscriber")) }}
            <script nonce="{{ csp_nonce }}">
                $('#input-add-subscriber').cdedbSearchPerson(
                    '{{ (cdedblink('core/select_persona')|e) + ('?kind=mod_ml_user&phrase=%s&aux='|s) +
                        (ambience['mailinglist']['id']|string|e) + ('&variant='|s) +
                        (enums['SubscriptionActions'].add_subscriber.value|string|e) }}', {{ subscribers|list|json|s }},
                    false, true, '{{ gettext("CdEDB-ID, Name or E-Mail") }}'
                );
            </script>
            <div class="input-group-btn">
                {{ util.input_submit(value=gettext("Add Subscriber"), aclass="btn btn-success") }}
            </div>
        </div>
        {{ util.output_errors('subscriber_ids', wrapper=True) }}
    </form>

    <div class="row">
        {% set col_width = 4 if subscribers|length > 10 else (6 if subscribers|length > 5 else 12) %}
        {% for list in subscribers | slice(3 if subscribers|length > 10 else (2 if subscribers|length > 5 else 1)) %}
            <div class="col-sm-{{ col_width }}">
                <ul class="nosp slim">
                    {% for subscriber in list %}
                        <li class="hide-hover-container clearfix-after">
                            {{ util.persona_anchor(subscribers[subscriber], ml_id=ambience['mailinglist']['id']) }}
                            {% if subscriber in explicits %}({{ explicits[subscriber] }}){% endif %}
                            <form action="{{ cdedblink('ml/remove_subscriber') }}"
                                  method="POST"
                                  id="removesubscriberform{{ subscriber }}"
                                  class="hide-hover display-inline">
                                {{ util.anti_csrf_token('ml/remove_subscriber') }}
                                {{ util.input_hidden(name="subscriber_id", value=subscriber) }}
                                {{ util.input_submit(value="", icon="minus", aclass="btn btn-xs btn-danger list-button-float",
                                        title=gettext("Remove %(given_names)s %(family_name)s as subscriber")|format(
                                            given_names=subscribers[subscriber]['given_names'],
                                            family_name=subscribers[subscriber]['family_name'])) }}
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    </div>
{% endblock %}
