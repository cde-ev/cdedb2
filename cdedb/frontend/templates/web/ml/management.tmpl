{% set sidenav_active='ml_manage' %}
{% extends "web/ml/base.tmpl" %}
{% import "web/util.tmpl" as util with context %}
{% block scripts %}
    {{ util.cdedb_script('cdedb_searchpersona.js') }}
    {{ util.cdedb_script('cdedb_helper.js') }}
{% endblock %}
{% set jshint='strong' %}
{% block title %}
    {% trans title=ambience['mailinglist']['title'] -%}{{ title }} â€“ Manage
    {%- endtrans %}
{% endblock %}
{% block breadcrumb %}
    {{ super() }}
    {{ util.breadcrumb_link(cdedblink("ml/show_mailinglist"), ambience['mailinglist']['title'], icon="envelope") }}
    {{ util.breadcrumb_link(cdedblink("ml/management"), gettext("Manage"), active=True) }}
{% endblock %}
{% block heading %}
    <h1 class="title">
        {% trans -%}Manage Mailinglist{%- endtrans %}
        <small>{{ util.make_icon('envelope') }} {{ ambience['mailinglist']['title'] }}</small>
    </h1>
{% endblock %}
{% block content %}
    {% call util.bootstrap_panel() %}
        {% trans -%}
            Note that every change can take up to 15min until effective.
        {%- endtrans %}
    {% endcall %}

    <div class="row">
        <div class="col-md-6">
            <h2>{% trans -%}Moderators{%- endtrans %} [{{ ambience['mailinglist']['moderators']|length }}]</h2>
            <form action="{{ cdedblink('ml/add_moderator') }}" method="POST"
                  id="addmoderatorform" class="p">
                {{ util.anti_csrf_token('ml/add_moderator') }}
                <div class="input-group has-success">
                    <span class="input-group-addon">{{ util.make_icon('plus') }}</span>
                    {{ util.input_text(name="moderator_id", anid="input-add-moderator", placeholder="DB-XXXX-X",
                                       arialabel=gettext("ID of the new moderator")) }}
                    <script type="text/javascript" nonce="{{ csp_nonce }}">
                        $('#input-add-moderator').cdedbSearchPerson(
                            '{{ (cdedblink('core/select_persona')|e) + ('?kind=mod_ml_user&phrase=%s&aux='|s) +
                                (ambience['mailinglist']['id']|string|e) }}', {{ ambience['mailinglist']['moderators']|list|json|s }},
                            false, false, "{{ gettext("ID, name, email") }}"
                        );
                    </script>
                    <div class="input-group-btn">
                        {{ util.input_submit(value=gettext("Add"), aclass="btn btn-success") }}
                    </div>
                </div>
                {{ util.output_errors('moderator_id', wrapper=True) }}
            </form>

            <ul>
                {% for moderator, persona in moderators.items() %} {# This is already sorted. #}
                    <li>
                        {{ util.persona_anchor(persona, ml_id=ambience['mailinglist']['id']) }}
                        {% if is_admin or moderator != user.persona_id %}
                            <form action="{{ cdedblink('ml/remove_moderator') }}"
                                  method="POST"
                                  id="removemoderatorform{{ moderator }}"
                                  style="display: inline;">
                                {{ util.anti_csrf_token('ml/remove_moderator') }}
                                {{ util.input_hidden(name="moderator_id", value=moderator) }}
                                {{ util.input_submit(value='', aclass="btn btn-xs btn-danger", icon="minus",
                                        title=gettext("Remove %(given_names)s %(family_name)s as moderator")|format(
                                            given_names=persona['given_names'],
                                            family_name=persona['family_name'])) }}
                            </form>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="col-md-6">
            <h2>{% trans -%}Subscription Requests{%- endtrans %}</h2>
            {# TODO Restyle #}
            {% if requests|length > 0 %}
                <ul>
                    {% for request, persona in requests.items() %} {# This is already sorted. #}
                        <li>
                            {{ util.persona_anchor(persona, ml_id=ambience['mailinglist']['id']) }}
                            <span class="nowrap">
                                <form action="{{ cdedblink('ml/decide_request') }}"
                                      method="POST"
                                      id="acceptrequestform{{ request }}"
                                      style="display: inline;">
                                    {{ util.anti_csrf_token('ml/decide_request') }}
                                    {{ util.input_hidden(name="resolution", value=enums['SubscriptionRequestResolutions'].approved) }}
                                    {{ util.input_hidden(name="persona_id", value=request) }}
                                    {{ util.input_submit(value=gettext("Accept"), aclass="btn btn-xs btn-success") }}
                                </form>
                                <form action="{{ cdedblink('ml/decide_request') }}"
                                      method="POST"
                                      id="rejectrequestform{{ request }}"
                                      style="display: inline;">
                                    {{ util.anti_csrf_token('ml/decide_request') }}
                                    {{ util.input_hidden(name="ack", value=enums['SubscriptionRequestResolutions'].rejected) }}
                                    {{ util.input_hidden(name="persona_id", value=request) }}
                                    {{ util.input_submit(icon="trash", value=gettext("Reject"),
                                        aclass="btn btn-xs btn-warning") }}
                                </form>
                                <form action="{{ cdedblink('ml/decide_request') }}"
                                      method="POST"
                                      id="blockrequestform{{ request }}"
                                      style="display: inline;">
                                    {{ util.anti_csrf_token('ml/decide_request') }}
                                    {{ util.input_hidden(name="ack", value=enums['SubscriptionRequestResolutions'].blocked) }}
                                    {{ util.input_hidden(name="persona_id", value=request) }}
                                    {{ util.input_submit(icon="remove", value=gettext("Block"), aclass="btn btn-xs btn-danger") }}
                                </form>
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>{% trans -%}
                    There are currently no Subscription Requests pending.
                {%- endtrans %}</p>
            {% endif %}
        </div>
    </div>
    
    <h2>{% trans -%}Subscribers{%- endtrans %} [{{ subscribers|length }}]</h2>
    <form action="{{ cdedblink('ml/add_subscriber') }}" method="POST"
          id="addsubscriberform" class="p">
        {{ util.anti_csrf_token('ml/add_subscriber') }}
        <div class="input-group has-success">
            <span class="input-group-addon">{{ util.make_icon('plus') }}</span>
            {{ util.input_text(name="subscriber_id", placeholder="DB-XXXX-X", anid="input-add-subscriber",
                               arialabel=gettext("ID of the new Subscriber")) }}
            <script type="text/javascript" nonce="{{ csp_nonce }}">
                $('#input-add-subscriber').cdedbSearchPerson(
                    '{{ (cdedblink('core/select_persona')|e) + ('?kind=mod_ml_user&phrase=%s&aux='|s) +
                        (ambience['mailinglist']['id']|string|e) }}', {{ subscribers|list|json|s }},
                    false, false, '{{ gettext("CdEDB-ID, Name or E-Mail") }}'
                );
            </script>
            <div class="input-group-btn">
                {{ util.input_submit(value=gettext("Add Subscriber"), aclass="btn btn-success") }}
            </div>
        </div>
        {{ util.output_errors('subscriber_id', wrapper=True) }}
        {{- util.output_info(gettext("Users outside of the configured audience can only be added by entering their ID.")) }}
    </form>

    <div class="row">
        {% set col_width = 4 if subscribers|length > 10 else (6 if subscribers|length > 5 else 12) %}
        {% for list in subscribers | slice(3 if subscribers|length > 10 else (2 if subscribers|length > 5 else 1)) %}
            <div class="col-sm-{{ col_width }}">
                <ul class="nosp slim">
                    {% for subscriber in list %}
                        <li>
                            {{ util.persona_anchor(subscribers[subscriber], ml_id=ambience['mailinglist']['id']) }}
                            {% if subscriber in explicits %}({{ explicits[subscriber] }}){% endif %}
                            <form action="{{ cdedblink('ml/remove_subscriber') }}"
                                  method="POST"
                                  id="removesubscriberform{{ subscriber }}"
                                  style="display: inline;">
                                {{ util.anti_csrf_token('ml/remove_subscriber') }}
                                {{ util.input_hidden(name="subscriber_id", value=subscriber) }}
                                {{ util.input_submit(value="", icon="minus", aclass="btn btn-xs btn-danger",
                                        title=gettext("Remove %(given_names)s %(family_name)s as subscriber")|format(
                                            given_names=subscribers[subscriber]['given_names'],
                                            family_name=subscribers[subscriber]['family_name'])) }}
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    </div>

    {% if is_admin %}
        {% call util.bootstrap_panel(title=gettext("Actions"), icon="warning-sign", aclass="panel-danger mosp") %}
            <div class="row">
                <div class="col-sm-4">
                    <div class="p">
                        <form action="{{ cdedblink('ml/delete_mailinglist') }}" method="POST" id="deletemlform"
                                style="display: inline;">
                            {{ util.anti_csrf_token('ml/delete_mailinglist') }}
                            {{ util.input_submit(value=gettext("Delete"), readonly=is_locked,
                                                 aclass="btn btn-danger", icon="trash") }}
                            {{ util.input_checkbox(name="ack_delete", label=gettext("Are you sure?")) }}
                        </form>
                    </div>
                </div>
                <div class="col-sm-8">
                    <p class="text-muted">
                        {% trans -%}Deletes the mailinglist including description and all subscriber information.{%- endtrans %}
                    </p>
                </div>
            </div>
        {% endcall %}
        <script type="text/javascript" nonce="{{ csp_nonce }}">
            $('#deletemlform').cdedbProtectAction("{{ gettext("The mailinglist will be permanently deleted.") }}");
            $('#deletemlform').find('[name="ack_delete"]').prop('checked', true).parent().hide();
        </script>
    {% endif %}

{% endblock %}
