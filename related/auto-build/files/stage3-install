#!/bin/bash
set -e

BACKENDS="session core cde event"

echo ""
echo "cdedb - sandbox system: STAGE 3"
echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
echo ""
echo "Getting the system up to date..."
echo "--------------------------------------------"

cd /
sleep 3

aptitude -y update
aptitude -y safe-upgrade

echo ""
echo "Getting a copy of the cdedb sources..."
echo "--------------------------------------------"

mkdir /cdedb2
chown cdedb:cdedb /cdedb2
# the following is a bit hacky, but for the actual autobuild we have to try
# another location
sudo -u cdedb git clone ssh://gitolite@rcs.cde-ev.de:20008/cdedb2 /cdedb2 || sudo -u cdedb git clone ssh://gitolite@10.8.0.2:63332/cdedb2 /cdedb2
cd /cdedb2
chmod 600 /cdedb2/.ldap_rootpw
chmod +x /cdedb2/related/auto-build/files/stage3/make-pyro-nameserver.sh

echo ""
echo "Creating storage directory for uploads..."
echo "--------------------------------------------"

mkdir /var/lib/cdedb/
chown www-data:www-data /var/lib/cdedb

echo ""
echo "Initialize LDAP..."
echo "--------------------------------------------"

# first we undo the automatically generated debian stuff
ldapdelete -D 'cn=admin,dc=cdedb,dc=virtual' -w s1n2t3h4d5i6u7e8o9a0s1n2t3h4d5i6u7e8o9a0 'cn=admin,dc=cdedb,dc=virtual'
ldapdelete -D 'cn=admin,dc=cdedb,dc=virtual' -w s1n2t3h4d5i6u7e8o9a0s1n2t3h4d5i6u7e8o9a0 'dc=cdedb,dc=virtual'
# now we do our stuff
ldapmodify -Y EXTERNAL -H ldapi:/// -f /cdedb2/related/auto-build/files/stage3/init.ldif
TMPDIR=`mktemp -d`
slaptest -f /cdedb2/related/auto-build/files/stage3/temp_ldap.conf -F $TMPDIR
# stupid LDAP needs manual fixing
sed -n -i -e '/structuralObjectClass: olcSchemaConfig/q;p' "$TMPDIR/cn=config/cn=schema/cn="*"cdepersona.ldif"
sed -i -e 's/^dn: cn={[0-9]\+}cdepersona/dn: cn=cdepersona,cn=schema,cn=config/' "$TMPDIR/cn=config/cn=schema/cn="*"cdepersona.ldif"
sed -i -e 's/^cn: {[0-9]\+}cdepersona/cn: cdepersona/' "$TMPDIR/cn=config/cn=schema/cn="*"cdepersona.ldif"
ldapadd -Y EXTERNAL -H ldapi:/// -f "$TMPDIR/cn=config/cn=schema/cn="*"cdepersona.ldif"
rm -rf $TMPDIR
make ldap

echo ""
echo "Setting up the database..."
echo "--------------------------------------------"

cp /cdedb2/related/auto-build/files/stage3/pg_hba.conf /etc/postgresql/9.4/main/
/etc/init.d/postgresql restart
sleep 3

make sql

cp /cdedb2/related/auto-build/files/stage3/pgbouncer.ini /etc/pgbouncer/
cp /cdedb2/related/pgbouncer_users.txt /etc/pgbouncer/userlist.txt
chmod 640 /etc/pgbouncer/userlist.txt
chown postgres:postgres /etc/pgbouncer/userlist.txt

cp /cdedb2/related/auto-build/files/stage3/pgbouncer /etc/default/

echo ""
echo "Create local config files..."
echo "--------------------------------------------"

cp /cdedb2/related/auto-build/files/stage3/localconfig.py /cdedb2/cdedb/
chown cdedb:cdedb /cdedb2/cdedb/localconfig.py
chmod 644 /cdedb2/cdedb/localconfig.py
cp /cdedb2/related/auto-build/files/stage3/backendconfig.py /home/backend/
chown backend:backend /home/backend/backendconfig.py
chmod 600 /home/backend/backendconfig.py
cp /cdedb2/related/auto-build/files/stage3/frontendconfig.py /etc/cdedb-frontend-config.py
chown www-data:www-data /etc/cdedb-frontend-config.py
chmod 640 /etc/cdedb-frontend-config.py

echo ""
echo "Create central directory for log files..."
echo "--------------------------------------------"

mkdir -p /log
chown cdedb:cdedb /log
chmod 777 /log
# this needs to be writable by frontend _and_ backend
touch /log/cdedb.log
chmod 666 /log/cdedb.log

echo ""
echo "Let the cdedb run automagically..."
echo "--------------------------------------------"

cp /cdedb2/related/auto-build/files/stage3/cdedb-rundir /etc/init.d
chmod +x /etc/init.d/cdedb-rundir
update-rc.d cdedb-rundir defaults

cp /cdedb2/related/auto-build/files/stage3/pyro-nameserver /etc/init.d
chmod +x /etc/init.d/pyro-nameserver
update-rc.d pyro-nameserver defaults

cp /cdedb2/related/auto-build/files/stage3/runit /etc/init.d
chmod +x /etc/init.d/runit
update-rc.d runit defaults

for i in $BACKENDS; do
    mkdir -p /etc/sv/$i;
    cat >/etc/sv/$i/run <<EOF
#!/bin/bash
cd /cdedb2
CONFIGPATH=/home/backend/backendconfig.py
exec chpst -u backend:backend make run-$i
EOF
    chmod +x /etc/sv/$i/run;
    ln -s /etc/sv/$i /etc/service/$i;
done;

echo ""
echo "Set up the apache2..."
echo "--------------------------------------------"

for i in ssl wsgi; do
    a2enmod $i
done;

a2dissite 000-default

cp /cdedb2/related/auto-build/files/stage3/cdedb-site.conf /etc/apache2/sites-available
cp /cdedb2/related/auto-build/files/stage3/index.html /var/www/html/
chown www-data:www-data /var/www/html/index.html
a2ensite cdedb-site

echo "" > /etc/apache2/ports.conf

/etc/init.d/apache2 restart

echo ""
echo "Set up the fail2ban..."
echo "--------------------------------------------"

cp /cdedb2/related/auto-build/files/stage3/cdedb.conf /etc/fail2ban/filter.d/
cp /cdedb2/related/auto-build/files/stage3/jail.local /etc/fail2ban/

echo ""
echo "Disable auto-build init..."
echo "--------------------------------------------"

cat >/etc/rc.local <<EOF
#!/bin/bash
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.
exit 0
EOF

echo ""
echo "Shrink image size..."
echo "--------------------------------------------"

dd if=/dev/zero of=/tmp/ZERO || echo 'Error ignored'
sync
sleep 1
rm -f /tmp/ZERO

## Finally, use reboot (together with -no-reboot of qemu) to stop the machine
## with the finalised image

echo ""
echo ""
echo ""
echo "Done. Will reboot..."

( sleep 2; reboot ) &
