FROM debian:bullseye-20210816

RUN python3 ./ldap/create-ldap.py
    && python3 ./ldap/update-ldap.py

RUN cat ./ldap/output/slapd-debconf.txt | debconf-set-selections \
    \
    && apt-get update && apt-get install --yes --no-install-recommends \
    slapd \
    ldap-utils \
    unixodbc \
    odbc-postgresql

COPY ./related/docker/ldap-entrypoint.sh ./ldap/output/odbc.ini .ldap/output/config-ldap.ldif ./ldap/output/cdedb-ldap.ldif /app/

RUN mv /app/ldap-entrypoint.sh /ldap-entrypoint.sh \
    && mv /app/odbc.ini /etc/odbc.ini

# Set custom entrypoint to perform additional work on first run.
ENTRYPOINT ["/ldap-entrypoint.sh"]

# Start slapd in foreground/debug mode without debug messages (-d 0).
CMD ["slapd", "-d", "0"]
