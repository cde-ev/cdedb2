FROM debian:buster-20200607

RUN echo 'slapd slapd/password1 password s1n2t3h4d5i6u7e8o9a0s1n2t3h4d5i6u7e8o9a0' | debconf-set-selections \
    && echo 'slapd slapd/password2 password s1n2t3h4d5i6u7e8o9a0s1n2t3h4d5i6u7e8o9a0' | debconf-set-selections \
    \
    && apt-get update && apt-get install --yes --no-install-recommends \
    slapd \
    ldap-utils \
    unixodbc \
    odbc-postgresql

COPY ./related/auto-build/files/stage2/odbc.ini /etc/odbc.ini
COPY ./sql-ldap.ldif /tmp/sql-ldap.ldif

RUN sed -i "s/localhost/cdb/" /etc/odbc.ini \
    && \
    ldapmodify -Y EXTERNAL -H ldapi:/// -f /tmp/sql-ldap.ldif

CMD ["slapd"]
